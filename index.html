<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mapa de Clientes - Geolocaliza√ß√£o</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" >

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" >

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        .dark {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            /* Safe area for devices with notch */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Search Box */
        .search-container {
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
            font-size: 16px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 38px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .clear-search {
            position: absolute;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            display: none;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }

        .clear-search:hover {
            color: var(--text-primary);
        }

        .clear-search.visible {
            display: block;
        }

        .search-results-info {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .upload-section {
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .upload-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .upload-input {
            display: none;
        }

        .upload-status {
            margin-top: 8px;
            font-size: 12px;
            text-align: center;
            color: var(--text-secondary);
        }

        .upload-status.success {
            color: var(--success);
            font-weight: 600;
        }

        .clients-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .client-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .client-item:hover {
            border-color: var(--primary);
        }

        .client-item.hidden {
            display: none;
        }

        .client-item.highlight {
            border-color: var(--primary);
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%);
        }

        .highlight-text {
            background: rgba(37, 99, 235, 0.2);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }

        .client-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .client-address {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .client-coords {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 100vh;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            border: none;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            line-height: 1;
            transition: all 0.3s;
            z-index: 1000;
            -webkit-user-select: none;
            user-select: none;
        }

        .fab:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: none;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .menu-toggle:active {
            transform: translateX(-50%) scale(0.95);
        }

        .menu-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000; /* Maior que admin-panel (9999) */
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .camera-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .scan-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .scan-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .camera-preview {
            margin-top: 16px;
            display: none;
            position: relative;
            max-height: 400px;
            overflow: hidden;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-preview video,
        .camera-preview canvas {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        .camera-preview canvas {
            display: none;
        }

        .capture-btn {
            margin-top: 12px;
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .processing-text {
            font-size: 18px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .coords-display {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Leaflet Custom Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        /* Leaflet Routing Machine Customization */
        .leaflet-routing-container {
            display: none !important; /* Ocultar banner de navega√ß√£o */
        }

        .leaflet-routing-container h2,
        .leaflet-routing-container h3 {
            color: var(--text-primary);
        }

        .leaflet-routing-alt {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .leaflet-routing-alt:hover {
            background: var(--bg-primary);
        }

        .leaflet-routing-alt-minimized {
            background: var(--primary);
            color: white;
            border-radius: 8px;
        }

        .leaflet-routing-icon {
            color: var(--text-primary);
        }

        .leaflet-routing-geocoders {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
        }

        .leaflet-routing-geocoder input {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
        }

        .popup-navigate-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .popup-navigate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Navigation Panel - Real-time GPS */
        .navigation-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 1500;
            min-width: 300px;
            display: none;
            animation: slideInRight 0.3s;
        }

        .navigation-panel.active {
            display: block;
        }

        .navigation-panel.collapsed .nav-stats {
            display: none;
        }

        .navigation-panel.collapsed .nav-status {
            display: none;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .navigation-panel.collapsed .nav-header {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .nav-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .nav-buttons {
            display: flex;
            gap: 6px;
        }

        .nav-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-toggle-btn:hover {
            background: var(--primary-hover);
        }

        .nav-close-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-close-btn:hover {
            background: var(--danger-hover);
        }

        .nav-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .nav-stat {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .nav-stat-label {
            color: var(--text-secondary);
        }

        .nav-stat-value {
            font-weight: 600;
            color: var(--primary);
        }

        .nav-status {
            text-align: center;
            padding: 8px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .nav-status.calculating {
            background: #f59e0b;
        }

        .popup-content {
            min-width: 200px;
        }

        .popup-content h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .popup-content p {
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-buttons {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .popup-route-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .popup-route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .popup-actions {
            display: flex;
            gap: 8px;
        }

        .popup-edit-btn,
        .popup-delete-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .popup-edit-btn {
            background: var(--primary);
            color: white;
        }

        .popup-edit-btn:hover {
            background: var(--primary-hover);
        }

        .popup-delete-btn {
            background: var(--danger);
            color: white;
        }

        .popup-delete-btn:hover {
            background: var(--danger-hover);
        }

        /* Loading Indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 3000;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        /* Responsive */
        /* ========== MOBILE OPTIMIZATION ========== */
        @media (max-width: 768px) {
            /* Sidebar Mobile */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 85vw;
                max-width: 350px;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                z-index: 2000;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: flex;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1500;
                background: var(--bg-primary);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                min-width: 48px;
                min-height: 48px;
            }

            /* FAB Mobile - Bot√£o de Adicionar Cliente */
            .fab {
                /* Posi√ß√£o mais alta para garantir visibilidade */
                bottom: 80px !important;
                width: 64px;
                height: 64px;
                font-size: 32px;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
                z-index: 1400;
                /* Garante visibilidade total */
                margin-bottom: 0;
                pointer-events: auto;
                position: fixed;
                left: 50%;
                transform: translateX(-50%);
            }

            /* Garantir que FAB n√£o seja cortado no active */
            .fab:active {
                transform: translateX(-50%) scale(0.92) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            /* Impede hover em mobile para melhor performance */
            .fab:hover {
                transform: translateX(-50%) !important;
            }

            /* Toast Mobile */
            .toast {
                left: 15px;
                right: 15px;
                min-width: auto;
                max-width: calc(100vw - 30px);
                font-size: 14px;
                padding: 12px 16px;
            }

            /* Camera Preview - Mobile */
            .camera-preview {
                max-height: 250px;
            }

            .camera-preview video,
            .camera-preview canvas {
                max-height: 250px;
            }

            /* Modal Mobile */
            .modal {
                max-height: 90vh;
                overflow-y: auto;
                margin: 15px;
                max-width: calc(100vw - 30px);
                border-radius: 12px;
            }

            .modal-body {
                max-height: 65vh;
                overflow-y: auto;
                padding: 16px;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-header h2 {
                font-size: 20px;
            }

            .modal-footer {
                padding: 12px 16px;
                gap: 8px;
            }

            /* Forms Mobile */
            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px !important; /* Previne zoom no iOS */
                padding: 12px;
                min-height: 48px; /* Touch target m√≠nimo */
            }

            /* Buttons Mobile */
            .btn {
                min-height: 48px;
                padding: 12px 20px;
                font-size: 16px;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger {
                font-size: 15px;
                padding: 12px 18px;
            }

            /* Upload Section Mobile */
            .upload-section {
                padding: 12px;
            }

            .upload-btn {
                min-height: 48px;
                font-size: 15px;
                padding: 12px;
            }

            /* Search Mobile */
            .search-container {
                padding: 12px;
            }

            .search-input {
                font-size: 16px !important;
                min-height: 48px;
                padding: 12px 40px 12px 38px;
            }

            /* Client List Mobile */
            .clients-list {
                padding: 8px;
            }

            .client-item {
                padding: 14px 12px;
                margin-bottom: 10px;
                border-radius: 10px;
                min-height: 60px;
                tap-highlight-color: transparent;
                -webkit-tap-highlight-color: transparent;
            }

            .client-item:active {
                transform: scale(0.98);
            }

            .client-name {
                font-size: 15px;
                margin-bottom: 6px;
            }

            .client-address {
                font-size: 13px;
                line-height: 1.4;
            }

            /* Admin Panel Mobile */
            .admin-panel {
                width: 100vw;
                max-width: 100vw;
                left: 0;
                right: 0;
                border-radius: 0;
                z-index: 10000;
            }

            .admin-header {
                padding: 14px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .admin-header h1 {
                font-size: 20px;
                width: 100%;
                margin-bottom: 4px;
            }

            .admin-header-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .admin-header-actions .btn,
            .admin-header-actions .logout-btn {
                flex: 1;
                min-width: calc(50% - 4px);
                justify-content: center;
            }

            .admin-content {
                padding: 12px;
            }

            .user-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 14px 12px;
                margin-bottom: 12px;
                gap: 12px;
            }

            .user-info {
                width: 100%;
            }

            .user-info h3 {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .user-info p {
                font-size: 13px;
                line-height: 1.4;
            }

            .user-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }

            .user-actions .btn {
                flex: 1;
                min-width: calc(50% - 4px);
                justify-content: center;
                font-size: 13px;
                padding: 10px 12px;
            }

            .admin-section {
                padding: 14px 12px;
                margin-bottom: 12px;
            }

            .admin-section h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            /* Bot√£o de voltar do admin */
            #closeAdminBtn {
                min-height: 40px;
                padding: 10px 16px;
                font-size: 14px;
                white-space: nowrap;
            }

            /* Bot√£o adicionar usu√°rio */
            #addUserBtn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 14px;
            }

            /* Login Mobile */
            .login-box {
                padding: 30px 24px;
                width: 92%;
                max-width: 400px;
            }

            .login-header h1 {
                font-size: 24px;
            }

            .login-header p {
                font-size: 14px;
            }

            /* Map Controls Mobile */
            .leaflet-top,
            .leaflet-bottom {
                z-index: 400;
            }

            .leaflet-control-zoom {
                margin-top: 70px !important;
            }

            .leaflet-control-zoom a {
                width: 40px !important;
                height: 40px !important;
                line-height: 40px !important;
                font-size: 22px !important;
            }

            /* QR Code Button Mobile */
            #qrBtn {
                min-width: 48px;
                min-height: 48px;
                padding: 12px;
                border-radius: 10px;
            }

            /* Navigation Controls Mobile */
            .nav-close-btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 15px;
            }

            /* Reduce animations on mobile for performance */
            * {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }

            /* Disable hover effects on touch devices */
            .client-item:hover,
            .btn:hover,
            .upload-btn:hover {
                transform: none;
            }

            /* Improve scrolling performance */
            .clients-list,
            .modal-body,
            .admin-content {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
        }

        /* Small Mobile Devices (< 375px) */
        @media (max-width: 375px) {
            .sidebar {
                width: 90vw;
            }

            .modal {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }

            .login-box {
                padding: 24px 18px;
            }

            .btn {
                font-size: 14px;
                padding: 11px 16px;
            }

            /* Admin Panel - Small Mobile */
            .admin-header h1 {
                font-size: 18px;
            }

            .user-card {
                padding: 12px 10px;
            }

            .user-info h3 {
                font-size: 15px;
            }

            .user-actions .btn {
                font-size: 12px;
                padding: 8px 10px;
            }

            #closeAdminBtn,
            #addUserBtn {
                font-size: 13px;
                padding: 8px 14px;
            }

            /* FAB em telas muito pequenas */
            .fab {
                width: 60px;
                height: 60px;
                font-size: 28px;
                bottom: 70px !important;
            }
        }

        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal {
                max-height: 85vh;
            }

            .modal-body {
                max-height: 55vh;
            }

            .sidebar {
                width: 60vw;
                max-width: 400px;
            }

            .fab {
                bottom: 80px !important;
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Performance Optimizations */
        .sidebar,
        .modal-overlay,
        .admin-panel,
        .menu-toggle,
        .fab {
            will-change: transform;
        }

        /* Prevent text selection on touch */
        .btn,
        .client-item,
        .menu-toggle,
        .fab {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Better tap highlighting */
        a, button, .client-item {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.05);
            tap-highlight-color: rgba(0, 0, 0, 0.05);
        }

        /* Login Screen */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            color: var(--text-primary);
            margin: 0 0 8px 0;
            font-size: 28px;
        }

        .login-header p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .register-btn {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .register-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-secondary);
            z-index: 9999;
            overflow-y: auto;
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .admin-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 24px;
        }

        .admin-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .user-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
        }

        .user-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--danger-hover);
        }

        .admin-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }

        .user-header-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--bg-primary);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 1500;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            transition: opacity 0.3s ease;
        }

        .user-header-info span {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        /* Mobile User Header */
        @media (max-width: 768px) {
            .login-box {
                padding: 30px 20px;
            }

            .user-header-info {
                top: 15px;
                right: 15px;
                left: auto;
                bottom: auto;
                padding: 10px 12px;
                gap: 8px;
                max-width: calc(100vw - 80px);
                border-radius: 10px;
            }

            .user-header-info span {
                font-size: 13px;
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .admin-btn {
                font-size: 13px !important;
                padding: 8px 12px !important;
                margin-right: 0 !important;
                min-width: 70px;
                white-space: nowrap;
            }

            .logout-btn {
                font-size: 13px !important;
                padding: 8px 12px !important;
                min-width: 55px;
                white-space: nowrap;
            }
        }

        /* Small Mobile - Stack vertically if needed */
        @media (max-width: 375px) {
            .user-header-info {
                flex-direction: column;
                align-items: flex-end;
                gap: 6px;
                padding: 8px 10px;
                max-width: calc(100vw - 80px);
            }

            .user-header-info span {
                font-size: 12px;
                max-width: 120px;
            }

            .admin-btn,
            .logout-btn {
                font-size: 12px !important;
                padding: 6px 10px !important;
                width: 100%;
                min-width: auto;
            }
        }

        /* Melhorias de qualidade para mapa em mobile */
        .mobile-tiles-hq img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }

        /* Melhorar renderiza√ß√£o do Leaflet em telas de alta DPI */
        .leaflet-container {
            image-rendering: -webkit-optimize-contrast;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Tiles de alta qualidade com textos maiores */
        .leaflet-tile-container {
            transform: scale(1.3);
            transform-origin: 0 0;
        }

        .leaflet-tile-container img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* Melhorar renderiza√ß√£o de texto nos popups mobile */
        .leaflet-popup-content {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Otimizar renderiza√ß√£o dos marcadores */
        .numbered-marker {
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Controles do Mapa (estilo Amazon Flex) */
        .map-controls {
            position: absolute;
            top: 80px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .map-control-btn {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            transition: all 0.2s;
            min-width: 50px;
        }

        .map-control-btn:hover {
            background: #f3f4f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .map-control-btn:active {
            transform: scale(0.95);
        }

        .map-control-btn svg {
            width: 24px;
            height: 24px;
            color: #2563eb;
        }

        #mapTypeLabel {
            white-space: nowrap;
        }

        /* Contador de Entregas */
        .delivery-counter {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 140px;
        }

        .counter-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .counter-value {
            font-size: 24px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }

        .counter-progress {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .map-controls {
                top: 70px;
                right: 12px;
                gap: 10px;
            }

            .map-control-btn {
                padding: 10px;
                border-radius: 6px;
            }

            .map-control-btn svg {
                width: 20px;
                height: 20px;
            }

            #mapTypeLabel {
                font-size: 12px;
            }

            .delivery-counter {
                padding: 12px;
                min-width: 120px;
            }

            .counter-label {
                font-size: 10px;
            }

            .counter-value {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <h1>üó∫Ô∏è Sistema GPS</h1>
                <p>Fa√ßa login para acessar o sistema</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Usu√°rio</label>
                    <input type="text" id="loginUsername" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" id="loginBtn">Entrar</button>
            </form>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">N√£o tem uma conta?</p>
                <button type="button" class="register-btn" id="showRegisterBtn">üìù Cadastrar como Entregador</button>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div class="login-container hidden" id="registerContainer">
        <div class="login-box">
            <div class="login-header">
                <h1>üìù Cadastro de Entregador</h1>
                <p>Preencha os dados para criar sua conta</p>
            </div>
            <form class="login-form" id="registerForm">
                <div class="form-group">
                    <label for="registerName">Nome Completo *</label>
                    <input type="text" id="registerName" required placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label for="registerUsername">Usu√°rio *</label>
                    <input type="text" id="registerUsername" required placeholder="Escolha um nome de usu√°rio" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Senha *</label>
                    <input type="password" id="registerPassword" required placeholder="Escolha uma senha" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">Confirmar Senha *</label>
                    <input type="password" id="registerPasswordConfirm" required placeholder="Digite a senha novamente" autocomplete="new-password">
                </div>
                <button type="submit" class="login-btn" id="registerBtn">Criar Conta</button>
            </form>
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">J√° tem uma conta?</p>
                <button type="button" class="register-btn" id="showLoginBtn">üîë Fazer Login</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h1>üë• Gerenciar Usu√°rios</h1>
            <div class="admin-header-actions">
                <button class="btn btn-primary" id="addUserBtn">‚ûï Novo Usu√°rio</button>
                <button class="logout-btn" id="closeAdminBtn">Voltar</button>
            </div>
        </div>
        <div class="admin-content">
            <div id="usersList"></div>
        </div>
    </div>

    <!-- User Info Header -->
    <div class="user-header-info" id="userHeaderInfo" style="display: none;">
        <span id="currentUsername">Usu√°rio</span>
        <button class="admin-btn" id="openAdminBtn" style="display: none;">üë• Admin</button>
        <button class="logout-btn" id="logoutBtn">Sair</button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Obtendo sua localiza√ß√£o...</p>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üìç Meus Clientes</h1>
                <p id="clientCount">0 clientes cadastrados</p>
            </div>

            <!-- Upload Planilha -->
            <div class="upload-section">
                <button class="upload-btn" id="uploadBtn" title="Upload planilha Excel com c√≥digos BR e endere√ßos">
                    üìä Carregar Planilha Excel
                </button>
                <input type="file" id="uploadInput" class="upload-input" accept=".xlsx,.xls,.csv">
                <div class="upload-status" id="uploadStatus"></div>

                <button class="upload-btn" id="optimizeRouteBtn" style="margin-top: 8px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); display: none;" title="Roteirizar endere√ßos da planilha com IA">
                    ü§ñ Roteirizar com IA
                </button>
                <div class="upload-status" id="routeStatus"></div>
            </div>

            <!-- Search Box -->
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Buscar por nome ou endere√ßo..."
                        autocomplete="off"
                    >
                    <button class="clear-search" id="clearSearch" title="Limpar busca">√ó</button>
                </div>
                <div class="search-results-info" id="searchResultsInfo"></div>
            </div>

            <div class="clients-list" id="clientsList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                    </svg>
                    <p>Nenhum cliente cadastrado ainda</p>
                    <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Controles do Mapa (estilo Amazon Flex) -->
        <div class="map-controls">
            <!-- Bot√£o Alternar Mapa/Sat√©lite -->
            <button class="map-control-btn" id="toggleMapTypeBtn" title="Alternar Mapa/Sat√©lite" onclick="toggleMapType()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18.5C7.61 19.4 5 15.27 5 11V8.3l7-3.12 7 3.12V11c0 4.27-2.61 8.4-7 9.5z"/>
                </svg>
                <span id="mapTypeLabel">Sat√©lite</span>
            </button>

            <!-- Bot√£o Recentralizar GPS -->
            <button class="map-control-btn" id="recenterBtn" title="Recentralizar no GPS" onclick="recenterMap()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                </svg>
            </button>

            <!-- Contador de Entregas -->
            <div class="delivery-counter" id="deliveryCounter" style="display: none;">
                <div class="counter-label">Entregas</div>
                <div class="counter-value">
                    <span id="deliveredCount">0</span> / <span id="totalCount">0</span>
                </div>
                <div class="counter-progress">
                    <div class="progress-bar" id="deliveryProgress"></div>
                </div>
            </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Floating Action Button -->
        <button class="fab" id="addClientBtn" title="Adicionar cliente aqui">+</button>

        <!-- Navigation Panel - Real-time GPS -->
        <div class="navigation-panel collapsed" id="navigationPanel">
            <div class="nav-header">
                <div class="nav-title">üß≠ Navega√ß√£o Ativa</div>
                <div class="nav-buttons">
                    <button class="nav-toggle-btn" id="navToggleBtn" onclick="toggleNavigationPanel()">Ver</button>
                    <button class="nav-close-btn" onclick="stopRealtimeNavigation()">Parar</button>
                </div>
            </div>
            <div class="nav-stats">
                <div class="nav-stat">
                    <span class="nav-stat-label">Destino:</span>
                    <span class="nav-stat-value" id="navDestination">-</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Dist√¢ncia:</span>
                    <span class="nav-stat-value" id="navDistance">-</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Tempo:</span>
                    <span class="nav-stat-value" id="navTime">-</span>
                </div>
            </div>
            <div class="nav-status" id="navStatus">üöó Navegando...</div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="addClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Cliente</h2>
            </div>
            <div class="modal-body">
                <!-- QR Code Scanner Section -->
                <div class="camera-section">
                    <button type="button" class="scan-btn" id="scanBtn">
                        üì∑ Escanear QR Code
                    </button>
                    <div class="camera-preview" id="cameraPreview">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas"></canvas>
                    </div>
                </div>

                <form id="clientForm">
                    <div class="form-group">
                        <label for="clientName">Nome do Cliente *</label>
                        <input type="text" id="clientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Endere√ßo *</label>
                        <textarea id="clientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Telefone</label>
                        <input type="tel" id="clientPhone" placeholder="(99) 99942-1942" maxlength="15">
                    </div>
                    <div class="form-group">
                        <label for="clientBR">BR</label>
                        <input type="text" id="clientBR" placeholder="Informa√ß√£o do QR Code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="submit" form="clientForm" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-spinner"></div>
        <div class="processing-text">Lendo QR Code...</div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="editClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Editar Cliente</h2>
            </div>
            <div class="modal-body">
                <form id="editClientForm">
                    <div class="form-group">
                        <label for="editClientName">Nome do Cliente *</label>
                        <input type="text" id="editClientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="editClientAddress">Endere√ßo *</label>
                        <textarea id="editClientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editClientPhone">Telefone</label>
                        <input type="tel" id="editClientPhone" placeholder="(99) 99942-1942" maxlength="15">
                    </div>
                    <div class="form-group">
                        <label for="editClientBR">BR</label>
                        <input type="text" id="editClientBR" placeholder="Informa√ß√£o do QR Code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="editCancelBtn">Cancelar</button>
                <button type="submit" form="editClientForm" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Usu√°rio</h2>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="newUserName">Nome Completo *</label>
                        <input type="text" id="newUserName" required placeholder="Digite o nome completo">
                    </div>
                    <div class="form-group">
                        <label for="newUsername">Nome de Usu√°rio *</label>
                        <input type="text" id="newUsername" required placeholder="Digite o nome de usu√°rio">
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Senha *</label>
                        <input type="password" id="newUserPassword" required placeholder="Digite a senha">
                    </div>
                    <div class="form-group">
                        <label for="newUserRole">Tipo de Usu√°rio</label>
                        <select id="newUserRole" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="user">Usu√°rio</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelUserBtn">Cancelar</button>
                <button type="submit" form="userForm" class="btn btn-primary">Criar Usu√°rio</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Editar Usu√°rio</h2>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label for="editUserName">Nome Completo *</label>
                        <input type="text" id="editUserName" required placeholder="Digite o nome completo">
                    </div>
                    <div class="form-group">
                        <label for="editUsername">Nome de Usu√°rio *</label>
                        <input type="text" id="editUsername" required placeholder="Digite o nome de usu√°rio">
                    </div>
                    <div class="form-group">
                        <label for="editUserPassword">Nova Senha (deixe em branco para n√£o alterar)</label>
                        <input type="password" id="editUserPassword" placeholder="Digite a nova senha">
                    </div>
                    <div class="form-group">
                        <label for="editUserRole">Tipo de Usu√°rio</label>
                        <select id="editUserRole" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="user">Usu√°rio</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditUserBtn">Cancelar</button>
                <button type="submit" form="editUserForm" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirmar a√ß√£o</h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: var(--text-primary); font-size: 15px; line-height: 1.6;"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="confirmCancelBtn">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmOkBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- jsQR (QR Code Scanner) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <!-- SheetJS (Excel Reader) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Toast Notification System
        function showToast(message, type = 'info', title = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                success: '‚úì'
            };

            const titles = {
                error: title || 'Erro',
                warning: title || 'Aviso',
                info: title || 'Informa√ß√£o',
                success: title || 'Sucesso'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 4000);
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Supabase Configuration
        // IMPORTANTE: Substitua estas vari√°veis pelas suas credenciais do Supabase
        const SUPABASE_URL = 'https://pnecrzwlyxjirdjfiman.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBuZWNyendseXhqaXJkamZpbWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTQ2NzksImV4cCI6MjA3OTg3MDY3OX0.2REOdgPBvGBZUrLT_ggUU6HqbunamouGaihjibH1jhs';

        // Inicializar Supabase (ser√° null se n√£o configurado)
        let supabase = null;
        try {
            if (SUPABASE_URL.includes('seu-projeto') || SUPABASE_ANON_KEY.includes('sua-chave')) {
                console.warn('‚ö†Ô∏è Supabase n√£o configurado. Usando armazenamento local.');
            } else {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase conectado com sucesso!');
            }
        } catch (error) {
            console.error('Erro ao conectar com Supabase:', error);
        }

        // ========== FUN√á√ÉO DE CONFIRMA√á√ÉO CUSTOMIZADA ==========

        // Substituir confirm() nativo por modal customizado
        function customConfirm(message, title = 'Confirmar a√ß√£o') {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('confirmModal');
                const confirmTitle = document.getElementById('confirmTitle');
                const confirmMessage = document.getElementById('confirmMessage');
                const confirmOkBtn = document.getElementById('confirmOkBtn');
                const confirmCancelBtn = document.getElementById('confirmCancelBtn');

                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmModal.classList.add('active');

                const handleOk = () => {
                    confirmModal.classList.remove('active');
                    confirmOkBtn.removeEventListener('click', handleOk);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    confirmModal.removeEventListener('click', handleOutsideClick);
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmModal.classList.remove('active');
                    confirmOkBtn.removeEventListener('click', handleOk);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                    confirmModal.removeEventListener('click', handleOutsideClick);
                    resolve(false);
                };

                const handleOutsideClick = (e) => {
                    if (e.target === confirmModal) {
                        handleCancel();
                    }
                };

                confirmOkBtn.addEventListener('click', handleOk);
                confirmCancelBtn.addEventListener('click', handleCancel);
                confirmModal.addEventListener('click', handleOutsideClick);
            });
        }

        // Application State
        const state = {
            map: null,
            currentLocation: null,
            currentLocationMarker: null,
            clients: [],
            clientMarkers: [],
            nextId: 1,
            searchQuery: '',
            editingClientId: null,
            useSupabase: supabase !== null,
            brDatabase: {}, // Armazena mapeamento BR -> Endere√ßo
            routingControl: null, // Controle de navega√ß√£o
            navigationActive: false, // Navega√ß√£o GPS em tempo real ativa
            navigationWatchId: null, // ID do watchPosition
            navigationDestination: null, // Destino da navega√ß√£o
            currentRoute: null, // Rota atual
            viewingOptimizedRoute: false, // Flag para indicar que est√° visualizando rota otimizada
            currentUser: null, // Usu√°rio logado
            editingUserId: null, // ID do usu√°rio sendo editado
            syncPollingInterval: null, // Interval para sincroniza√ß√£o autom√°tica (polling)
            deliveredStops: new Set(), // Set de √≠ndices das paradas entregues
            optimizedOrder: null, // Ordem otimizada atual das paradas
            mapLayers: null, // Layers do mapa (streets, satellite, hybrid)
            currentMapLayer: 'streets' // Layer atual do mapa
        };

        // ========== SISTEMA DE AUTENTICA√á√ÉO ==========

        // Verificar sess√£o ao carregar
        async function checkSession() {
            // eslint-disable-next-line no-restricted-globals
            const sessionUser = localStorage.getItem('gps_user');
            if (sessionUser) {
                try {
                    state.currentUser = JSON.parse(sessionUser);
                    await showApp();
                    return true;
                } catch (error) {
                    console.error('Erro ao recuperar sess√£o:', error);
                    // eslint-disable-next-line no-restricted-globals
                    localStorage.removeItem('gps_user');
                }
            }
            return false;
        }

        // Login
        async function login(username, password) {
            if (!state.useSupabase) {
                showToast('Erro: Supabase n√£o configurado', 'error');
                return false;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (error || !data) {
                    showToast('Usu√°rio ou senha incorretos', 'error');
                    return false;
                }

                // Verificar senha (em produ√ß√£o, use hash como bcrypt)
                if (data.password !== password) {
                    showToast('Usu√°rio ou senha incorretos', 'error');
                    return false;
                }

                // Salvar sess√£o
                state.currentUser = {
                    id: data.id,
                    username: data.username,
                    role: data.role || 'user'
                };

                // eslint-disable-next-line no-restricted-globals
                localStorage.setItem('gps_user', JSON.stringify(state.currentUser));

                await showApp();
                return true;

            } catch (error) {
                console.error('Erro no login:', error);
                showToast('Erro ao fazer login', 'error');
                return false;
            }
        }

        // Logout
        function logout() {
            console.log('üëã Fazendo logout...');

            state.currentUser = null;
            // eslint-disable-next-line no-restricted-globals
            localStorage.removeItem('gps_user');

            // CR√çTICO: Limpar TODOS os dados
            state.clients = [];
            state.routeData = [];
            state.brDatabase = {};
            state.uploadSessionId = null; // Invalidar sess√£o de upload
            state.deliveredStops.clear(); // Limpar status de entrega

            // Cancelar sincroniza√ß√£o autom√°tica
            if (state.syncPollingInterval) {
                clearInterval(state.syncPollingInterval);
                state.syncPollingInterval = null;
                console.log('üîï Sincroniza√ß√£o autom√°tica desativada');
            }

            // Limpar marcadores do mapa
            if (state.clientMarkers && state.clientMarkers.length > 0) {
                state.clientMarkers.forEach(m => {
                    if (state.map && m.marker) {
                        state.map.removeLayer(m.marker);
                    }
                });
                state.clientMarkers = [];
            }

            // Limpar polylines de rota
            if (state.routePolyline && state.map) {
                state.map.removeLayer(state.routePolyline);
                state.routePolyline = null;
            }

            // Limpar lista visual de clientes
            const clientList = document.getElementById('clientsList');
            if (clientList) {
                clientList.innerHTML = '';
            }

            // Atualizar contador
            const countElement = document.getElementById('clientCount');
            if (countElement) {
                countElement.textContent = '0 clientes cadastrados';
            }

            // Limpar mensagens de status de upload
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                uploadStatus.textContent = '';
                uploadStatus.className = 'upload-status';
            }

            // Esconder app e mostrar login
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('userHeaderInfo').style.display = 'none';
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('adminPanel').classList.remove('active');

            // Resetar formul√°rio e bot√£o de login
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            if (loginForm) loginForm.reset();
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }

            console.log('‚úÖ Logout conclu√≠do. Todos os dados limpos.');
        }

        // Mostrar aplica√ß√£o ap√≥s login
        async function showApp() {
            console.log(`üîê Iniciando sess√£o para usu√°rio: ${state.currentUser.username} (ID: ${state.currentUser.id})`);

            // CR√çTICO: Limpar TODOS os dados do usu√°rio anterior antes de carregar novos dados
            console.log('üßπ Limpando dados da sess√£o anterior...');

            // Limpar clientes do estado
            state.clients = [];
            state.routeData = [];
            state.uploadSessionId = null;

            // Limpar todos os marcadores do mapa
            if (state.clientMarkers && state.clientMarkers.length > 0) {
                state.clientMarkers.forEach(m => {
                    if (state.map && m.marker) {
                        state.map.removeLayer(m.marker);
                    }
                });
                state.clientMarkers = [];
            }

            // Limpar polylines de rota
            if (state.routePolyline && state.map) {
                state.map.removeLayer(state.routePolyline);
                state.routePolyline = null;
            }

            // Limpar lista visual de clientes
            const clientList = document.getElementById('clientsList');
            if (clientList) {
                clientList.innerHTML = '';
            }

            // Atualizar contador
            const countElement = document.getElementById('clientCount');
            if (countElement) {
                countElement.textContent = '0 clientes cadastrados';
            }

            // Limpar mensagens de status de uploads anteriores
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                uploadStatus.textContent = '';
                uploadStatus.className = 'upload-status';
            }

            console.log('‚úÖ Dados limpos. Carregando dados do usu√°rio atual...');

            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('appContainer').style.display = 'flex'; // CR√çTICO: usar flex para layout correto
            document.getElementById('userHeaderInfo').style.display = 'flex';
            document.getElementById('currentUsername').textContent = state.currentUser.username;

            // Mostrar bot√£o admin apenas para administradores
            if (state.currentUser.role === 'admin') {
                document.getElementById('openAdminBtn').style.display = 'block';
            } else {
                document.getElementById('openAdminBtn').style.display = 'none';
            }

            // Inicializar mapa se ainda n√£o foi inicializado
            if (!state.map) {
                console.log('üó∫Ô∏è Inicializando mapa ap√≥s login...');
                getCurrentLocation();
            } else {
                // Mapa j√° existe, corrigir tamanho ap√≥s mostrar container
                hideLoading();

                // CR√çTICO: Aguardar renderiza√ß√£o do DOM antes de invalidar tamanho
                setTimeout(() => {
                    if (state.map) {
                        state.map.invalidateSize();
                        console.log('üó∫Ô∏è Tamanho do mapa corrigido');
                    }
                }, 100);

                // Carregar dados APENAS deste usu√°rio
                await loadClientsFromSupabase();
                await loadBRDatabaseFromSupabase();
                await loadRouteDataFromSupabase();

                // Configurar sincroniza√ß√£o em tempo real
                setupRealtimeSubscription();
            }

            console.log(`‚úÖ Sess√£o iniciada com sucesso para ${state.currentUser.username}`);
        }

        // ========== GERENCIAMENTO DE USU√ÅRIOS (ADMIN) ==========

        // Listar usu√°rios
        async function loadUsers() {
            if (!state.useSupabase || state.currentUser.role !== 'admin') return;

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const usersList = document.getElementById('usersList');
                if (!data || data.length === 0) {
                    usersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); margin-top: 40px;">Nenhum usu√°rio cadastrado</p>';
                    return;
                }

                usersList.innerHTML = data.map(user => `
                    <div class="user-card">
                        <div class="user-info">
                            <h3>
                                ${user.name || user.username}
                                ${user.role === 'admin' ? '<span class="user-badge">ADMIN</span>' : ''}
                            </h3>
                            <p>Usu√°rio: ${user.username} ‚Ä¢ ID: ${user.id} ‚Ä¢ Criado em ${new Date(user.created_at).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-secondary" onclick="editUser(${user.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showToast('Erro ao carregar usu√°rios', 'error');
            }
        }

        // Auto-registro (sem necessidade de admin)
        async function registerUser(name, username, password) {
            if (!state.useSupabase) {
                showToast('Erro: Supabase n√£o configurado', 'error');
                return false;
            }

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        username,
                        password,
                        role: 'user',
                        name: name  // Salvar nome completo
                    }])
                    .select();

                if (error) throw error;

                return true;

            } catch (error) {
                console.error('Erro ao criar conta:', error);

                if (error.code === '23505') {
                    showToast('Erro: J√° existe um usu√°rio com esse nome. Escolha outro.', 'error');
                } else if (error.message && error.message.includes('column "name"')) {
                    showToast('Erro: Execute o SQL para adicionar a coluna "name" na tabela users.', 'error');
                } else {
                    showToast('Erro ao criar conta. Tente novamente.', 'error');
                }
                return false;
            }
        }

        // Criar usu√°rio (admin)
        async function createUser(name, username, password, role) {
            if (!state.useSupabase || state.currentUser.role !== 'admin') return;

            try {
                const { data, error } = await supabase
                    .from('users')
                    .insert([{ name, username, password, role }])
                    .select();

                if (error) throw error;

                showToast(`Usu√°rio "${username}" criado com sucesso!`, 'success');
                await loadUsers();
                return true;

            } catch (error) {
                console.error('Erro ao criar usu√°rio:', error);

                if (error.code === '23505') {
                    showToast('Erro: J√° existe um usu√°rio com esse nome', 'error');
                } else {
                    showToast('Erro ao criar usu√°rio', 'error');
                }
                return false;
            }
        }

        // Editar usu√°rio
        window.editUser = async function(userId) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                state.editingUserId = userId;
                document.getElementById('editUserName').value = data.name || '';
                document.getElementById('editUsername').value = data.username;
                document.getElementById('editUserPassword').value = '';
                document.getElementById('editUserRole').value = data.role || 'user';
                document.getElementById('editUserModal').classList.add('active');

            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                showToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        };

        // Atualizar usu√°rio
        async function updateUser(userId, name, username, password, role) {
            if (!state.useSupabase || state.currentUser.role !== 'admin') return;

            try {
                const updateData = { name, username, role };
                if (password) {
                    updateData.password = password;
                }

                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', userId);

                if (error) throw error;

                showToast('Usu√°rio atualizado com sucesso!', 'success');
                await loadUsers();
                return true;

            } catch (error) {
                console.error('Erro ao atualizar usu√°rio:', error);
                showToast('Erro ao atualizar usu√°rio', 'error');
                return false;
            }
        }

        // Deletar usu√°rio
        window.deleteUser = async function(userId, username) {
            if (!state.useSupabase || state.currentUser.role !== 'admin') return;

            // Impedir que o admin exclua a si mesmo
            if (userId === state.currentUser.id) {
                showToast('Voc√™ n√£o pode excluir seu pr√≥prio usu√°rio!', 'error');
                return;
            }

            const confirmed = await customConfirm(
                `Tem certeza que deseja excluir o usu√°rio "${username}"?\n\nTODOS os dados ser√£o exclu√≠dos:\n- Endere√ßos cadastrados\n- Planilhas carregadas\n- Todas as configura√ß√µes\n\nEsta a√ß√£o n√£o pode ser desfeita!`,
                'Excluir Usu√°rio e Todos os Dados'
            );

            if (!confirmed) {
                return;
            }

            try {
                console.log(`üóëÔ∏è Iniciando exclus√£o completa do usu√°rio ${userId} (${username})...`);
                showToast('Excluindo usu√°rio e todos os dados...', 'info');

                // 1. Contar e excluir todos os clientes (endere√ßos) do usu√°rio
                const { count: clientsCount } = await supabase
                    .from('clients')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId);

                const { error: clientsError } = await supabase
                    .from('clients')
                    .delete()
                    .eq('user_id', userId);

                if (clientsError) {
                    console.error('Erro ao excluir clientes:', clientsError);
                    throw new Error(`Erro ao excluir endere√ßos do usu√°rio: ${clientsError.message}`);
                }
                console.log(`‚úÖ ${clientsCount || 0} cliente(s)/endere√ßo(s) do usu√°rio ${userId} exclu√≠dos`);

                // 2. Contar e excluir todas as planilhas (br_addresses) do usu√°rio
                const { count: brCount } = await supabase
                    .from('br_addresses')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId);

                const { error: brError } = await supabase
                    .from('br_addresses')
                    .delete()
                    .eq('user_id', userId);

                if (brError) {
                    console.error('Erro ao excluir planilhas:', brError);
                    throw new Error(`Erro ao excluir planilhas do usu√°rio: ${brError.message}`);
                }
                console.log(`‚úÖ ${brCount || 0} c√≥digo(s) BR de planilhas do usu√°rio ${userId} exclu√≠dos`);

                // 3. Excluir o usu√°rio
                const { error: userError } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (userError) {
                    console.error('Erro ao excluir usu√°rio:', userError);
                    throw new Error(`Erro ao excluir usu√°rio: ${userError.message}`);
                }
                console.log(`‚úÖ Usu√°rio ${userId} (${username}) exclu√≠do`);

                // Mensagem de sucesso com resumo
                const summary = `Usu√°rio "${username}" exclu√≠do com sucesso!\n\n` +
                    `üìä Resumo:\n` +
                    `‚Ä¢ ${clientsCount || 0} endere√ßo(s)\n` +
                    `‚Ä¢ ${brCount || 0} c√≥digo(s) BR de planilhas`;

                showToast(summary, 'success');
                console.log(`\n=== EXCLUS√ÉO COMPLETA ===\nUsu√°rio: ${username} (ID: ${userId})\nClientes: ${clientsCount || 0}\nPlanilhas: ${brCount || 0}\n========================\n`);

                await loadUsers();

            } catch (error) {
                console.error('Erro ao excluir usu√°rio e dados:', error);
                showToast(error.message || 'Erro ao excluir usu√°rio e dados', 'error');
            }
        };

        // Icons
        const currentLocationIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="#2563eb">
                    <circle cx="16" cy="16" r="14" fill="#3b82f6" stroke="white" stroke-width="3" opacity="0.3"/>
                    <circle cx="16" cy="16" r="10" fill="#3b82f6" stroke="white" stroke-width="3"/>
                    <circle cx="16" cy="16" r="5" fill="white"/>
                </svg>
            `),
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const clientIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
            `),
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Initialize Map
        async function initMap(lat, lng) {
            // Detectar mobile
            const isMobile = window.innerWidth <= 768;

            // Usar Canvas Renderer para melhor performance (especialmente em mobile)
            const renderer = L.canvas({ padding: 0.5 });

            state.map = L.map('map', {
                zoomControl: false,
                preferCanvas: true,  // For√ßa uso de Canvas ao inv√©s de SVG
                renderer: renderer,
                // Otimiza√ß√µes para mobile
                tap: true,
                tapTolerance: 15,
                bounceAtZoomLimits: false,
                // Manter anima√ß√µes suaves para melhor experi√™ncia
                zoomAnimation: true,
                fadeAnimation: true,
                markerZoomAnimation: true,
                // Configura√ß√µes de zoom
                zoomSnap: 1,
                zoomDelta: 1,
                wheelPxPerZoomLevel: 60
            }).setView([lat, lng], isMobile ? 17 : 16);

            // Criar layers de Google Maps com m√°xima qualidade
            const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                attribution: '¬© Google Maps',
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                maxZoom: 22,
                minZoom: 3,
                updateWhenIdle: false,
                updateWhenZooming: true,
                keepBuffer: 3,
                tileSize: 256,
                zoomOffset: 0,
                detectRetina: true,
                className: ''
            });

            const googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: '¬© Google Maps',
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                maxZoom: 22,
                minZoom: 3,
                updateWhenIdle: false,
                updateWhenZooming: true,
                keepBuffer: 3,
                tileSize: 256,
                zoomOffset: 0,
                detectRetina: true,
                className: ''
            });

            const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                attribution: '¬© Google Maps',
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                maxZoom: 22,
                minZoom: 3,
                updateWhenIdle: false,
                updateWhenZooming: true,
                keepBuffer: 3,
                tileSize: 256,
                zoomOffset: 0,
                detectRetina: true,
                className: ''
            });

            // Adicionar layer padr√£o (mapa de ruas)
            googleStreets.addTo(state.map);

            // Armazenar layers no estado para alternar depois
            state.mapLayers = {
                streets: googleStreets,
                satellite: googleSatellite,
                hybrid: googleHybrid
            };
            state.currentMapLayer = 'streets';

            // Add current location marker
            state.currentLocationMarker = L.marker([lat, lng], {
                icon: currentLocationIcon,
                title: 'Sua localiza√ß√£o atual'
            }).addTo(state.map);

            // Bind popup mas N√ÉO abrir automaticamente (para evitar interfer√™ncia com visualiza√ß√£o de rotas)
            state.currentLocationMarker.bindPopup('<b>Voc√™ est√° aqui</b>');

            // Corrigir tamanho do mapa ap√≥s inicializa√ß√£o (importante para quando container estava oculto)
            setTimeout(() => {
                if (state.map) {
                    state.map.invalidateSize();
                    console.log('üó∫Ô∏è Tamanho do mapa ajustado ap√≥s inicializa√ß√£o');
                }
            }, 200);

            // Load clients from Supabase
            await loadClientsFromSupabase();

            // Load BR database from Supabase
            await loadBRDatabaseFromSupabase();

            // Load route data from Supabase
            await loadRouteDataFromSupabase();

            // Configurar sincroniza√ß√£o em tempo real
            setupRealtimeSubscription();

            hideLoading();
        }

        // Get Current Location
        async function getCurrentLocation() {
            if ('geolocation' in navigator) {
                // Verificar permiss√£o antes de solicitar
                if (navigator.permissions) {
                    try {
                        const permission = await navigator.permissions.query({ name: 'geolocation' });
                        console.log('Permiss√£o de geolocaliza√ß√£o:', permission.state);
                    } catch (error) {
                        console.log('N√£o foi poss√≠vel verificar permiss√£o:', error);
                    }
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        state.currentLocation = { lat, lng };
                        initMap(lat, lng);

                        // Watch position for updates (store ID to clear later if needed)
                        const backgroundWatchId = navigator.geolocation.watchPosition(
                            (pos) => {
                                const newLat = pos.coords.latitude;
                                const newLng = pos.coords.longitude;
                                state.currentLocation = { lat: newLat, lng: newLng };

                                if (state.currentLocationMarker) {
                                    state.currentLocationMarker.setLatLng([newLat, newLng]);
                                }
                            },
                            (error) => console.error('Error watching position:', error),
                            { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                        );
                        // Note: backgroundWatchId is not stored to state as it should run continuously
                    },
                    (error) => {
                        console.error('Geolocation error:', error);

                        let errorMessage = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                        if (error.code === 1) {
                            errorMessage = 'Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o nas configura√ß√µes do navegador.';
                        }

                        // Default to S√£o Paulo, Brazil
                        const defaultLat = -23.5505;
                        const defaultLng = -46.6333;
                        state.currentLocation = { lat: defaultLat, lng: defaultLng };
                        initMap(defaultLat, defaultLng);
                        showToast(errorMessage, 'warning');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
                );
            } else {
                showToast('Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.', 'error');
                const defaultLat = -23.5505;
                const defaultLng = -46.6333;
                state.currentLocation = { lat: defaultLat, lng: defaultLng };
                initMap(defaultLat, defaultLng);
            }
        }

        // Show/Hide Loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Load BR Database from Supabase
        async function loadBRDatabaseFromSupabase() {
            if (!state.useSupabase || !state.currentUser) return;

            // Limpar mensagem imediatamente ao iniciar o carregamento
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                uploadStatus.textContent = '';
                uploadStatus.className = 'upload-status';
            }

            try {
                const { data, error } = await supabase
                    .from('br_addresses')
                    .select('*')
                    .eq('user_id', state.currentUser.id);

                if (error) throw error;

                if (data && data.length > 0) {
                    state.brDatabase = {};
                    data.forEach(item => {
                        state.brDatabase[item.br_code] = item.address;
                    });
                    console.log(`‚úÖ ${data.length} c√≥digo(s) BR carregado(s) do Supabase (user_id: ${state.currentUser.id}) - ISOLAMENTO ATIVO`);

                    uploadStatus.textContent = `‚úì ${data.length} c√≥digos BR carregados!`;
                    uploadStatus.className = 'upload-status success';
                } else {
                    // Limpar mensagem se o usu√°rio n√£o tem dados
                    state.brDatabase = {};
                    uploadStatus.textContent = '';
                    uploadStatus.className = 'upload-status';
                    console.log(`üìä Nenhuma planilha encontrada para este usu√°rio (user_id: ${state.currentUser.id})`);
                }
            } catch (error) {
                console.error('Erro ao carregar banco de dados BR:', error);
                // Limpar mensagem em caso de erro
                const uploadStatus = document.getElementById('uploadStatus');
                if (uploadStatus) {
                    uploadStatus.textContent = '';
                    uploadStatus.className = 'upload-status';
                }
                state.brDatabase = {};
                // N√£o mostra toast, pois pode ser que a tabela ainda n√£o exista
            }
        }

        // Save BR Database to Supabase
        async function saveBRDatabaseToSupabase(brDatabase) {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                // Limpar dados antigos APENAS deste usu√°rio
                const { error: deleteError } = await supabase
                    .from('br_addresses')
                    .delete()
                    .eq('user_id', state.currentUser.id);

                if (deleteError) throw deleteError;

                // Inserir novos dados com user_id
                const records = Object.entries(brDatabase).map(([br_code, address]) => ({
                    br_code,
                    address,
                    user_id: state.currentUser.id
                }));

                if (records.length > 0) {
                    const { error: insertError } = await supabase
                        .from('br_addresses')
                        .insert(records);

                    if (insertError) throw insertError;

                    console.log(`‚úÖ ${records.length} c√≥digo(s) BR salvos no Supabase (user_id: ${state.currentUser.id})`);
                }
            } catch (error) {
                console.error('Erro ao salvar banco de dados BR:', error);
                showToast('Erro ao salvar c√≥digos BR no banco de dados', 'error');
            }
        }

        // Salvar dados de roteiriza√ß√£o no Supabase
        async function saveRouteDataToSupabase(routeData) {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                // Limpar dados antigos APENAS deste usu√°rio
                const { error: deleteError } = await supabase
                    .from('route_data')
                    .delete()
                    .eq('user_id', state.currentUser.id);

                if (deleteError) throw deleteError;

                // Inserir novos dados com user_id
                const records = routeData.map(item => ({
                    user_id: state.currentUser.id,
                    sequence: item.sequence,
                    stop: item.stop,
                    spx_tn: item.spxTn,
                    address: item.address,
                    address_original: item.addressOriginal,
                    address_cleaned: item.addressCleaned || '',
                    bairro: item.bairro || '',
                    city: item.city || '',
                    zipcode: item.zipcode || '',
                    latitude: item.latitude,
                    longitude: item.longitude,
                    geocoded_address: item.geocodedAddress || '',
                    packages: JSON.stringify(item.packages || [item.spxTn]),
                    sequences: JSON.stringify(item.sequences || [item.sequence]),
                    package_count: item.packageCount || 1
                }));

                if (records.length > 0) {
                    const { error: insertError } = await supabase
                        .from('route_data')
                        .insert(records);

                    if (insertError) throw insertError;

                    console.log(`‚úÖ ${records.length} registro(s) de rota salvos no Supabase (user_id: ${state.currentUser.id})`);
                }
            } catch (error) {
                console.error('Erro ao salvar dados de rota:', error);
                showToast('Erro ao salvar dados de roteiriza√ß√£o no banco de dados', 'error');
            }
        }

        // Carregar dados de roteiriza√ß√£o do Supabase
        async function loadRouteDataFromSupabase() {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('route_data')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('sequence', { ascending: true });

                if (error) throw error;

                if (data && data.length > 0) {
                    state.routeData = data.map(item => ({
                        sequence: item.sequence,
                        stop: item.stop,
                        spxTn: item.spx_tn,
                        address: item.address,
                        addressOriginal: item.address_original,
                        addressCleaned: item.address_cleaned,
                        bairro: item.bairro,
                        city: item.city,
                        zipcode: item.zipcode,
                        latitude: item.latitude,
                        longitude: item.longitude,
                        geocodedAddress: item.geocoded_address,
                        packages: JSON.parse(item.packages || '[]'),
                        sequences: JSON.parse(item.sequences || '[]'),
                        packageCount: item.package_count
                    }));

                    console.log(`‚úÖ ${state.routeData.length} registro(s) de rota carregados do Supabase`);

                    // Mostrar bot√£o de roteiriza√ß√£o se tiver dados
                    if (state.routeData.length > 0) {
                        document.getElementById('optimizeRouteBtn').style.display = 'block';
                        const totalPackages = state.routeData.reduce((sum, item) => sum + item.packageCount, 0);
                        const uploadStatus = document.getElementById('uploadStatus');
                        if (uploadStatus) {
                            uploadStatus.textContent = `‚úì ${state.routeData.length} endere√ßos, ${totalPackages} pacotes carregados`;
                            uploadStatus.className = 'upload-status success';
                        }

                        // Carregar status de entrega
                        await loadDeliveryStatusFromSupabase();

                        // Carregar e restaurar rota otimizada se existir
                        const optimizedRoute = await loadOptimizedRouteFromSupabase();
                        if (optimizedRoute && optimizedRoute.length > 0) {
                            // Restaurar a rota otimizada no mapa
                            setTimeout(() => {
                                processOptimizedRoute(optimizedRoute);
                                const routeStatus = document.getElementById('routeStatus');
                                if (routeStatus) {
                                    routeStatus.textContent = `‚úì Rota otimizada restaurada! ${optimizedRoute.length} paradas.`;
                                    routeStatus.className = 'upload-status success';
                                }
                                console.log('‚úÖ Rota otimizada restaurada automaticamente');
                            }, 500); // Aguardar mapa estar pronto
                        }
                    }
                } else {
                    state.routeData = [];
                    document.getElementById('optimizeRouteBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao carregar dados de rota:', error);
                state.routeData = [];
            }
        }

        // Salvar rota otimizada no Supabase
        async function saveOptimizedRouteToSupabase(optimizedOrder) {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                // Limpar rotas otimizadas antigas APENAS deste usu√°rio
                const { error: deleteError } = await supabase
                    .from('optimized_routes')
                    .delete()
                    .eq('user_id', state.currentUser.id);

                if (deleteError) throw deleteError;

                // Salvar nova rota otimizada
                const { error: insertError } = await supabase
                    .from('optimized_routes')
                    .insert([{
                        user_id: state.currentUser.id,
                        route_order: optimizedOrder,
                        total_stops: optimizedOrder.length
                    }]);

                if (insertError) throw insertError;

                console.log(`‚úÖ Rota otimizada salva no Supabase (${optimizedOrder.length} paradas)`);
            } catch (error) {
                console.error('Erro ao salvar rota otimizada:', error);
                // N√£o mostrar erro para o usu√°rio, apenas log
            }
        }

        // Carregar rota otimizada do Supabase
        async function loadOptimizedRouteFromSupabase() {
            if (!state.useSupabase || !state.currentUser) return null;

            try {
                const { data, error } = await supabase
                    .from('optimized_routes')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        // Nenhuma rota encontrada - normal
                        return null;
                    }
                    throw error;
                }

                if (data && data.route_order) {
                    console.log(`‚úÖ Rota otimizada carregada do Supabase (${data.total_stops} paradas)`);
                    return data.route_order;
                }

                return null;
            } catch (error) {
                console.error('Erro ao carregar rota otimizada:', error);
                return null;
            }
        }

        // ========== SISTEMA DE STATUS DE ENTREGA ==========

        // Marcar parada como entregue
        async function markStopAsDelivered(stopIndex, stopData) {
            if (!state.useSupabase || !state.currentUser) {
                // Modo offline - apenas atualizar visualmente
                state.deliveredStops.add(stopIndex);
                updateRouteMarkers();
                showToast('‚úÖ Parada marcada como entregue', 'success');
                return;
            }

            try {
                // Verificar se j√° existe registro
                const { data: existing, error: checkError } = await supabase
                    .from('delivery_status')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .eq('stop_index', stopIndex)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }

                if (existing) {
                    // Atualizar registro existente
                    const { error: updateError } = await supabase
                        .from('delivery_status')
                        .update({
                            is_delivered: true,
                            delivered_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);

                    if (updateError) throw updateError;
                } else {
                    // Criar novo registro
                    const { error: insertError } = await supabase
                        .from('delivery_status')
                        .insert([{
                            user_id: state.currentUser.id,
                            stop_index: stopIndex,
                            stop_address: stopData.address,
                            stop_latitude: stopData.latitude,
                            stop_longitude: stopData.longitude,
                            is_delivered: true,
                            delivered_at: new Date().toISOString()
                        }]);

                    if (insertError) throw insertError;
                }

                // Atualizar estado local
                state.deliveredStops.add(stopIndex);
                updateRouteMarkers();
                updateDeliveryCounter(); // Atualizar contador
                showToast('‚úÖ Parada marcada como entregue', 'success');
                console.log(`‚úÖ Parada ${stopIndex} marcada como entregue no Supabase`);
            } catch (error) {
                console.error('Erro ao marcar parada como entregue:', error);
                showToast('Erro ao salvar status de entrega', 'error');
            }
        }

        // Desmarcar parada como entregue
        async function unmarkStopAsDelivered(stopIndex) {
            if (!state.useSupabase || !state.currentUser) {
                // Modo offline - apenas atualizar visualmente
                state.deliveredStops.delete(stopIndex);
                updateRouteMarkers();
                showToast('‚Ü©Ô∏è Entrega desfeita', 'info');
                return;
            }

            try {
                const { error } = await supabase
                    .from('delivery_status')
                    .update({
                        is_delivered: false,
                        delivered_at: null
                    })
                    .eq('user_id', state.currentUser.id)
                    .eq('stop_index', stopIndex);

                if (error) throw error;

                // Atualizar estado local
                state.deliveredStops.delete(stopIndex);
                updateRouteMarkers();
                updateDeliveryCounter(); // Atualizar contador
                showToast('‚Ü©Ô∏è Entrega desfeita', 'info');
                console.log(`‚Ü©Ô∏è Parada ${stopIndex} desmarcada no Supabase`);
            } catch (error) {
                console.error('Erro ao desmarcar parada:', error);
                showToast('Erro ao desfazer entrega', 'error');
            }
        }

        // Carregar status de entrega do Supabase
        async function loadDeliveryStatusFromSupabase() {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('delivery_status')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .eq('is_delivered', true);

                if (error) throw error;

                // Limpar estado anterior
                state.deliveredStops.clear();

                // Adicionar paradas entregues ao Set
                if (data && data.length > 0) {
                    data.forEach(delivery => {
                        state.deliveredStops.add(delivery.stop_index);
                    });
                    console.log(`‚úÖ Status de entrega carregado: ${data.length} paradas entregues`);
                }
            } catch (error) {
                console.error('Erro ao carregar status de entrega:', error);
            }
        }

        // Limpar todos os status de entrega (quando iniciar nova rota)
        async function clearAllDeliveryStatus() {
            if (!state.useSupabase || !state.currentUser) {
                state.deliveredStops.clear();
                return;
            }

            try {
                const { error } = await supabase
                    .from('delivery_status')
                    .delete()
                    .eq('user_id', state.currentUser.id);

                if (error) throw error;

                state.deliveredStops.clear();
                console.log('üóëÔ∏è Status de entrega limpo');
            } catch (error) {
                console.error('Erro ao limpar status de entrega:', error);
            }
        }

        // Atualizar marcadores da rota ap√≥s mudan√ßa de status de entrega
        function updateRouteMarkers() {
            if (!state.viewingOptimizedRoute || !state.optimizedOrder) return;

            // Re-renderizar a rota otimizada com os marcadores atualizados
            // Limpar marcadores e polylines anteriores
            state.routePolylines.forEach(polyline => state.map.removeLayer(polyline));
            state.routePolylines = [];

            // Usar a ordem otimizada armazenada no estado
            const optimizedOrder = state.optimizedOrder;
            const isMobile = window.innerWidth <= 768;
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
            const totalStops = optimizedOrder.length;
            const usePrettyIcons = !isMobile || totalStops <= 10;

            // Detectar e deslocar marcadores sobrepostos
            const offsetMap = new Map();
            const OVERLAP_THRESHOLD = 0.00005;
            const OFFSET_AMOUNT = 0.0001;

            function getAdjustedCoordinates(lat, lng, index) {
                let adjustedLat = lat;
                let adjustedLng = lng;

                for (const [key, offset] of offsetMap.entries()) {
                    const [existingLat, existingLng] = key.split('_').map(Number);
                    const latDiff = Math.abs(existingLat - adjustedLat);
                    const lngDiff = Math.abs(existingLng - adjustedLng);

                    if (latDiff < OVERLAP_THRESHOLD && lngDiff < OVERLAP_THRESHOLD) {
                        const angle = (offset.count * 60) * (Math.PI / 180);
                        adjustedLat = existingLat + (OFFSET_AMOUNT * Math.cos(angle));
                        adjustedLng = existingLng + (OFFSET_AMOUNT * Math.sin(angle));
                        offset.count++;
                        break;
                    }
                }

                const key = `${adjustedLat}_${adjustedLng}`;
                if (!offsetMap.has(key)) {
                    offsetMap.set(key, { count: 1 });
                }

                return [adjustedLat, adjustedLng];
            }

            // Reconstruir marcadores com status atualizado
            optimizedOrder.forEach((originalIndex, routeIndex) => {
                const stop = state.routeData[originalIndex];
                if (!stop || !stop.latitude || !stop.longitude) return;

                const [adjustedLat, adjustedLng] = getAdjustedCoordinates(
                    stop.latitude,
                    stop.longitude,
                    routeIndex
                );

                const stopNumber = routeIndex + 1;
                const isDelivered = state.deliveredStops.has(routeIndex);
                const color = isDelivered ? '#9ca3af' : colors[routeIndex % colors.length];
                const packageCount = stop.packageCount || 1;

                // Mobile com MUITAS paradas: usar CircleMarker simples
                if (isMobile && !usePrettyIcons) {
                    const circleMarker = L.circleMarker([adjustedLat, adjustedLng], {
                        radius: 12,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: isDelivered ? 0.6 : 1,
                        fillOpacity: isDelivered ? 0.5 : 0.9
                    }).addTo(state.map);

                    circleMarker.on('click', function() {
                        const sequencesList = stop.sequences && stop.sequences.length > 0
                            ? stop.sequences.sort((a, b) => a - b).join(', ')
                            : '-';
                        const currentlyDelivered = state.deliveredStops.has(routeIndex);

                        this.bindPopup(`
                            <div style="font-size: 13px; min-width: 200px;">
                                <div style="font-weight: bold; margin-bottom: 6px; color: ${color};">
                                    ${currentlyDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber} ‚Ä¢ ${packageCount} pacote${packageCount > 1 ? 's' : ''}
                                </div>
                                <div style="margin: 3px 0;">üìç ${stop.address}</div>
                                <div style="margin: 3px 0; font-size: 11px; color: #666;">Ordem: ${sequencesList}</div>
                                ${!currentlyDelivered ? `
                                    <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                        style="margin-top: 8px; width: 100%; padding: 8px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                        ‚úÖ Marcar como entregue
                                    </button>
                                ` : `
                                    <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                        style="margin-top: 8px; width: 100%; padding: 8px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                        ‚Ü©Ô∏è Desfazer entrega
                                    </button>
                                `}
                                <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                                    style="margin-top: 6px; width: 100%; padding: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                    üß≠ Navegar at√© aqui
                                </button>
                            </div>
                        `).openPopup();
                    });

                    state.routePolylines.push(circleMarker);
                    return;
                }

                // PINO DE GPS com numera√ß√£o
                const iconHTML = `
                    <div style="position: relative; width: 40px; height: ${packageCount > 1 ? '55px' : '40px'};">
                        ${packageCount > 1 ? `
                            <div style="
                                position: absolute;
                                top: -10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: #ef4444;
                                color: white;
                                border-radius: ${isMobile ? '8px' : '12px'};
                                padding: 2px ${isMobile ? '6px' : '8px'};
                                font-size: ${isMobile ? '10px' : '11px'};
                                font-weight: bold;
                                border: ${isMobile ? '1px' : '2px'} solid white;
                                box-shadow: ${isMobile ? '0 1px 3px rgba(0,0,0,0.3)' : '0 2px 6px rgba(0,0,0,0.3)'};
                                white-space: nowrap;
                                z-index: 10;
                            ">
                                ${packageCount} pacote${packageCount > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                        <div style="
                            position: relative;
                            width: ${isMobile ? '32px' : '36px'};
                            height: ${isMobile ? '32px' : '36px'};
                            background: ${color};
                            border-radius: 50% 50% 50% 0;
                            border: ${isMobile ? '2px' : '3px'} solid white;
                            box-shadow: ${isMobile ? '0 2px 5px rgba(0,0,0,0.35)' : '0 3px 8px rgba(0,0,0,0.4)'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transform: rotate(-45deg);
                            margin: ${packageCount > 1 ? '18px' : '0'} auto 0 auto;
                            opacity: ${isDelivered ? '0.6' : '1'};
                        ">
                            <div style="
                                transform: rotate(45deg);
                                color: white;
                                font-weight: bold;
                                font-size: ${isMobile ? '13px' : '16px'};
                            ">
                                ${stopNumber}
                            </div>
                        </div>
                    </div>
                `;

                const numberedIcon = L.divIcon({
                    className: 'numbered-marker',
                    html: iconHTML,
                    iconSize: packageCount > 1 ? [40, 55] : [40, 40],
                    iconAnchor: packageCount > 1 ? [20, 55] : [20, 40]
                });

                const marker = L.marker([adjustedLat, adjustedLng], {
                    icon: numberedIcon,
                    title: `Parada ${stopNumber}: ${stop.address}`
                }).addTo(state.map);

                const sequencesList = stop.sequences && stop.sequences.length > 0
                    ? stop.sequences.sort((a, b) => a - b).join(', ')
                    : stop.sequence || '-';

                const packagesList = stop.packages && stop.packages.length > 0
                    ? (stop.packages.length <= (isMobile ? 5 : 10)
                        ? stop.packages.join(', ')
                        : `${stop.packages.slice(0, isMobile ? 5 : 10).join(', ')}... (+${stop.packages.length - (isMobile ? 5 : 10)})`)
                    : stop.spxTn || '-';

                const popupContent = isMobile ? `
                    <div class="popup-content" style="max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">${isDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber}</h3>
                        <p style="margin: 4px 0;"><strong>üì¶ Pacotes:</strong> ${packageCount}</p>
                        <p style="margin: 4px 0;"><strong>üî¢ Ordem:</strong> ${sequencesList}</p>
                        <p style="margin: 4px 0;"><strong>üìç</strong> ${stop.address}</p>
                        ${stop.city ? `<p style="margin: 4px 0; font-size: 12px;"><strong>üèôÔ∏è</strong> ${stop.city}</p>` : ''}
                        ${!isDelivered ? `
                            <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                                ‚úÖ Marcar como entregue
                            </button>
                        ` : `
                            <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                                ‚Ü©Ô∏è Desfazer entrega
                            </button>
                        `}
                        <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                            style="margin-top: 6px; width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                            üß≠ Navegar at√© aqui
                        </button>
                    </div>
                ` : `
                    <div class="popup-content">
                        <h3>${isDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber}</h3>
                        ${distanceInfo}
                        <p><strong>üì¶ Pacotes:</strong> ${packageCount}</p>
                        <p><strong>üî¢ Ordem:</strong><br><span style="font-size: 12px; color: #666;">${sequencesList}</span></p>
                        <p><strong>üìç Endere√ßo:</strong><br>${stop.address}</p>
                        <p><strong>üèôÔ∏è Cidade:</strong> ${stop.city}</p>
                        <p><strong>üìÆ CEP:</strong> ${stop.zipcode}</p>
                        <p><strong>üì¶ C√≥digos SPX:</strong><br><span style="font-size: 11px; color: #666;">${packagesList}</span></p>
                        ${!isDelivered ? `
                            <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                style="margin-top: 12px; width: 100%; padding: 10px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ‚úÖ Marcar como entregue
                            </button>
                        ` : `
                            <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                style="margin-top: 12px; width: 100%; padding: 10px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ‚Ü©Ô∏è Desfazer entrega
                            </button>
                        `}
                        <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                            style="margin-top: 8px; width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üß≠ Navegar at√© aqui
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);
                state.routePolylines.push(marker);

                // Desenhar linha para a pr√≥xima parada
                if (routeIndex < optimizedOrder.length - 1) {
                    const nextStop = state.routeData[optimizedOrder[routeIndex + 1]];
                    if (nextStop && nextStop.latitude && nextStop.longitude) {
                        const polyline = L.polyline([
                            [stop.latitude, stop.longitude],
                            [nextStop.latitude, nextStop.longitude]
                        ], {
                            color: color,
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '10, 5'
                        }).addTo(state.map);

                        state.routePolylines.push(polyline);
                    }
                }
            });

            console.log('üîÑ Marcadores da rota atualizados');
        }

        // Configurar sincroniza√ß√£o autom√°tica com POLLING (mais confi√°vel)
        function setupRealtimeSubscription() {
            if (!state.useSupabase || !state.currentUser) return;

            // Cancelar polling anterior se existir
            if (state.syncPollingInterval) {
                clearInterval(state.syncPollingInterval);
                state.syncPollingInterval = null;
            }

            console.log(`üîÑ Configurando sincroniza√ß√£o autom√°tica (polling) para user_id: ${state.currentUser.id}`);

            // Verificar mudan√ßas a cada 0.5 segundos (ultra-r√°pido)
            state.syncPollingInterval = setInterval(async () => {
                await checkForClientChanges();
            }, 500); // 0.5 segundos

            console.log('‚úÖ Sincroniza√ß√£o autom√°tica ativada! (verificando a cada 0.5s)');
        }

        // ========== CONTROLES DO MAPA (AMAZON FLEX STYLE) ==========

        // Alternar tipo de mapa (Rua/Sat√©lite/H√≠brido)
        function toggleMapType() {
            if (!state.map || !state.mapLayers) return;

            const types = ['streets', 'satellite', 'hybrid'];
            const labels = ['Sat√©lite', 'H√≠brido', 'Mapa'];
            const currentIndex = types.indexOf(state.currentMapLayer);
            const nextIndex = (currentIndex + 1) % types.length;
            const nextType = types[nextIndex];

            // Remover layer atual
            state.map.removeLayer(state.mapLayers[state.currentMapLayer]);

            // Adicionar novo layer
            state.mapLayers[nextType].addTo(state.map);

            // Atualizar estado e UI
            state.currentMapLayer = nextType;
            document.getElementById('mapTypeLabel').textContent = labels[nextIndex];

            console.log(`üó∫Ô∏è Mapa alterado para: ${nextType}`);
        }

        // Recentralizar mapa na localiza√ß√£o atual do GPS
        function recenterMap() {
            if (!state.map || !state.currentLocationMarker) {
                showToast('Localiza√ß√£o GPS n√£o dispon√≠vel', 'error');
                return;
            }

            const latlng = state.currentLocationMarker.getLatLng();
            state.map.setView(latlng, 17, {
                animate: true,
                duration: 0.5
            });

            // Efeito visual no bot√£o
            const btn = document.getElementById('recenterBtn');
            btn.style.transform = 'scale(0.9) rotate(180deg)';
            setTimeout(() => {
                btn.style.transform = 'scale(1) rotate(0deg)';
            }, 300);

            showToast('üìç Centralizado na sua localiza√ß√£o', 'success');
        }

        // Atualizar contador de entregas
        function updateDeliveryCounter() {
            if (!state.optimizedOrder) {
                document.getElementById('deliveryCounter').style.display = 'none';
                return;
            }

            const total = state.optimizedOrder.length;
            const delivered = state.deliveredStops.size;
            const percentage = total > 0 ? (delivered / total) * 100 : 0;

            document.getElementById('deliveryCounter').style.display = 'block';
            document.getElementById('deliveredCount').textContent = delivered;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('deliveryProgress').style.width = `${percentage}%`;
        }

        // Calcular tempo estimado (baseado em velocidade m√©dia de 30 km/h em cidade)
        function calculateEstimatedTime(distanceKm) {
            const avgSpeed = 30; // km/h
            const hours = distanceKm / avgSpeed;
            const minutes = Math.round(hours * 60);

            if (minutes < 1) return '< 1 min';
            if (minutes < 60) return `${minutes} min`;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h}h ${m}min`;
        }

        // Formatar dist√¢ncia
        function formatDistance(distanceKm) {
            if (distanceKm < 1) {
                return `${Math.round(distanceKm * 1000)} m`;
            }
            return `${distanceKm.toFixed(1)} km`;
        }

        // Verificar mudan√ßas nos clientes
        async function checkForClientChanges() {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                // Buscar clientes do servidor
                const { data, error } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const serverClients = data || [];

                // Converter para formato do cliente
                const serverClientsMap = {};
                serverClients.forEach(client => {
                    serverClientsMap[client.id] = {
                        id: client.id,
                        name: client.name,
                        address: client.address,
                        lat: client.latitude,
                        lng: client.longitude,
                        br: client.br || '',
                        phone: client.phone || '',
                        date: client.created_at
                    };
                });

                // IDs dos clientes locais e do servidor
                const localIds = new Set(state.clients.map(c => c.id));
                const serverIds = new Set(serverClients.map(c => c.id));

                // Detectar NOVOS clientes (no servidor mas n√£o local)
                serverIds.forEach(id => {
                    if (!localIds.has(id)) {
                        const newClient = serverClientsMap[id];
                        state.clients.push(newClient);
                        addClientMarker(newClient);
                        updateClientsList();
                        showToast(`‚ú® Novo cliente: ${newClient.name}`, 'success');
                        console.log('‚úÖ Cliente adicionado via sync:', newClient.name);
                    }
                });

                // Detectar clientes REMOVIDOS (local mas n√£o no servidor)
                const clientsToRemove = [];
                state.clients.forEach((client, index) => {
                    if (!serverIds.has(client.id)) {
                        clientsToRemove.push({ client, index });
                    }
                });

                // Remover clientes deletados (do fim para o in√≠cio)
                clientsToRemove.reverse().forEach(({ client, index }) => {
                    // Remover do state
                    state.clients.splice(index, 1);

                    // Remover marcador do mapa
                    const markerObj = state.clientMarkers.find(m => m.id === client.id);
                    if (markerObj && state.map) {
                        state.map.removeLayer(markerObj.marker);
                        const markerIndex = state.clientMarkers.findIndex(m => m.id === client.id);
                        if (markerIndex !== -1) {
                            state.clientMarkers.splice(markerIndex, 1);
                        }
                    }

                    updateClientsList();
                    showToast(`üóëÔ∏è Cliente removido: ${client.name}`, 'warning');
                    console.log('üóëÔ∏è Cliente deletado via sync:', client.name);
                });

                // Detectar clientes ATUALIZADOS
                state.clients.forEach((localClient, index) => {
                    if (serverIds.has(localClient.id)) {
                        const serverClient = serverClientsMap[localClient.id];

                        // Verificar se houve mudan√ßas
                        const hasChanges =
                            localClient.name !== serverClient.name ||
                            localClient.address !== serverClient.address ||
                            localClient.lat !== serverClient.lat ||
                            localClient.lng !== serverClient.lng ||
                            localClient.br !== serverClient.br ||
                            localClient.phone !== serverClient.phone;

                        if (hasChanges) {
                            // Atualizar no state
                            state.clients[index] = serverClient;

                            // Atualizar marcador no mapa
                            const markerObj = state.clientMarkers.find(m => m.id === serverClient.id);
                            if (markerObj && state.map) {
                                state.map.removeLayer(markerObj.marker);
                                const markerIndex = state.clientMarkers.findIndex(m => m.id === serverClient.id);
                                if (markerIndex !== -1) {
                                    state.clientMarkers.splice(markerIndex, 1);
                                }
                                addClientMarker(serverClient);
                            }

                            updateClientsList();
                            showToast(`üîÑ Cliente atualizado: ${serverClient.name}`, 'info');
                            console.log('üîÑ Cliente atualizado via sync:', serverClient.name);
                        }
                    }
                });

            } catch (error) {
                // Silencioso - n√£o mostrar erro para o usu√°rio (polling em background)
                console.error('Erro na sincroniza√ß√£o autom√°tica:', error);
            }
        }

        // Load Clients from Supabase
        async function loadClientsFromSupabase() {
            if (!state.useSupabase || !state.currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('user_id', state.currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    // Clear existing clients
                    state.clients = [];
                    state.clientMarkers.forEach(m => state.map.removeLayer(m.marker));
                    state.clientMarkers = [];

                    // Add clients from database
                    data.forEach(client => {
                        const clientObj = {
                            id: client.id,
                            name: client.name,
                            address: client.address,
                            lat: client.latitude,
                            lng: client.longitude,
                            br: client.br || '',
                            phone: client.phone || '',
                            date: client.created_at
                        };
                        state.clients.push(clientObj);
                        addClientMarker(clientObj);
                    });

                    updateClientsList();
                    console.log(`‚úÖ ${data.length} cliente(s) carregado(s) do Supabase (user_id: ${state.currentUser.id}) - ISOLAMENTO ATIVO`);
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                showToast('Erro ao carregar clientes do banco de dados', 'error');
            }
        }

        // Add Client
        async function addClient(name, address, lat, lng, br = '', phone = '') {
            // Verificar se o usu√°rio est√° logado
            if (!state.currentUser || !state.currentUser.id) {
                showToast('Erro: Usu√°rio n√£o autenticado', 'error');
                return;
            }

            const client = {
                name,
                address,
                lat,
                lng,
                br,
                phone,
                date: new Date().toISOString()
            };

            if (state.useSupabase) {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([
                            {
                                name: client.name,
                                address: client.address,
                                latitude: client.lat,
                                longitude: client.lng,
                                br: client.br,
                                phone: client.phone,
                                user_id: state.currentUser.id
                            }
                        ])
                        .select();

                    if (error) throw error;

                    // Use the ID from database
                    client.id = data[0].id;
                    client.date = data[0].created_at;
                    client.br = data[0].br || '';
                    client.phone = data[0].phone || '';

                    console.log(`‚úÖ Cliente salvo no Supabase (user_id: ${state.currentUser.id})`);
                } catch (error) {
                    console.error('Erro ao salvar cliente:', error);

                    // Mensagens de erro espec√≠ficas
                    let errorMessage = 'Erro ao salvar cliente no banco de dados';

                    if (error.message && error.message.includes('column "phone"')) {
                        errorMessage = 'Erro: A coluna "phone" n√£o existe no banco de dados. Execute este SQL no Supabase:\nALTER TABLE clients ADD COLUMN phone TEXT;';
                    } else if (error.code === '42703') {
                        errorMessage = 'Erro: Coluna n√£o encontrada no banco de dados. Verifique a estrutura da tabela "clients" no Supabase.';
                    } else if (error.code === '23505') {
                        errorMessage = 'Erro: Cliente duplicado. J√° existe um cliente com esses dados.';
                    } else if (error.message) {
                        errorMessage = `Erro ao salvar: ${error.message}`;
                    }

                    showToast(errorMessage, 'error');
                    console.error('üí° Detalhes do erro:', {
                        code: error.code,
                        message: error.message,
                        details: error.details,
                        hint: error.hint
                    });
                    return null;
                }
            } else {
                // Fallback to local storage
                client.id = state.nextId++;
            }

            state.clients.push(client);
            addClientMarker(client);
            updateClientsList();
            return client;
        }

        // Add Client Marker
        function addClientMarker(client) {
            const marker = L.marker([client.lat, client.lng], {
                icon: clientIcon,
                title: client.name
            }).addTo(state.map);

            updateMarkerPopup(client, marker);
            state.clientMarkers.push({ id: client.id, marker });
        }

        // Calculate Distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Dist√¢ncia em km
        }

        // Update Navigation Stats
        function updateNavigationStats() {
            if (!state.navigationActive || !state.currentLocation || !state.navigationDestination) return;

            const distance = calculateDistance(
                state.currentLocation.lat,
                state.currentLocation.lng,
                state.navigationDestination.lat,
                state.navigationDestination.lng
            );

            // Atualizar painel
            document.getElementById('navDistance').textContent =
                distance < 1 ? `${Math.round(distance * 1000)} m` : `${distance.toFixed(2)} km`;

            // Estimativa de tempo (assumindo 40 km/h de m√©dia)
            const estimatedTime = Math.round((distance / 40) * 60);
            document.getElementById('navTime').textContent =
                estimatedTime < 1 ? '< 1 min' : `${estimatedTime} min`;

            // Verificar se chegou ao destino (menos de 50 metros)
            if (distance < 0.05) {
                showToast('üéâ Voc√™ chegou ao destino!', 'success');
                stopRealtimeNavigation();
            }
        }

        // Start GPS Tracking for real-time navigation
        function startGPSTracking() {
            if (!('geolocation' in navigator)) {
                showToast('Geolocaliza√ß√£o n√£o suportada', 'error');
                return;
            }

            let lastLat = null;
            let lastLng = null;

            // Rastrear posi√ß√£o continuamente
            state.navigationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const newLat = position.coords.latitude;
                    const newLng = position.coords.longitude;
                    const heading = position.coords.heading; // Dire√ß√£o do movimento (0-360 graus)
                    const speed = position.coords.speed; // Velocidade em m/s

                    console.log('üìç Posi√ß√£o atualizada:', {
                        lat: newLat,
                        lng: newLng,
                        heading: heading,
                        speed: speed
                    });

                    // Atualizar posi√ß√£o atual
                    state.currentLocation = { lat: newLat, lng: newLng };

                    // Atualizar marcador de posi√ß√£o no mapa
                    if (state.currentLocationMarker) {
                        state.currentLocationMarker.setLatLng([newLat, newLng]);
                    }

                    // Calcular dire√ß√£o baseado na posi√ß√£o anterior se heading n√£o estiver dispon√≠vel
                    let bearing = heading;
                    if (bearing === null && lastLat !== null && lastLng !== null) {
                        // Calcular bearing entre dois pontos
                        const dLon = (newLng - lastLng) * Math.PI / 180;
                        const lat1 = lastLat * Math.PI / 180;
                        const lat2 = newLat * Math.PI / 180;
                        const y = Math.sin(dLon) * Math.cos(lat2);
                        const x = Math.cos(lat1) * Math.sin(lat2) -
                                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
                        bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
                    }

                    // ROTA√á√ÉO DO MAPA baseado na dire√ß√£o do movimento
                    // Nota: setBearing() requer plugin Leaflet.Rotate - comentado por enquanto
                    if (bearing !== null && !isNaN(bearing)) {
                        // state.map.setBearing(bearing);
                        console.log('üß≠ Dire√ß√£o calculada:', bearing.toFixed(1) + '¬∞');
                    }

                    // Calcular dist√¢ncia at√© o destino
                    const distanceToDestination = calculateDistance(
                        newLat, newLng,
                        state.navigationDestination.lat, state.navigationDestination.lng
                    );

                    // ZOOM DIN√ÇMICO baseado na dist√¢ncia (APENAS durante navega√ß√£o ativa E n√£o visualizando rota otimizada)
                    if (state.navigationActive && !state.viewingOptimizedRoute) {
                        let targetZoom = 16; // Zoom padr√£o
                        if (distanceToDestination < 0.1) { // Menos de 100m
                            targetZoom = 19; // Zoom alto (pr√≥ximo)
                        } else if (distanceToDestination < 0.5) { // Menos de 500m
                            targetZoom = 18;
                        } else if (distanceToDestination < 1) { // Menos de 1km
                            targetZoom = 17;
                        } else if (distanceToDestination < 5) { // Menos de 5km
                            targetZoom = 16;
                        } else {
                            targetZoom = 14; // Zoom m√©dio (longe)
                        }

                        // Aplicar zoom suave
                        if (Math.abs(state.map.getZoom() - targetZoom) > 0.5) {
                            state.map.setZoom(targetZoom, {
                                animate: true
                            });
                            console.log(`üîç Zoom ajustado para ${targetZoom} (dist√¢ncia: ${distanceToDestination.toFixed(2)} km)`);
                        }
                    }

                    // Centralizar mapa na posi√ß√£o atual APENAS se navega√ß√£o estiver ativa E n√£o visualizando rota otimizada
                    if (state.navigationActive && !state.viewingOptimizedRoute) {
                        state.map.panTo([newLat, newLng], {
                            animate: true,
                            duration: 1
                        });
                    }

                    // Atualizar estat√≠sticas de navega√ß√£o
                    updateNavigationStats();

                    // Recalcular rota se necess√°rio
                    if (state.routingControl && state.navigationDestination) {
                        const waypoints = state.routingControl.getWaypoints();
                        waypoints[0].latLng = L.latLng(newLat, newLng);
                        state.routingControl.setWaypoints(waypoints);
                    }

                    // Armazenar posi√ß√£o atual para pr√≥xima itera√ß√£o
                    lastLat = newLat;
                    lastLng = newLng;
                },
                (error) => {
                    console.error('Erro no rastreamento GPS:', error);
                    showToast('Erro ao rastrear localiza√ß√£o', 'warning');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000, // Atualiza√ß√£o mais frequente para rota√ß√£o suave
                    timeout: 10000
                }
            );

            console.log('‚úÖ Rastreamento GPS iniciado com rota√ß√£o e zoom autom√°tico');
        }

        // Toggle Navigation Panel
        window.toggleNavigationPanel = function() {
            const navPanel = document.getElementById('navigationPanel');
            const toggleBtn = document.getElementById('navToggleBtn');

            if (navPanel.classList.contains('collapsed')) {
                navPanel.classList.remove('collapsed');
                toggleBtn.textContent = 'Ocultar';
            } else {
                navPanel.classList.add('collapsed');
                toggleBtn.textContent = 'Ver';
            }
        };

        // Stop Realtime Navigation
        window.stopRealtimeNavigation = function() {
            state.navigationActive = false;

            // Parar rastreamento GPS
            if (state.navigationWatchId) {
                navigator.geolocation.clearWatch(state.navigationWatchId);
                state.navigationWatchId = null;
            }

            // Remover rota
            if (state.routingControl) {
                state.map.removeControl(state.routingControl);
                state.routingControl = null;
            }

            // N√ÉO resetar zoom aqui - deixar o mapa onde est√°
            // (o zoom ser√° ajustado por quem chamou esta fun√ß√£o, se necess√°rio)

            // Ocultar painel
            const navPanel = document.getElementById('navigationPanel');
            if (navPanel) {
                navPanel.classList.remove('active');
            }

            state.navigationDestination = null;
            state.currentRoute = null;
        };

        // Start Navigation with Real-time GPS
        window.startNavigation = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client || !state.currentLocation) return;

            // Parar navega√ß√£o anterior se houver
            if (state.navigationActive) {
                stopRealtimeNavigation();
            }

            // Desabilitar modo de visualiza√ß√£o de rota otimizada
            state.viewingOptimizedRoute = false;

            // Fechar todos os popups
            state.map.closePopup();

            // Configurar nova navega√ß√£o
            state.navigationActive = true;
            state.navigationDestination = {
                lat: client.lat,
                lng: client.lng,
                name: client.name
            };

            // Mostrar painel de navega√ß√£o
            document.getElementById('navigationPanel').classList.add('active');
            document.getElementById('navDestination').textContent = client.name;
            document.getElementById('navStatus').textContent = 'üì° Calculando rota...';
            document.getElementById('navStatus').className = 'nav-status calculating';

            console.log('üß≠ Iniciando navega√ß√£o em tempo real:', {
                origem: `${state.currentLocation.lat}, ${state.currentLocation.lng}`,
                destino: `${client.lat}, ${client.lng}`,
                cliente: client.name
            });

            try {
                // Criar controle de roteamento
                state.routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(state.currentLocation.lat, state.currentLocation.lng),
                        L.latLng(client.lat, client.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    addWaypoints: false,
                    fitSelectedRoutes: true,
                    lineOptions: {
                        styles: [
                            {color: '#2563eb', opacity: 0.8, weight: 6}
                        ],
                        extendToWaypoints: true,
                        missingRouteTolerance: 0
                    },
                    createMarker: function() { return null; }, // N√£o criar marcadores extras
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving', // ou 'car', 'bike', 'foot'
                        timeout: 30000 // 30 segundos timeout
                    }),
                    formatter: new L.Routing.Formatter({
                        language: 'pt',
                        units: 'metric',
                        unitNames: {
                            meters: 'm',
                            kilometers: 'km',
                            yards: 'yd',
                            miles: 'mi',
                            hours: 'h',
                            minutes: 'min',
                            seconds: 's'
                        }
                    })
                }).addTo(state.map);

                // Evento quando a rota √© calculada
                state.routingControl.on('routesfound', function(e) {
                    console.log('‚úÖ Rota encontrada:', e.routes);
                    const routes = e.routes;
                    state.currentRoute = routes[0];
                    const summary = routes[0].summary;
                    const distance = (summary.totalDistance / 1000).toFixed(2);
                    const time = Math.round(summary.totalTime / 60);

                    // Atualizar painel com dados da rota
                    document.getElementById('navDistance').textContent = `${distance} km`;
                    document.getElementById('navTime').textContent = `${time} min`;
                    document.getElementById('navStatus').textContent = 'üöó Navegando...';
                    document.getElementById('navStatus').className = 'nav-status';

                    // ZOOM INICIAL mais pr√≥ximo baseado na dist√¢ncia
                    let initialZoom = 19; // Zoom muito alto por padr√£o
                    const distKm = parseFloat(distance);
                    if (distKm < 0.5) { // Menos de 500m
                        initialZoom = 19;
                    } else if (distKm < 2) { // Menos de 2km
                        initialZoom = 18;
                    } else if (distKm < 5) { // Menos de 5km
                        initialZoom = 17;
                    } else if (distKm < 10) { // Menos de 10km
                        initialZoom = 16;
                    } else {
                        initialZoom = 15;
                    }

                    // Aplicar zoom inicial
                    state.map.setZoom(initialZoom);
                    console.log(`üîç Zoom inicial definido para ${initialZoom} (dist√¢ncia: ${distance} km)`);

                    // Centralizar no ponto inicial (sua localiza√ß√£o)
                    state.map.setView([state.currentLocation.lat, state.currentLocation.lng], initialZoom, {
                        animate: true,
                        duration: 0.5
                    });

                    // Iniciar rastreamento GPS em tempo real
                    startGPSTracking();

                    // Fechar sidebar em mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });

                state.routingControl.on('routingerror', function(e) {
                    console.error('‚ùå Erro detalhado ao calcular rota:', e);

                    let errorMsg = 'N√£o foi poss√≠vel calcular a rota.';

                    if (e.error && e.error.status) {
                        if (e.error.status === 429) {
                            errorMsg = 'Muitas requisi√ß√µes. Aguarde alguns segundos e tente novamente.';
                        } else if (e.error.status === 0) {
                            errorMsg = 'Sem conex√£o com o servidor de rotas. Verifique sua internet.';
                        } else {
                            errorMsg = `Erro ${e.error.status}: ${e.error.message || 'Erro desconhecido'}`;
                        }
                    }

                    showToast(errorMsg, 'error');

                    // Remover controle com erro
                    if (state.routingControl) {
                        state.map.removeControl(state.routingControl);
                        state.routingControl = null;
                    }
                });

            } catch (error) {
                console.error('‚ùå Erro ao criar roteamento:', error);
                showToast('Erro ao iniciar navega√ß√£o: ' + error.message, 'error');
            }
        };

        // Start Navigation to a Stop (from optimized route)
        window.startNavigationToStop = function(lat, lng, address, stopNumber) {
            if (!state.currentLocation) {
                showToast('Localiza√ß√£o atual n√£o dispon√≠vel', 'error');
                return;
            }

            // Parar navega√ß√£o anterior se houver
            if (state.navigationActive) {
                stopRealtimeNavigation();
            }

            // Desabilitar modo de visualiza√ß√£o de rota otimizada
            state.viewingOptimizedRoute = false;

            // Fechar todos os popups
            state.map.closePopup();

            // Configurar nova navega√ß√£o
            state.navigationActive = true;
            state.navigationDestination = {
                lat: lat,
                lng: lng,
                name: `Parada ${stopNumber}: ${address}`
            };

            // Mostrar painel de navega√ß√£o
            document.getElementById('navigationPanel').classList.add('active');
            document.getElementById('navDestination').textContent = `Parada ${stopNumber}`;
            document.getElementById('navStatus').textContent = 'üì° Calculando rota...';
            document.getElementById('navStatus').className = 'nav-status calculating';

            console.log('üß≠ Iniciando navega√ß√£o para parada:', {
                origem: `${state.currentLocation.lat}, ${state.currentLocation.lng}`,
                destino: `${lat}, ${lng}`,
                parada: stopNumber,
                endereco: address
            });

            try {
                // Criar controle de roteamento
                state.routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(state.currentLocation.lat, state.currentLocation.lng),
                        L.latLng(lat, lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    addWaypoints: false,
                    fitSelectedRoutes: true,
                    lineOptions: {
                        styles: [
                            {color: '#2563eb', opacity: 0.8, weight: 6}
                        ],
                        extendToWaypoints: true,
                        missingRouteTolerance: 0
                    },
                    createMarker: function() { return null; },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving',
                        timeout: 30000
                    }),
                    formatter: new L.Routing.Formatter({
                        language: 'pt',
                        units: 'metric',
                        unitNames: {
                            meters: 'm',
                            kilometers: 'km',
                            yards: 'yd',
                            miles: 'mi',
                            hours: 'h',
                            minutes: 'min',
                            seconds: 's'
                        }
                    })
                }).addTo(state.map);

                // Evento quando a rota √© calculada
                state.routingControl.on('routesfound', function(e) {
                    console.log('‚úÖ Rota encontrada:', e.routes);
                    const routes = e.routes;
                    state.currentRoute = routes[0];
                    const summary = routes[0].summary;
                    const distance = (summary.totalDistance / 1000).toFixed(2);
                    const time = Math.round(summary.totalTime / 60);

                    // Atualizar painel com dados da rota
                    document.getElementById('navDistance').textContent = `${distance} km`;
                    document.getElementById('navTime').textContent = `${time} min`;
                    document.getElementById('navStatus').textContent = 'üöó Navegando...';
                    document.getElementById('navStatus').className = 'nav-status';

                    // ZOOM INICIAL mais pr√≥ximo baseado na dist√¢ncia
                    let initialZoom = 19;
                    const distKm = parseFloat(distance);
                    if (distKm < 0.5) {
                        initialZoom = 19;
                    } else if (distKm < 2) {
                        initialZoom = 18;
                    } else if (distKm < 5) {
                        initialZoom = 17;
                    } else if (distKm < 10) {
                        initialZoom = 16;
                    } else {
                        initialZoom = 15;
                    }

                    // Aplicar zoom inicial
                    state.map.setZoom(initialZoom);
                    console.log(`üîç Zoom inicial definido para ${initialZoom} (dist√¢ncia: ${distance} km)`);

                    // Centralizar no ponto inicial (sua localiza√ß√£o)
                    state.map.setView([state.currentLocation.lat, state.currentLocation.lng], initialZoom, {
                        animate: true,
                        duration: 0.5
                    });

                    // Iniciar rastreamento GPS em tempo real
                    startGPSTracking();

                    // Fechar sidebar em mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });

                state.routingControl.on('routingerror', function(e) {
                    console.error('‚ùå Erro detalhado ao calcular rota:', e);

                    let errorMsg = 'N√£o foi poss√≠vel calcular a rota.';

                    if (e.error && e.error.status) {
                        if (e.error.status === 400) {
                            errorMsg = 'Coordenadas inv√°lidas. Verifique o endere√ßo.';
                        } else if (e.error.status === 404) {
                            errorMsg = 'N√£o foi poss√≠vel encontrar uma rota entre os pontos.';
                        } else if (e.error.status >= 500) {
                            errorMsg = 'Erro no servidor de rotas. Tente novamente.';
                        }
                    }

                    document.getElementById('navStatus').textContent = '‚ùå ' + errorMsg;
                    document.getElementById('navStatus').className = 'nav-status error';
                    showToast(errorMsg, 'error');

                    // Remover controle de roteamento em caso de erro
                    if (state.routingControl) {
                        state.map.removeControl(state.routingControl);
                        state.routingControl = null;
                    }
                    state.navigationActive = false;
                });

            } catch (error) {
                console.error('‚ùå Erro ao criar roteamento:', error);
                showToast('Erro ao iniciar navega√ß√£o: ' + error.message, 'error');
            }
        };

        // Update Marker Popup
        function updateMarkerPopup(client, marker) {
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.lat},${client.lng}`;

            const popupContent = `
                <div class="popup-content">
                    <h3>${client.name}</h3>
                    <p><strong>Endere√ßo:</strong><br>${client.address}</p>
                    <div class="popup-buttons">
                        <button class="popup-navigate-btn" onclick="startNavigation(${client.id})">
                            üß≠ Navegar pelo Mapa
                        </button>
                        <a href="${googleMapsUrl}" target="_blank" class="popup-route-btn">
                            üó∫Ô∏è Abrir no Google Maps
                        </a>
                        <div class="popup-actions">
                            <button class="popup-edit-btn" onclick="openEditModal(${client.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="popup-delete-btn" onclick="deleteClient(${client.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
        }

        // Edit Client
        window.openEditModal = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            state.editingClientId = clientId;

            // Populate form
            document.getElementById('editClientName').value = client.name;
            document.getElementById('editClientAddress').value = client.address;
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientBR').value = client.br || '';

            // Show modal
            document.getElementById('editClientModal').classList.add('active');
            document.getElementById('editClientName').focus();
        };

        // Update Client
        async function updateClient(clientId, newName, newAddress, newBR, newPhone) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            // Verificar se o usu√°rio est√° logado
            if (!state.currentUser || !state.currentUser.id) {
                showToast('Erro: Usu√°rio n√£o autenticado', 'error');
                return;
            }

            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .update({
                            name: newName,
                            address: newAddress,
                            br: newBR,
                            phone: newPhone
                        })
                        .eq('id', clientId)
                        .eq('user_id', state.currentUser.id);

                    if (error) throw error;

                    console.log(`‚úÖ Cliente atualizado no Supabase (user_id: ${state.currentUser.id})`);
                } catch (error) {
                    console.error('Erro ao atualizar cliente:', error);

                    // Mensagens de erro espec√≠ficas
                    let errorMessage = 'Erro ao atualizar cliente no banco de dados';

                    if (error.message && error.message.includes('column "phone"')) {
                        errorMessage = 'Erro: A coluna "phone" n√£o existe no banco de dados. Execute este SQL no Supabase:\nALTER TABLE clients ADD COLUMN phone TEXT;';
                    } else if (error.code === '42703') {
                        errorMessage = 'Erro: Coluna n√£o encontrada no banco de dados. Verifique a estrutura da tabela "clients" no Supabase.';
                    } else if (error.message) {
                        errorMessage = `Erro ao atualizar: ${error.message}`;
                    }

                    showToast(errorMessage, 'error');
                    console.error('üí° Detalhes do erro:', {
                        code: error.code,
                        message: error.message,
                        details: error.details,
                        hint: error.hint
                    });
                    return;
                }
            }

            // Update client data
            client.name = newName;
            client.address = newAddress;
            client.br = newBR;
            client.phone = newPhone;

            // Update marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                markerObj.marker.options.title = newName;
                updateMarkerPopup(client, markerObj.marker);
            }

            // Update list
            updateClientsList();
        }

        // Delete Client
        window.deleteClient = async function(clientId) {
            // Verificar se o usu√°rio est√° logado
            if (!state.currentUser || !state.currentUser.id) {
                showToast('Erro: Usu√°rio n√£o autenticado', 'error');
                return;
            }

            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .delete()
                        .eq('id', clientId)
                        .eq('user_id', state.currentUser.id);

                    if (error) throw error;

                    console.log(`‚úÖ Cliente exclu√≠do do Supabase (user_id: ${state.currentUser.id})`);
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showToast('Erro ao excluir cliente do banco de dados', 'error');
                    return;
                }
            }

            // Remove from array
            state.clients = state.clients.filter(c => c.id !== clientId);

            // Remove marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                state.map.removeLayer(markerObj.marker);
                state.clientMarkers = state.clientMarkers.filter(m => m.id !== clientId);
            }

            updateClientsList();
            showToast('Cliente exclu√≠do com sucesso!', 'success');
        };

        // Highlight search term in text
        function highlightText(text, query) {
            if (!query) return text;

            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight-text">$1</span>');
        }

        // Update Clients List
        function updateClientsList() {
            const listContainer = document.getElementById('clientsList');
            const countElement = document.getElementById('clientCount');
            const searchResultsInfo = document.getElementById('searchResultsInfo');

            countElement.textContent = `${state.clients.length} cliente${state.clients.length !== 1 ? 's' : ''} cadastrado${state.clients.length !== 1 ? 's' : ''}`;

            if (state.clients.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente cadastrado ainda</p>
                        <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                    </div>
                `;
                searchResultsInfo.textContent = '';
                return;
            }

            // Filter clients based on search query
            const query = state.searchQuery.toLowerCase().trim();
            const filteredClients = state.clients.filter(client => {
                if (!query) return true;

                const nameMatch = client.name.toLowerCase().includes(query);
                const addressMatch = client.address.toLowerCase().includes(query);

                return nameMatch || addressMatch;
            });

            // Update search results info
            if (query) {
                if (filteredClients.length === 0) {
                    searchResultsInfo.textContent = 'Nenhum resultado encontrado';
                } else if (filteredClients.length === 1) {
                    searchResultsInfo.textContent = '1 cliente encontrado';
                } else {
                    searchResultsInfo.textContent = `${filteredClients.length} clientes encontrados`;
                }
            } else {
                searchResultsInfo.textContent = '';
            }

            if (filteredClients.length === 0 && query) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente encontrado</p>
                        <p style="font-size: 12px; margin-top: 8px;">Tente outro termo de busca</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredClients.map(client => {
                const highlightedName = highlightText(client.name, query);
                const highlightedAddress = highlightText(client.address, query);
                const isHighlight = query ? 'highlight' : '';

                // Extrair apenas n√∫meros do telefone para links
                const phoneNumbers = client.phone ? client.phone.replace(/\D/g, '') : '';
                const whatsappLink = phoneNumbers ? `https://wa.me/55${phoneNumbers}` : '';
                const telLink = phoneNumbers ? `tel:+55${phoneNumbers}` : '';

                return `
                    <div class="client-item ${isHighlight}">
                        <div onclick="focusClient(${client.id})" style="flex: 1; cursor: pointer;">
                            <div class="client-name">üìç ${highlightedName}</div>
                            <div class="client-address">${highlightedAddress}</div>
                            ${client.phone ? `<div class="client-phone" style="font-size: 12px; color: #666; margin-top: 4px;">üìû ${client.phone}</div>` : ''}
                        </div>
                        ${phoneNumbers ? `
                            <div style="display: flex; gap: 8px; align-items: center; margin-left: 8px;">
                                <a href="${whatsappLink}" target="_blank" onclick="event.stopPropagation()"
                                   style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #25D366; border-radius: 50%; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                   title="Enviar WhatsApp">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                </a>
                                <a href="${telLink}" onclick="event.stopPropagation()"
                                   style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #3b82f6; border-radius: 50%; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                   title="Ligar">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="white">
                                        <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                                    </svg>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Focus on Client
        window.focusClient = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (client) {
                state.map.setView([client.lat, client.lng], 18);

                const markerObj = state.clientMarkers.find(m => m.id === clientId);
                if (markerObj) {
                    markerObj.marker.openPopup();
                }

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }
        };

        // QR Code Scanner Controls - OTIMIZADO
        const scanBtn = document.getElementById('scanBtn');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const processingOverlay = document.getElementById('processingOverlay');
        let cameraStream = null;
        let qrScanActive = false;
        let canvasContext = null;

        // Open/Close QR Scanner
        scanBtn.addEventListener('click', async () => {
            if (cameraStream) {
                // Close camera
                qrScanActive = false;
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraPreview.classList.remove('active');
                scanBtn.textContent = 'üì∑ Escanear QR Code';
                scanBtn.style.background = '';
            } else {
                // Open camera with optimized settings
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    cameraVideo.srcObject = cameraStream;
                    cameraPreview.classList.add('active');
                    scanBtn.textContent = '‚úñ Fechar C√¢mera';
                    scanBtn.style.background = '#ef4444';

                    // Initialize canvas context once
                    if (!canvasContext) {
                        canvasContext = cameraCanvas.getContext('2d', { willReadFrequently: true });
                    }

                    // Start optimized QR scanning
                    qrScanActive = true;
                    requestAnimationFrame(scanQRCode);
                } catch (error) {
                    console.error('Erro ao acessar c√¢mera:', error);
                    showToast('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.', 'error');
                }
            }
        });

        // ULTRA-FAST QR Code scanning with multi-scale detection
        function scanQRCode() {
            if (!qrScanActive || cameraVideo.readyState !== cameraVideo.HAVE_ENOUGH_DATA) {
                if (qrScanActive) requestAnimationFrame(scanQRCode);
                return;
            }

            const videoWidth = cameraVideo.videoWidth;
            const videoHeight = cameraVideo.videoHeight;

            // Try multiple scales for better detection (especially with low-quality QR codes)
            const scales = [0.6, 0.4]; // Try 60% then 40% if not found

            for (const scale of scales) {
                const width = Math.floor(videoWidth * scale);
                const height = Math.floor(videoHeight * scale);

                // Resize canvas only if needed
                if (cameraCanvas.width !== width || cameraCanvas.height !== height) {
                    cameraCanvas.width = width;
                    cameraCanvas.height = height;
                }

                // Apply image enhancements for better detection
                canvasContext.save();
                canvasContext.filter = 'contrast(1.2) brightness(1.1)';
                canvasContext.drawImage(cameraVideo, 0, 0, width, height);
                canvasContext.restore();

                // Get image data
                const imageData = canvasContext.getImageData(0, 0, width, height);

                // Scan with aggressive inversion attempts for damaged QR codes
                const code = jsQR(imageData.data, width, height, {
                    inversionAttempts: "attemptBoth" // Try both normal and inverted for damaged codes
                });

                if (code) {
                    console.log('‚úÖ QR Code detectado:', code.data);

                    // Strong visual feedback
                    cameraVideo.style.filter = 'brightness(1.5)';
                    setTimeout(() => { cameraVideo.style.filter = ''; }, 150);

                    // Vibrate
                    if ('vibrate' in navigator) {
                        navigator.vibrate([50, 30, 50]); // Double vibration pattern
                    }

                    // Fill BR field
                    document.getElementById('clientBR').value = code.data;

                    // Buscar endere√ßo na planilha automaticamente
                    const brCode = code.data.trim();
                    if (state.brDatabase[brCode]) {
                        document.getElementById('clientAddress').value = state.brDatabase[brCode];
                        showToast('‚úì QR Code lido! Endere√ßo preenchido automaticamente.', 'success');
                    } else {
                        showToast('‚úì QR Code lido! Endere√ßo n√£o encontrado na planilha.', 'warning');
                    }

                    // Close camera
                    qrScanActive = false;
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                    }
                    cameraPreview.classList.remove('active');
                    scanBtn.textContent = 'üì∑ Escanear QR Code';
                    scanBtn.style.background = '';
                    return;
                }
            }

            // Continue scanning immediately for maximum speed
            requestAnimationFrame(scanQRCode);
        }

        // Fun√ß√£o para formatar telefone
        function formatPhone(value) {
            // Remove tudo que n√£o √© n√∫mero
            const numbers = value.replace(/\D/g, '');

            // Limita a 11 d√≠gitos (DDD + 9 d√≠gitos)
            const limited = numbers.substring(0, 11);

            // Formata: (99) 99942-1942
            if (limited.length <= 2) {
                return limited;
            } else if (limited.length <= 7) {
                return `(${limited.substring(0, 2)}) ${limited.substring(2)}`;
            } else {
                return `(${limited.substring(0, 2)}) ${limited.substring(2, 7)}-${limited.substring(7)}`;
            }
        }

        // ========== EVENT LISTENERS - AUTENTICA√á√ÉO ==========

        // Login Form
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('Por favor, preencha todos os campos', 'warning');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Entrando...';

            const success = await login(username, password);

            // Sempre resetar o bot√£o
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';

            if (success) {
                loginForm.reset();
            }
        });

        // Register Form
        const registerForm = document.getElementById('registerForm');
        const registerBtn = document.getElementById('registerBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const loginContainer = document.getElementById('loginContainer');
        const registerContainer = document.getElementById('registerContainer');

        // Mostrar tela de cadastro
        showRegisterBtn.addEventListener('click', () => {
            loginContainer.classList.add('hidden');
            registerContainer.classList.remove('hidden');
        });

        // Voltar para tela de login
        showLoginBtn.addEventListener('click', () => {
            registerContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            registerForm.reset();
        });

        // Processar cadastro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (!name || !username || !password || !passwordConfirm) {
                showToast('Por favor, preencha todos os campos', 'warning');
                return;
            }

            if (password !== passwordConfirm) {
                showToast('As senhas n√£o coincidem', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('A senha deve ter no m√≠nimo 6 caracteres', 'warning');
                return;
            }

            registerBtn.disabled = true;
            registerBtn.textContent = 'Criando conta...';

            const success = await registerUser(name, username, password);

            if (success) {
                registerForm.reset();
                registerContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                // Preencher username no login
                document.getElementById('loginUsername').value = username;
                document.getElementById('loginPassword').focus();
            }

            registerBtn.disabled = false;
            registerBtn.textContent = 'Criar Conta';
        });

        // Logout Button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            logout();
        });

        // Open Admin Panel
        document.getElementById('openAdminBtn').addEventListener('click', () => {
            document.getElementById('adminPanel').classList.add('active');
            loadUsers();
        });

        // Close Admin Panel
        document.getElementById('closeAdminBtn').addEventListener('click', () => {
            document.getElementById('adminPanel').classList.remove('active');
        });

        // Add User Modal
        const addUserModal = document.getElementById('addUserModal');
        const addUserBtn = document.getElementById('addUserBtn');
        const cancelUserBtn = document.getElementById('cancelUserBtn');
        const userForm = document.getElementById('userForm');

        addUserBtn.addEventListener('click', () => {
            addUserModal.classList.add('active');
            document.getElementById('newUsername').focus();
        });

        cancelUserBtn.addEventListener('click', () => {
            addUserModal.classList.remove('active');
            userForm.reset();
        });

        addUserModal.addEventListener('click', (e) => {
            if (e.target === addUserModal) {
                addUserModal.classList.remove('active');
                userForm.reset();
            }
        });

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!name || !username || !password) {
                showToast('Por favor, preencha todos os campos', 'warning');
                return;
            }

            const success = await createUser(name, username, password, role);

            if (success) {
                addUserModal.classList.remove('active');
                userForm.reset();
            }
        });

        // Edit User Modal
        const editUserModal = document.getElementById('editUserModal');
        const cancelEditUserBtn = document.getElementById('cancelEditUserBtn');
        const editUserForm = document.getElementById('editUserForm');

        cancelEditUserBtn.addEventListener('click', () => {
            editUserModal.classList.remove('active');
            editUserForm.reset();
            state.editingUserId = null;
        });

        editUserModal.addEventListener('click', (e) => {
            if (e.target === editUserModal) {
                editUserModal.classList.remove('active');
                editUserForm.reset();
                state.editingUserId = null;
            }
        });

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('editUserName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;

            if (!name || !username) {
                showToast('Por favor, preencha o nome completo e nome de usu√°rio', 'warning');
                return;
            }

            if (state.editingUserId) {
                const success = await updateUser(state.editingUserId, name, username, password, role);

                if (success) {
                    editUserModal.classList.remove('active');
                    editUserForm.reset();
                    state.editingUserId = null;
                }
            }
        });

        // Add Client Modal Controls
        const addModal = document.getElementById('addClientModal');
        const addClientBtn = document.getElementById('addClientBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const clientForm = document.getElementById('clientForm');
        const clientPhoneInput = document.getElementById('clientPhone');
        const editClientPhoneInput = document.getElementById('editClientPhone');

        // Formata√ß√£o autom√°tica do telefone
        clientPhoneInput.addEventListener('input', (e) => {
            e.target.value = formatPhone(e.target.value);
        });

        editClientPhoneInput.addEventListener('input', (e) => {
            e.target.value = formatPhone(e.target.value);
        });

        addClientBtn.addEventListener('click', () => {
            if (!state.currentLocation) {
                showToast('Aguardando localiza√ß√£o...', 'warning');
                return;
            }

            addModal.classList.add('active');
            document.getElementById('clientName').focus();
        });

        cancelBtn.addEventListener('click', () => {
            // Fechar c√¢mera se estiver aberta
            qrScanActive = false;
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPreview.classList.remove('active');
            scanBtn.textContent = 'üì∑ Escanear QR Code';
            scanBtn.style.background = '';

            addModal.classList.remove('active');
            clientForm.reset();
        });

        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                // Fechar c√¢mera se estiver aberta
                qrScanActive = false;
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                cameraPreview.classList.remove('active');
                scanBtn.textContent = 'üì∑ Escanear QR Code';
                scanBtn.style.background = '';

                addModal.classList.remove('active');
                clientForm.reset();
            }
        });

        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddress').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const br = document.getElementById('clientBR').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            const client = await addClient(name, address, state.currentLocation.lat, state.currentLocation.lng, br, phone);

            if (!client) return; // Error already shown

            addModal.classList.remove('active');
            clientForm.reset();

            // Show success feedback
            showToast(`Cliente "${name}" adicionado com sucesso!`, 'success');
            const originalText = addClientBtn.textContent;
            addClientBtn.textContent = '‚úì';
            addClientBtn.style.background = '#10b981';
            setTimeout(() => {
                addClientBtn.textContent = originalText;
                addClientBtn.style.background = '';
            }, 1500);
        });

        // Edit Client Modal Controls
        const editModal = document.getElementById('editClientModal');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const editClientForm = document.getElementById('editClientForm');

        editCancelBtn.addEventListener('click', () => {
            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.remove('active');
                editClientForm.reset();
                state.editingClientId = null;
            }
        });

        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('editClientName').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const br = document.getElementById('editClientBR').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            if (state.editingClientId) {
                await updateClient(state.editingClientId, name, address, br, phone);
                showToast(`Cliente "${name}" atualizado com sucesso!`, 'success');
            }

            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            updateClientsList();

            // Show/hide clear button
            if (state.searchQuery) {
                clearSearchBtn.classList.add('visible');
            } else {
                clearSearchBtn.classList.remove('visible');
            }
        });

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            state.searchQuery = '';
            clearSearchBtn.classList.remove('visible');
            updateClientsList();
            searchInput.focus();
        });

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Toggle sidebar
        menuToggle.addEventListener('click', () => {
            const isOpen = sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active', isOpen);
            const userHeaderInfo = document.getElementById('userHeaderInfo');

            // Previne scroll do body quando sidebar est√° aberta
            if (isOpen) {
                document.body.style.overflow = 'hidden';
                // Oculta o banner de Admin/Sair
                if (userHeaderInfo) {
                    userHeaderInfo.style.opacity = '0';
                    userHeaderInfo.style.pointerEvents = 'none';
                }
            } else {
                document.body.style.overflow = '';
                // Mostra o banner de Admin/Sair
                if (userHeaderInfo) {
                    userHeaderInfo.style.opacity = '1';
                    userHeaderInfo.style.pointerEvents = 'auto';
                }
            }
        });

        // Close sidebar when clicking on overlay
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
            const userHeaderInfo = document.getElementById('userHeaderInfo');
            // Mostra o banner de Admin/Sair
            if (userHeaderInfo) {
                userHeaderInfo.style.opacity = '1';
                userHeaderInfo.style.pointerEvents = 'auto';
            }
        });

        // Close sidebar when clicking on map (mobile)
        document.getElementById('map').addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
                const userHeaderInfo = document.getElementById('userHeaderInfo');
                // Mostra o banner de Admin/Sair
                if (userHeaderInfo) {
                    userHeaderInfo.style.opacity = '1';
                    userHeaderInfo.style.pointerEvents = 'auto';
                }
            }
        });

        // State for route optimization
        state.routeData = [];  // Armazena dados da planilha para roteiriza√ß√£o
        state.uploadSessionId = null; // ID √∫nico da sess√£o de upload atual
        state.optimizedRoute = null;  // Rota otimizada pela IA
        state.routePolylines = [];  // Polylines da rota otimizada

        // Limpar e organizar endere√ßo - remove refer√™ncias ap√≥s o n√∫mero
        function cleanAddress(address) {
            if (!address) return '';

            // Remover espa√ßos extras
            let cleaned = address.trim();

            // Padr√£o: capturar at√© o n√∫mero e ignorar o resto
            // Exemplos que vai capturar:
            // "Rua X, 123" -> "Rua X, 123"
            // "Rua X, 123, Pr√≥ximo a..." -> "Rua X, 123"
            // "Alameda Y, 456, Casa branca" -> "Alameda Y, 456"

            // Regex: captura tudo at√© encontrar n√∫mero seguido de v√≠rgula ou fim de string
            const match = cleaned.match(/^([^,]+,\s*\d+[A-Za-z]?)/);

            if (match) {
                cleaned = match[1];
                console.log(`üßπ Endere√ßo limpo: "${address}" ‚Üí "${cleaned}"`);
            } else {
                // Se n√£o encontrou padr√£o "rua, n√∫mero", retorna original
                console.log(`‚ö†Ô∏è Formato n√£o padr√£o, usando original: "${address}"`);
            }

            return cleaned;
        }

        // Geocoding usando Nominatim (OpenStreetMap) - Funciona em qualquer ambiente web
        async function geocodeAddress(address, city = '', zipcode = '', bairro = '') {
            try {
                // LIMPAR endere√ßo antes de fazer geocoding (remove refer√™ncias)
                const cleanedAddress = cleanAddress(address);

                // Construir query completo com endere√ßo limpo
                let query = cleanedAddress;
                if (bairro) query += `, ${bairro}`;
                if (city) query += `, ${city}`;
                if (zipcode) query += `, ${zipcode}`;
                query += ', Brasil';

                console.log(`üîç Geocoding: ${query}`);

                // Usar Nominatim (OpenStreetMap) - API gratuita e funciona em qualquer lugar
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=br&addressdetails=1`;

                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'GPS-Navigation-App-Vercel'
                    }
                });

                if (!response.ok) {
                    console.warn(`‚ùå Geocoding falhou: HTTP ${response.status}`);
                    return null;
                }

                const results = await response.json();

                if (results && results.length > 0) {
                    const result = results[0];
                    console.log(`‚úÖ Geocoded: ${result.display_name}`);
                    return {
                        latitude: parseFloat(result.lat),
                        longitude: parseFloat(result.lon),
                        displayName: result.display_name,
                        confidence: result.importance || 0.5
                    };
                }

                console.warn(`‚ö†Ô∏è Nenhum resultado encontrado para: ${query}`);
                return null;

            } catch (error) {
                console.error('‚ùå Erro no geocoding:', error);
                return null;
            }
        }

        // Calculate distance between two coordinates (Haversine formula) in km
        function calculateDistanceBetweenCoords(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Use AI to validate and correct address coordinates
        async function validateAddressWithAI(item) {
            return new Promise((resolve, reject) => {
                const handlerName = `ai-geocode-${Date.now()}`;

                // Register handler for AI response
                window.Poe.registerHandler(handlerName, (result) => {
                    if (result.status === 'complete' && result.responses && result.responses.length > 0) {
                        const response = result.responses[0];
                        try {
                            // Parse JSON response from AI
                            const jsonMatch = response.content.match(/\{[\s\S]*"latitude"[\s\S]*"longitude"[\s\S]*\}/);
                            if (jsonMatch) {
                                const coords = JSON.parse(jsonMatch[0]);
                                if (coords.latitude && coords.longitude) {
                                    resolve({
                                        latitude: parseFloat(coords.latitude),
                                        longitude: parseFloat(coords.longitude)
                                    });
                                    return;
                                }
                            }
                            resolve(null);
                        } catch (error) {
                            console.error('Erro ao parsear resposta da IA:', error);
                            resolve(null);
                        }
                    } else if (result.status === 'error') {
                        resolve(null);
                    }
                });

                // Send request to AI
                const prompt = `Preciso validar e corrigir as coordenadas de um endere√ßo no Brasil.

Endere√ßo: ${item.address}
Bairro: ${item.bairro || 'n√£o informado'}
Cidade: ${item.city || 'n√£o informada'}
CEP: ${item.zipcode || 'n√£o informado'}
Coordenadas originais: ${item.originalLatitude}, ${item.originalLongitude}

Por favor, retorne APENAS um objeto JSON com as coordenadas corretas e precisas do endere√ßo (no ponto exato da rua e n√∫mero), no formato:
{"latitude": -23.550520, "longitude": -46.633308}

Se n√£o conseguir encontrar o endere√ßo exato, retorne {"latitude": null, "longitude": null}`;

                window.Poe.sendUserMessage(`@GPT-5.1 ${prompt}`, {
                    handler: handlerName,
                    stream: false,
                    openChat: false
                }).catch(error => {
                    console.error('Erro ao enviar mensagem para IA:', error);
                    resolve(null);
                });

                // Timeout de 30 segundos
                setTimeout(() => resolve(null), 30000);
            });
        }

        // Geocode all addresses usando Nominatim - Funciona em QUALQUER ambiente web
        async function geocodeAllAddresses(routeData, statusElement, sessionId) {
            let successCount = 0;
            let failedCount = 0;
            let usedFromSheet = 0;

            console.log(`üó∫Ô∏è Iniciando geocoding ULTRA-R√ÅPIDO de ${routeData.length} endere√ßos (user_id: ${state.currentUser?.id}, session: ${sessionId})...`);
            console.log(`‚ö° Processamento paralelo m√°ximo (15 requisi√ß√µes simult√¢neas)`);

            // Separar endere√ßos que j√° t√™m coordenadas (n√£o precisam geocoding)
            const needsGeocoding = [];
            const alreadyHasCoords = [];

            routeData.forEach(item => {
                if (item.latitude && item.longitude &&
                    !isNaN(parseFloat(item.latitude)) && !isNaN(parseFloat(item.longitude))) {
                    // J√° tem coordenadas v√°lidas na planilha
                    alreadyHasCoords.push(item);
                    item.addressCleaned = cleanAddress(item.address);
                    usedFromSheet++;
                } else {
                    needsGeocoding.push(item);
                }
            });

            console.log(`üìä ${alreadyHasCoords.length} endere√ßos j√° t√™m coordenadas (pulando geocoding)`);
            console.log(`üîç ${needsGeocoding.length} endere√ßos precisam de geocoding`);

            // Se todos j√° t√™m coordenadas, finalizar imediatamente
            if (needsGeocoding.length === 0) {
                console.log(`‚úÖ Todos os endere√ßos j√° t√™m coordenadas v√°lidas!`);
                statusElement.textContent = `‚úÖ ${routeData.length} endere√ßos prontos (usando planilha)`;
                showToast(`${usedFromSheet} endere√ßos carregados da planilha`, 'success');
                return;
            }

            // Processar em lotes de 15 endere√ßos simultaneamente (M√ÅXIMO DESEMPENHO)
            const BATCH_SIZE = 15;
            const DELAY_BETWEEN_BATCHES = 50; // Apenas 50ms entre lotes (ultra-r√°pido)

            for (let batchStart = 0; batchStart < needsGeocoding.length; batchStart += BATCH_SIZE) {
                // Verificar se esta sess√£o ainda √© v√°lida
                if (state.uploadSessionId !== sessionId) {
                    console.log(`‚ö†Ô∏è Sess√£o de upload cancelada ou substitu√≠da. Parando geocoding.`);
                    return;
                }

                const batchEnd = Math.min(batchStart + BATCH_SIZE, needsGeocoding.length);
                const batch = needsGeocoding.slice(batchStart, batchEnd);

                // Processar lote em paralelo (todas as 15 requisi√ß√µes ao mesmo tempo)
                const promises = batch.map(async (item, batchIndex) => {
                    const globalIndex = batchStart + batchIndex;

                    try {
                        // Fazer geocoding do endere√ßo
                        const geocoded = await geocodeAddress(item.address, item.city, item.zipcode, item.bairro);

                        if (geocoded) {
                            // Usar coordenadas do geocoding
                            item.latitude = geocoded.latitude;
                            item.longitude = geocoded.longitude;
                            item.geocodedAddress = geocoded.displayName;
                            item.addressCleaned = cleanAddress(item.address);
                            successCount++;
                            console.log(`‚úÖ [${globalIndex + 1}/${needsGeocoding.length}] ${item.addressCleaned}`);
                        } else {
                            console.error(`‚ùå [${globalIndex + 1}/${needsGeocoding.length}] Falha: ${item.address}`);
                            failedCount++;
                        }
                    } catch (error) {
                        console.error(`‚ùå [${globalIndex + 1}/${needsGeocoding.length}] Erro: ${item.address}`, error);
                        failedCount++;
                    }
                });

                // Aguardar conclus√£o do lote
                await Promise.all(promises);

                // Atualizar progresso
                const processed = Math.min(batchEnd, needsGeocoding.length);
                const totalProcessed = alreadyHasCoords.length + processed;
                const userInfo = state.currentUser ? ` [${state.currentUser.username}]` : '';
                statusElement.textContent = `Geocoding${userInfo}... ${totalProcessed}/${routeData.length} (‚úÖ ${successCount} | ‚ùå ${failedCount} | üìã ${usedFromSheet})`;

                // Delay m√≠nimo entre lotes
                if (batchEnd < needsGeocoding.length) {
                    await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_BATCHES));
                }
            }

            console.log(`\n=== RESUMO DO GEOCODING ===`);
            console.log(`‚úÖ ${successCount} endere√ßos geocodificados com sucesso`);
            console.log(`üìã ${usedFromSheet} endere√ßos usando coordenadas da planilha`);
            console.log(`‚ùå ${failedCount} endere√ßos falharam completamente`);
            console.log(`üìç Total processado: ${routeData.length}`);

            if (successCount > 0) {
                showToast(`Geocoding conclu√≠do: ${successCount} novos, ${usedFromSheet} da planilha`, 'success');
            } else if (usedFromSheet > 0) {
                showToast(`Usando ${usedFromSheet} coordenadas da planilha`, 'info');
            }

            if (failedCount > 0) {
                showToast(`Aten√ß√£o: ${failedCount} endere√ßos n√£o puderam ser localizados`, 'warning');
            }

            return; // Geocoding completo
        }

        // Upload Excel Spreadsheet
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadInput = document.getElementById('uploadInput');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadBtn.addEventListener('click', () => {
            uploadInput.click();
        });

        uploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Verificar se o usu√°rio est√° logado
            if (!state.currentUser || !state.currentUser.id) {
                showToast('Erro: Usu√°rio n√£o autenticado', 'error');
                uploadStatus.textContent = '‚ùå Usu√°rio n√£o autenticado';
                uploadStatus.className = 'upload-status';
                uploadInput.value = '';
                return;
            }

            // Gerar ID √∫nico para esta sess√£o de upload
            const sessionId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            state.uploadSessionId = sessionId;

            uploadStatus.textContent = 'Processando planilha...';
            uploadStatus.className = 'upload-status';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                // Limpar base de dados anterior
                state.brDatabase = {};
                state.routeData = [];  // Limpar dados de rota anterior

                let count = 0;

                // Processar cada linha da planilha
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];

                    // Procurar pelas colunas BR e Endere√ßo (aceita v√°rios formatos)
                    let brCode = null;
                    let address = null;

                    // Buscar coluna de c√≥digo BR
                    if (row['SPX TN']) {
                        brCode = String(row['SPX TN']).trim();
                    } else if (row['BR']) {
                        brCode = String(row['BR']).trim();
                    } else if (row['C√≥digo BR']) {
                        brCode = String(row['C√≥digo BR']).trim();
                    } else if (row['Codigo BR']) {
                        brCode = String(row['Codigo BR']).trim();
                    } else if (row['Code']) {
                        brCode = String(row['Code']).trim();
                    }

                    // Buscar coluna de endere√ßo
                    if (row['Destination Address']) {
                        address = String(row['Destination Address']).trim();
                    } else if (row['Endere√ßo']) {
                        address = String(row['Endere√ßo']).trim();
                    } else if (row['Endereco']) {
                        address = String(row['Endereco']).trim();
                    } else if (row['Address']) {
                        address = String(row['Address']).trim();
                    }

                    // Buscar latitude e longitude
                    let lat = row['Latitude'] || row['latitude'] || row['LAT'] || row['lat'];
                    let lng = row['Longitude'] || row['longitude'] || row['LNG'] || row['lng'] || row['LON'] || row['lon'];

                    // Se encontrou ambos, adicionar ao banco de dados
                    if (brCode && address && brCode !== 'undefined' && address !== 'undefined') {
                        state.brDatabase[brCode] = address;
                        count++;

                        // Usar coordenadas da planilha como fallback
                        // Se geocoding com IA estiver dispon√≠vel, ser√° substitu√≠do
                        state.routeData.push({
                            sequence: row['Sequence'] || i + 1,
                            stop: row['Stop'] || row['Parada'] || i + 1,
                            spxTn: brCode,
                            address: address,  // Endere√ßo original completo (com refer√™ncias)
                            addressOriginal: address,  // Guardar original
                            bairro: row['Bairro'] || row['Neighborhood'] || '',
                            city: row['City'] || row['Cidade'] || '',
                            zipcode: row['Zipcode/Postal code'] || row['CEP'] || '',
                            latitude: (lat && lng && !isNaN(lat)) ? parseFloat(lat) : null,
                            longitude: (lat && lng && !isNaN(lng)) ? parseFloat(lng) : null,
                            needsGeocoding: true
                        });
                    }
                }

                if (count > 0) {
                    // Fazer geocoding de todos os endere√ßos (IGNORA coordenadas da planilha)
                    uploadStatus.textContent = 'Buscando coordenadas precisas dos endere√ßos...';
                    await geocodeAllAddresses(state.routeData, uploadStatus, sessionId);

                    // Filtrar apenas endere√ßos que foram geocodificados com sucesso
                    const validRouteData = state.routeData.filter(item =>
                        item.latitude !== null &&
                        item.latitude !== undefined &&
                        item.longitude !== null &&
                        item.longitude !== undefined
                    );

                    console.log(`üìç ${validRouteData.length} de ${state.routeData.length} endere√ßos geocodificados com sucesso`);

                    if (validRouteData.length === 0) {
                        uploadStatus.textContent = '‚ùå Nenhum endere√ßo p√¥de ser geocodificado';
                        uploadStatus.className = 'upload-status';
                        showToast('Erro: N√£o foi poss√≠vel geocodificar nenhum endere√ßo. Verifique sua conex√£o ou tente novamente.', 'error');
                        return;
                    }

                    // Cada endere√ßo da planilha √© uma parada individual
                    state.routeData = validRouteData.map(item => ({
                        ...item,
                        packages: [item.spxTn],
                        sequences: [item.sequence],
                        packageCount: 1
                    }));

                    // Salvar no Supabase
                    uploadStatus.textContent = 'Salvando no banco de dados...';
                    await saveBRDatabaseToSupabase(state.brDatabase);
                    await saveRouteDataToSupabase(state.routeData);

                    const totalPackages = state.routeData.reduce((sum, item) => sum + item.packageCount, 0);
                    uploadStatus.textContent = `‚úì ${count} c√≥digos BR carregados! ${state.routeData.length} endere√ßos, ${totalPackages} pacotes.`;
                    uploadStatus.className = 'upload-status success';

                    console.log(`üìä Planilha processada e salva (user_id: ${state.currentUser.id}) - ISOLAMENTO ATIVO`);

                    // Mostrar bot√£o de roteiriza√ß√£o se tiver dados com coordenadas
                    if (state.routeData.length > 0) {
                        document.getElementById('optimizeRouteBtn').style.display = 'block';
                        console.log(`üó∫Ô∏è ${state.routeData.length} endere√ßos prontos para roteiriza√ß√£o`);
                        console.log(`üì¶ Total de pacotes: ${totalPackages}`);
                    }
                } else {
                    uploadStatus.textContent = '‚ö† Nenhum c√≥digo encontrado';
                    uploadStatus.className = 'upload-status';
                    showToast('Nenhum c√≥digo BR encontrado. Verifique se a planilha tem as colunas "SPX TN" e "Destination Address".', 'warning');
                }

                console.log('üìä Base de dados BR carregada:', state.brDatabase);
                console.log(`üìä Total de c√≥digos: ${count}`);
                console.log('üìç Dados de rota agrupados:', state.routeData);

            } catch (error) {
                console.error('‚ùå Erro ao processar planilha:', error);
                console.error('Stack:', error.stack);
                uploadStatus.textContent = `‚ùå Erro: ${error.message}`;
                uploadStatus.className = 'upload-status';
                showToast(`Erro ao processar planilha: ${error.message}`, 'error');
            }

            // Limpar input
            uploadInput.value = '';
        });

        // AI Route Optimization
        const optimizeRouteBtn = document.getElementById('optimizeRouteBtn');
        const routeStatus = document.getElementById('routeStatus');

        optimizeRouteBtn.addEventListener('click', async () => {
            if (state.routeData.length === 0) {
                showToast('Nenhum dado de rota dispon√≠vel. Fa√ßa upload de uma planilha primeiro.', 'warning');
                return;
            }

            // Parar navega√ß√£o ativa antes de otimizar rota
            if (state.navigationActive) {
                console.log('‚èπÔ∏è Parando navega√ß√£o ativa antes de roteirizar');
                stopRealtimeNavigation();
            }

            routeStatus.textContent = 'ü§ñ Processando roteiriza√ß√£o...';
            routeStatus.className = 'upload-status';
            optimizeRouteBtn.disabled = true;

            try {
                // Verificar se Poe API est√° dispon√≠vel
                if (window.Poe && typeof window.Poe.registerHandler === 'function') {
                    // Usar IA do Poe se dispon√≠vel
                    await optimizeRouteWithAI();
                } else {
                    // Usar algoritmo local (Nearest Neighbor)
                    console.log('üîß Poe API n√£o dispon√≠vel, usando algoritmo local');
                    const optimizedOrder = optimizeRouteLocally(state.routeData);
                    processOptimizedRoute(optimizedOrder);
                    routeStatus.textContent = `‚úì Rota otimizada! ${optimizedOrder.length} paradas.`;
                    routeStatus.className = 'upload-status success';
                    showToast(`Rota otimizada com sucesso! ${optimizedOrder.length} paradas.`, 'success');
                    optimizeRouteBtn.disabled = false;
                }

            } catch (error) {
                console.error('Erro ao iniciar roteiriza√ß√£o:', error);
                routeStatus.textContent = '‚ùå Erro ao iniciar roteiriza√ß√£o';
                routeStatus.className = 'upload-status';
                showToast('Erro ao iniciar roteiriza√ß√£o: ' + error.message, 'error');
                optimizeRouteBtn.disabled = false;
            }
        });

        // Optimize Route with AI (Poe API)
        async function optimizeRouteWithAI() {
            // Preparar dados para enviar √† IA
            const routeDataStr = JSON.stringify(state.routeData.map((stop, idx) => ({
                index: idx,
                stop: stop.stop,
                address: stop.address,
                city: stop.city,
                latitude: stop.latitude,
                longitude: stop.longitude
            })));

            // Registrar handler para receber resposta da IA
            window.Poe.registerHandler("route-optimizer", (result, context) => {
                const msg = result.responses[0];

                if (msg.status === "error") {
                    routeStatus.textContent = "‚ùå Erro na IA: " + msg.statusText;
                    routeStatus.className = 'upload-status';
                    optimizeRouteBtn.disabled = false;
                    showToast('Erro ao processar roteiriza√ß√£o com IA', 'error');
                } else if (msg.status === "complete") {
                    try {
                        // Extrair JSON da resposta
                        const content = msg.content;
                        console.log('ü§ñ Resposta da IA:', content);

                        // Procurar por JSON na resposta (pode vir com texto explicativo)
                        const jsonMatch = content.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            const optimizedOrder = JSON.parse(jsonMatch[0]);
                            processOptimizedRoute(optimizedOrder);
                            routeStatus.textContent = `‚úì Rota otimizada com IA! ${optimizedOrder.length} paradas.`;
                            routeStatus.className = 'upload-status success';
                            showToast(`Rota otimizada com IA! ${optimizedOrder.length} paradas.`, 'success');
                        } else {
                            throw new Error('Resposta da IA n√£o cont√©m JSON v√°lido');
                        }
                    } catch (error) {
                        console.error('Erro ao processar resposta da IA:', error);
                        routeStatus.textContent = '‚ùå Erro ao processar resposta';
                        routeStatus.className = 'upload-status';
                        showToast('Erro ao processar resposta da IA', 'error');
                    }
                    optimizeRouteBtn.disabled = false;
                }
            });

            // Chamar IA para otimizar rota
            const prompt = `Voc√™ √© um especialista em otimiza√ß√£o de rotas de entrega. Analise os seguintes endere√ßos com suas coordenadas e retorne a ORDEM OTIMIZADA de paradas que minimiza a dist√¢ncia total percorrida.

DADOS DAS PARADAS:
${routeDataStr}

INSTRU√á√ïES:
1. Use o algoritmo de vizinho mais pr√≥ximo (Nearest Neighbor) ou similar para otimizar
2. Considere apenas as coordenadas (latitude/longitude) para calcular dist√¢ncias
3. Retorne APENAS um array JSON com os √≠ndices na ordem otimizada
4. Exemplo de resposta: [0, 5, 3, 1, 4, 2]
5. N√ÉO adicione explica√ß√µes ou texto adicional, APENAS o array JSON

Retorne a ordem otimizada:`;

            await window.Poe.sendUserMessage(`@Claude-Sonnet-4.5 ${prompt}`, {
                handler: "route-optimizer",
                stream: false,
                openChat: false
            });
        }

        // Optimize Route Locally (Nearest Neighbor Algorithm)
        function optimizeRouteLocally(routeData) {
            if (routeData.length === 0) return [];
            if (routeData.length === 1) return [0];

            // Fun√ß√£o para calcular dist√¢ncia entre dois pontos (Haversine)
            function getDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Raio da Terra em km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            // Usar posi√ß√£o atual como ponto de partida se dispon√≠vel
            let currentLat, currentLng;
            if (state.currentLocation) {
                currentLat = state.currentLocation.lat;
                currentLng = state.currentLocation.lng;
            } else {
                // Usar primeira parada como ponto de partida
                currentLat = routeData[0].latitude;
                currentLng = routeData[0].longitude;
            }

            const unvisited = new Set(routeData.map((_, idx) => idx));
            const route = [];

            // Algoritmo do vizinho mais pr√≥ximo
            while (unvisited.size > 0) {
                let nearestIndex = -1;
                let nearestDistance = Infinity;

                // Encontrar o ponto n√£o visitado mais pr√≥ximo
                for (const idx of unvisited) {
                    const stop = routeData[idx];
                    const distance = getDistance(
                        currentLat, currentLng,
                        stop.latitude, stop.longitude
                    );

                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestIndex = idx;
                    }
                }

                // Adicionar √† rota e marcar como visitado
                route.push(nearestIndex);
                unvisited.delete(nearestIndex);

                // Atualizar posi√ß√£o atual
                currentLat = routeData[nearestIndex].latitude;
                currentLng = routeData[nearestIndex].longitude;
            }

            console.log('üó∫Ô∏è Rota otimizada localmente:', route);
            return route;
        }

        // Process Optimized Route from AI
        function processOptimizedRoute(optimizedOrder) {
            // Ativar modo de visualiza√ß√£o de rota otimizada
            state.viewingOptimizedRoute = true;

            // Armazenar ordem otimizada no estado
            state.optimizedOrder = optimizedOrder;

            // Salvar rota otimizada no Supabase
            saveOptimizedRouteToSupabase(optimizedOrder);

            // Fechar TODOS os popups, incluindo o "Voc√™ est√° aqui"
            state.map.closePopup();
            if (state.currentLocationMarker) {
                state.currentLocationMarker.closePopup();
            }

            // Limpar marcadores e polylines anteriores da rota otimizada
            state.routePolylines.forEach(polyline => state.map.removeLayer(polyline));
            state.routePolylines = [];

            // Detectar se √© mobile para otimiza√ß√µes
            const isMobile = window.innerWidth <= 768;

            // Criar marcadores numerados para cada parada na ordem otimizada
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];

            // Decidir tipo de marcador: √≠cones bonitos para poucas paradas, simples para muitas
            const totalStops = optimizedOrder.length;
            const usePrettyIcons = !isMobile || totalStops <= 10;  // Reduzido de 20 para 10

            console.log(`üé® Renderizando ${totalStops} paradas - Modo: ${isMobile ? 'MOBILE' : 'DESKTOP'} - √çcones: ${usePrettyIcons ? 'BONITOS ‚ú®' : 'SIMPLES ‚ö°'}`);

            // Detectar e deslocar marcadores sobrepostos
            const offsetMap = new Map(); // Mapa para rastrear deslocamentos
            const OVERLAP_THRESHOLD = 0.00005; // ~5 metros (ajust√°vel)
            const OFFSET_AMOUNT = 0.0001; // ~11 metros de deslocamento

            function getAdjustedCoordinates(lat, lng, index) {
                let adjustedLat = lat;
                let adjustedLng = lng;

                // Verificar se h√° marcadores muito pr√≥ximos j√° adicionados
                for (const [key, offset] of offsetMap.entries()) {
                    const [existingLat, existingLng] = key.split('_').map(Number);
                    const latDiff = Math.abs(existingLat - adjustedLat);
                    const lngDiff = Math.abs(existingLng - adjustedLng);

                    // Se estiver muito pr√≥ximo, aplicar offset
                    if (latDiff < OVERLAP_THRESHOLD && lngDiff < OVERLAP_THRESHOLD) {
                        // Aplicar deslocamento em c√≠rculo baseado no n√∫mero de offsets j√° aplicados
                        const angle = (offset.count * 60) * (Math.PI / 180); // 60 graus entre cada marcador
                        adjustedLat = existingLat + (OFFSET_AMOUNT * Math.cos(angle));
                        adjustedLng = existingLng + (OFFSET_AMOUNT * Math.sin(angle));
                        offset.count++;
                        console.log(`üìç Marcador ${index + 1} deslocado para evitar sobreposi√ß√£o`);
                        break;
                    }
                }

                // Registrar a posi√ß√£o ajustada
                const key = `${adjustedLat}_${adjustedLng}`;
                if (!offsetMap.has(key)) {
                    offsetMap.set(key, { count: 1 });
                }

                return [adjustedLat, adjustedLng];
            }

            optimizedOrder.forEach((originalIndex, routeIndex) => {
                const stop = state.routeData[originalIndex];
                if (!stop) return;

                // Obter coordenadas ajustadas para evitar sobreposi√ß√£o
                const [adjustedLat, adjustedLng] = getAdjustedCoordinates(
                    stop.latitude,
                    stop.longitude,
                    routeIndex
                );

                const stopNumber = routeIndex + 1;
                const isDelivered = state.deliveredStops.has(routeIndex);
                const color = isDelivered ? '#9ca3af' : colors[routeIndex % colors.length]; // Cinza se entregue
                const packageCount = stop.packageCount || 1;

                // Mobile com MUITAS paradas: usar CircleMarker simples (m√°xima performance)
                if (isMobile && !usePrettyIcons) {
                    const circleMarker = L.circleMarker([adjustedLat, adjustedLng], {
                        radius: 12,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: isDelivered ? 0.6 : 1,
                        fillOpacity: isDelivered ? 0.5 : 0.9
                    }).addTo(state.map);

                    // Popup lazy-loaded com info de pacotes e bot√£o de navega√ß√£o
                    circleMarker.on('click', function() {
                        const sequencesList = stop.sequences && stop.sequences.length > 0
                            ? stop.sequences.sort((a, b) => a - b).join(', ')
                            : '-';
                        const currentlyDelivered = state.deliveredStops.has(routeIndex);

                        this.bindPopup(`
                            <div style="font-size: 13px; min-width: 200px;">
                                <div style="font-weight: bold; margin-bottom: 6px; color: ${color};">
                                    ${currentlyDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber} ‚Ä¢ ${packageCount} pacote${packageCount > 1 ? 's' : ''}
                                </div>
                                <div style="margin: 3px 0;">üìç ${stop.address}</div>
                                <div style="margin: 3px 0; font-size: 11px; color: #666;">Ordem: ${sequencesList}</div>
                                ${!currentlyDelivered ? `
                                    <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                        style="margin-top: 8px; width: 100%; padding: 8px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                        ‚úÖ Marcar como entregue
                                    </button>
                                ` : `
                                    <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                        style="margin-top: 8px; width: 100%; padding: 8px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                        ‚Ü©Ô∏è Desfazer entrega
                                    </button>
                                `}
                                <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                                    style="margin-top: 6px; width: 100%; padding: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px;">
                                    üß≠ Navegar at√© aqui
                                </button>
                            </div>
                        `).openPopup();
                    });

                    state.routePolylines.push(circleMarker);
                    return; // Pula resto do c√≥digo
                }

                // PINO DE GPS com numera√ß√£o de pacotes no topo (Desktop OU Mobile com poucas paradas)
                // CSS simplificado para mobile: menos sombras e bordas
                const iconHTML = `
                    <div style="position: relative; width: 40px; height: ${packageCount > 1 ? '55px' : '40px'};">
                        ${packageCount > 1 ? `
                            <div style="
                                position: absolute;
                                top: -10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: #ef4444;
                                color: white;
                                border-radius: ${isMobile ? '8px' : '12px'};
                                padding: 2px ${isMobile ? '6px' : '8px'};
                                font-size: ${isMobile ? '10px' : '11px'};
                                font-weight: bold;
                                border: ${isMobile ? '1px' : '2px'} solid white;
                                box-shadow: ${isMobile ? '0 1px 3px rgba(0,0,0,0.3)' : '0 2px 6px rgba(0,0,0,0.3)'};
                                white-space: nowrap;
                                z-index: 10;
                            ">
                                ${packageCount} pacote${packageCount > 1 ? 's' : ''}
                            </div>
                        ` : ''}
                        <div style="
                            position: relative;
                            width: ${isMobile ? '32px' : '36px'};
                            height: ${isMobile ? '32px' : '36px'};
                            background: ${color};
                            border-radius: 50% 50% 50% 0;
                            border: ${isMobile ? '2px' : '3px'} solid white;
                            box-shadow: ${isMobile ? '0 2px 5px rgba(0,0,0,0.35)' : '0 3px 8px rgba(0,0,0,0.4)'};
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transform: rotate(-45deg);
                            margin: ${packageCount > 1 ? '18px' : '0'} auto 0 auto;
                        ">
                            <div style="
                                transform: rotate(45deg);
                                color: white;
                                font-weight: bold;
                                font-size: ${isMobile ? '13px' : '16px'};
                            ">
                                ${stopNumber}
                            </div>
                        </div>
                    </div>
                `;

                const numberedIcon = L.divIcon({
                    className: 'numbered-marker',
                    html: iconHTML,
                    iconSize: packageCount > 1 ? [40, 55] : [40, 40],
                    iconAnchor: packageCount > 1 ? [20, 55] : [20, 40]
                });

                // Adicionar marcador com coordenadas ajustadas
                const marker = L.marker([adjustedLat, adjustedLng], {
                    icon: numberedIcon,
                    title: `Parada ${stopNumber}: ${stop.address}`
                }).addTo(state.map);

                // Preparar lista completa de sequences (sem abrevia√ß√£o)
                const sequencesList = stop.sequences && stop.sequences.length > 0
                    ? stop.sequences.sort((a, b) => a - b).join(', ')
                    : stop.sequence || '-';

                // Preparar lista de pacotes (mais limitada para mobile)
                const packagesList = stop.packages && stop.packages.length > 0
                    ? (stop.packages.length <= (isMobile ? 5 : 10)
                        ? stop.packages.join(', ')
                        : `${stop.packages.slice(0, isMobile ? 5 : 10).join(', ')}... (+${stop.packages.length - (isMobile ? 5 : 10)})`)
                    : stop.spxTn || '-';

                // Calcular dist√¢ncia e tempo da localiza√ß√£o atual at√© esta parada
                let distanceInfo = '';
                if (state.currentLocationMarker) {
                    const currentPos = state.currentLocationMarker.getLatLng();
                    const distKm = calculateDistance(currentPos.lat, currentPos.lng, stop.latitude, stop.longitude);
                    const estTime = calculateEstimatedTime(distKm);
                    distanceInfo = `<p style="margin: 4px 0; padding: 6px; background: #eff6ff; border-radius: 4px; font-size: ${isMobile ? '11px' : '12px'};"><strong>üöó Dist√¢ncia:</strong> ${formatDistance(distKm)} ¬∑ <strong>‚è±Ô∏è</strong> ${estTime}</p>`;
                }

                // Popup simplificado para mobile
                const popupContent = isMobile ? `
                    <div class="popup-content" style="max-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 16px;">${isDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber}</h3>
                        ${distanceInfo}
                        <p style="margin: 4px 0;"><strong>üì¶ Pacotes:</strong> ${packageCount}</p>
                        <p style="margin: 4px 0;"><strong>üî¢ Ordem:</strong> ${sequencesList}</p>
                        <p style="margin: 4px 0;"><strong>üìç</strong> ${stop.address}</p>
                        ${stop.city ? `<p style="margin: 4px 0; font-size: 12px;"><strong>üèôÔ∏è</strong> ${stop.city}</p>` : ''}
                        ${!isDelivered ? `
                            <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                                ‚úÖ Marcar como entregue
                            </button>
                        ` : `
                            <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                style="margin-top: 10px; width: 100%; padding: 10px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                                ‚Ü©Ô∏è Desfazer entrega
                            </button>
                        `}
                        <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                            style="margin-top: 6px; width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                            üß≠ Navegar at√© aqui
                        </button>
                    </div>
                ` : `
                    <div class="popup-content">
                        <h3>${isDelivered ? '‚úÖ' : 'üöö'} Parada ${stopNumber}</h3>
                        ${distanceInfo}
                        <p><strong>üì¶ Pacotes:</strong> ${packageCount}</p>
                        <p><strong>üî¢ Ordem:</strong><br><span style="font-size: 12px; color: #666;">${sequencesList}</span></p>
                        <p><strong>üìç Endere√ßo:</strong><br>${stop.address}</p>
                        <p><strong>üèôÔ∏è Cidade:</strong> ${stop.city}</p>
                        <p><strong>üìÆ CEP:</strong> ${stop.zipcode}</p>
                        <p><strong>üì¶ C√≥digos SPX:</strong><br><span style="font-size: 11px; color: #666;">${packagesList}</span></p>
                        ${!isDelivered ? `
                            <button onclick="markStopAsDelivered(${routeIndex}, ${JSON.stringify(stop).replace(/"/g, '&quot;')})"
                                style="margin-top: 12px; width: 100%; padding: 10px; background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ‚úÖ Marcar como entregue
                            </button>
                        ` : `
                            <button onclick="unmarkStopAsDelivered(${routeIndex})"
                                style="margin-top: 12px; width: 100%; padding: 10px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                ‚Ü©Ô∏è Desfazer entrega
                            </button>
                        `}
                        <button onclick="startNavigationToStop(${stop.latitude}, ${stop.longitude}, '${stop.address.replace(/'/g, "\\'")}', ${stopNumber})"
                            style="margin-top: 8px; width: 100%; padding: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            üß≠ Navegar at√© aqui
                        </button>
                    </div>
                `;

                marker.bindPopup(popupContent);

                // Armazenar para limpar depois
                state.routePolylines.push(marker);

                // Desenhar linha para a pr√≥xima parada (sempre desenhar para mostrar a rota otimizada)
                if (routeIndex < optimizedOrder.length - 1) {
                    const nextStop = state.routeData[optimizedOrder[routeIndex + 1]];
                    if (nextStop) {
                        const polyline = L.polyline([
                            [stop.latitude, stop.longitude],
                            [nextStop.latitude, nextStop.longitude]
                        ], {
                            color: color,
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '10, 5'
                        }).addTo(state.map);

                        state.routePolylines.push(polyline);
                    }
                }
            });

            // Ajustar zoom e centralizar mapa para mostrar toda a rota
            if (optimizedOrder.length > 0) {
                const bounds = L.latLngBounds(
                    optimizedOrder.map(idx => [state.routeData[idx].latitude, state.routeData[idx].longitude])
                );

                // Ajustar mapa com delay para garantir que todos os marcadores foram renderizados
                setTimeout(() => {
                    console.log('üìç Ajustando visualiza√ß√£o para mostrar rota otimizada');
                    state.map.fitBounds(bounds, {
                        padding: isMobile ? [50, 50] : [100, 100],
                        maxZoom: isMobile ? 15 : 16,
                        animate: true,
                        duration: 1.0
                    });
                }, 600);  // Delay para garantir que stopRealtimeNavigation completou
            }

            // Armazenar rota otimizada
            state.optimizedRoute = optimizedOrder;

            // Atualizar contador de entregas
            updateDeliveryCounter();

            // Fechar aba lateral em mobile para melhor visualiza√ß√£o
            const sidebar = document.querySelector('.sidebar');
            if (sidebar && sidebar.classList.contains('open') && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }

            console.log('‚úÖ Rota otimizada processada e exibida no mapa');
            console.log(`üìç Visualizando ${optimizedOrder.length} paradas no mapa`);
        }

        // Initialize App
        (async () => {
            const hasSession = await checkSession();
            if (!hasSession) {
                // Mostrar tela de login
                document.getElementById('loginContainer').classList.remove('hidden');
                hideLoading();
            } else {
                // Usu√°rio j√° logado, iniciar app
                getCurrentLocation();
            }
        })();
    </script>
</body>
</html>
