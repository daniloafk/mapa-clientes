<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Clientes - Geolocaliza√ß√£o</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" >

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" >

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        .dark {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Search Box */
        .search-container {
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
            font-size: 16px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 38px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .clear-search {
            position: absolute;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            display: none;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }

        .clear-search:hover {
            color: var(--text-primary);
        }

        .clear-search.visible {
            display: block;
        }

        .search-results-info {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .upload-section {
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .upload-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .upload-input {
            display: none;
        }

        .upload-status {
            margin-top: 8px;
            font-size: 12px;
            text-align: center;
            color: var(--text-secondary);
        }

        .upload-status.success {
            color: var(--success);
            font-weight: 600;
        }

        .clients-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .client-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-item:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .client-item.hidden {
            display: none;
        }

        .client-item.highlight {
            border-color: var(--primary);
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%);
        }

        .highlight-text {
            background: rgba(37, 99, 235, 0.2);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }

        .client-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .client-address {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .client-coords {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 100vh;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            border: none;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s;
            z-index: 1000;
        }

        .fab:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .menu-toggle svg {
            width: 24px;
            height: 24px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .camera-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .scan-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .scan-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .camera-preview {
            margin-top: 16px;
            display: none;
            position: relative;
        }

        .camera-preview.active {
            display: block;
        }

        .camera-preview video,
        .camera-preview canvas {
            width: 100%;
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        .camera-preview canvas {
            display: none;
        }

        .capture-btn {
            margin-top: 12px;
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .processing-text {
            font-size: 18px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .coords-display {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Leaflet Custom Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        /* Leaflet Routing Machine Customization */
        .leaflet-routing-container {
            display: none !important; /* Ocultar banner de navega√ß√£o */
        }

        .leaflet-routing-container h2,
        .leaflet-routing-container h3 {
            color: var(--text-primary);
        }

        .leaflet-routing-alt {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .leaflet-routing-alt:hover {
            background: var(--bg-primary);
        }

        .leaflet-routing-alt-minimized {
            background: var(--primary);
            color: white;
            border-radius: 8px;
        }

        .leaflet-routing-icon {
            color: var(--text-primary);
        }

        .leaflet-routing-geocoders {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
        }

        .leaflet-routing-geocoder input {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
        }

        .popup-navigate-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .popup-navigate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Navigation Panel - Real-time GPS */
        .navigation-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 1500;
            min-width: 300px;
            display: none;
            animation: slideInRight 0.3s;
        }

        .navigation-panel.active {
            display: block;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .nav-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .nav-close-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .nav-stat {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .nav-stat-label {
            color: var(--text-secondary);
        }

        .nav-stat-value {
            font-weight: 600;
            color: var(--primary);
        }

        .nav-status {
            text-align: center;
            padding: 8px;
            background: var(--success);
            color: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .nav-status.calculating {
            background: #f59e0b;
        }

        .popup-content {
            min-width: 200px;
        }

        .popup-content h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .popup-content p {
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-buttons {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .popup-route-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .popup-route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .popup-actions {
            display: flex;
            gap: 8px;
        }

        .popup-edit-btn,
        .popup-delete-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .popup-edit-btn {
            background: var(--primary);
            color: white;
        }

        .popup-edit-btn:hover {
            background: var(--primary-hover);
        }

        .popup-delete-btn {
            background: var(--danger);
            color: white;
        }

        .popup-delete-btn:hover {
            background: var(--danger-hover);
        }

        /* Loading Indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 3000;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: flex;
            }

            .fab {
                bottom: 10px;
                width: 56px;
                height: 56px;
            }

            .toast {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Obtendo sua localiza√ß√£o...</p>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üìç Meus Clientes</h1>
                <p id="clientCount">0 clientes cadastrados</p>
            </div>

            <!-- Upload Planilha -->
            <div class="upload-section">
                <button class="upload-btn" id="uploadBtn" title="Upload planilha Excel com c√≥digos BR e endere√ßos">
                    üìä Carregar Planilha Excel
                </button>
                <input type="file" id="uploadInput" class="upload-input" accept=".xlsx,.xls,.csv">
                <div class="upload-status" id="uploadStatus"></div>
            </div>

            <!-- Search Box -->
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Buscar por nome ou endere√ßo..."
                        autocomplete="off"
                    >
                    <button class="clear-search" id="clearSearch" title="Limpar busca">√ó</button>
                </div>
                <div class="search-results-info" id="searchResultsInfo"></div>
            </div>

            <div class="clients-list" id="clientsList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                    </svg>
                    <p>Nenhum cliente cadastrado ainda</p>
                    <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Floating Action Button -->
        <button class="fab" id="addClientBtn" title="Adicionar cliente aqui">+</button>

        <!-- Navigation Panel - Real-time GPS -->
        <div class="navigation-panel" id="navigationPanel">
            <div class="nav-header">
                <div class="nav-title">üß≠ Navega√ß√£o Ativa</div>
                <button class="nav-close-btn" onclick="stopRealtimeNavigation()">Parar</button>
            </div>
            <div class="nav-stats">
                <div class="nav-stat">
                    <span class="nav-stat-label">Destino:</span>
                    <span class="nav-stat-value" id="navDestination">-</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Dist√¢ncia:</span>
                    <span class="nav-stat-value" id="navDistance">-</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Tempo:</span>
                    <span class="nav-stat-value" id="navTime">-</span>
                </div>
            </div>
            <div class="nav-status" id="navStatus">üöó Navegando...</div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="addClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Cliente</h2>
            </div>
            <div class="modal-body">
                <!-- QR Code Scanner Section -->
                <div class="camera-section">
                    <button type="button" class="scan-btn" id="scanBtn">
                        üì∑ Escanear QR Code
                    </button>
                    <div class="camera-preview" id="cameraPreview">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas"></canvas>
                    </div>
                </div>

                <form id="clientForm">
                    <div class="form-group">
                        <label for="clientName">Nome do Cliente *</label>
                        <input type="text" id="clientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Endere√ßo *</label>
                        <textarea id="clientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="clientBR">BR</label>
                        <input type="text" id="clientBR" placeholder="Informa√ß√£o do QR Code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="submit" form="clientForm" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-spinner"></div>
        <div class="processing-text">Lendo QR Code...</div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="editClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Editar Cliente</h2>
            </div>
            <div class="modal-body">
                <form id="editClientForm">
                    <div class="form-group">
                        <label for="editClientName">Nome do Cliente *</label>
                        <input type="text" id="editClientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="editClientAddress">Endere√ßo *</label>
                        <textarea id="editClientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editClientBR">BR</label>
                        <input type="text" id="editClientBR" placeholder="Informa√ß√£o do QR Code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="editCancelBtn">Cancelar</button>
                <button type="submit" form="editClientForm" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- jsQR (QR Code Scanner) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <!-- SheetJS (Excel Reader) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Toast Notification System
        function showToast(message, type = 'info', title = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                success: '‚úì'
            };

            const titles = {
                error: title || 'Erro',
                warning: title || 'Aviso',
                info: title || 'Informa√ß√£o',
                success: title || 'Sucesso'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 4000);
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Supabase Configuration
        // IMPORTANTE: Substitua estas vari√°veis pelas suas credenciais do Supabase
        const SUPABASE_URL = 'https://pnecrzwlyxjirdjfiman.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBuZWNyendseXhqaXJkamZpbWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTQ2NzksImV4cCI6MjA3OTg3MDY3OX0.2REOdgPBvGBZUrLT_ggUU6HqbunamouGaihjibH1jhs';

        // Inicializar Supabase (ser√° null se n√£o configurado)
        let supabase = null;
        try {
            if (SUPABASE_URL.includes('seu-projeto') || SUPABASE_ANON_KEY.includes('sua-chave')) {
                console.warn('‚ö†Ô∏è Supabase n√£o configurado. Usando armazenamento local.');
            } else {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase conectado com sucesso!');
            }
        } catch (error) {
            console.error('Erro ao conectar com Supabase:', error);
        }

        // Application State
        const state = {
            map: null,
            currentLocation: null,
            currentLocationMarker: null,
            clients: [],
            clientMarkers: [],
            nextId: 1,
            searchQuery: '',
            editingClientId: null,
            useSupabase: supabase !== null,
            brDatabase: {}, // Armazena mapeamento BR -> Endere√ßo
            routingControl: null, // Controle de navega√ß√£o
            navigationActive: false, // Navega√ß√£o GPS em tempo real ativa
            navigationWatchId: null, // ID do watchPosition
            navigationDestination: null, // Destino da navega√ß√£o
            currentRoute: null // Rota atual
        };

        // Icons
        const currentLocationIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                    <circle cx="12" cy="12" r="8" fill="#3b82f6" stroke="white" stroke-width="2"/>
                    <circle cx="12" cy="12" r="4" fill="white"/>
                </svg>
            `),
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        const clientIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
            `),
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Initialize Map
        async function initMap(lat, lng) {
            state.map = L.map('map').setView([lat, lng], 16);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(state.map);

            // Add current location marker
            state.currentLocationMarker = L.marker([lat, lng], {
                icon: currentLocationIcon,
                title: 'Sua localiza√ß√£o atual'
            }).addTo(state.map);

            state.currentLocationMarker.bindPopup('<b>Voc√™ est√° aqui</b>').openPopup();

            // Load clients from Supabase
            await loadClientsFromSupabase();

            // Load BR database from Supabase
            await loadBRDatabaseFromSupabase();

            hideLoading();
        }

        // Get Current Location
        async function getCurrentLocation() {
            if ('geolocation' in navigator) {
                // Verificar permiss√£o antes de solicitar
                if (navigator.permissions) {
                    try {
                        const permission = await navigator.permissions.query({ name: 'geolocation' });
                        console.log('Permiss√£o de geolocaliza√ß√£o:', permission.state);
                    } catch (error) {
                        console.log('N√£o foi poss√≠vel verificar permiss√£o:', error);
                    }
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        state.currentLocation = { lat, lng };
                        initMap(lat, lng);

                        // Watch position for updates
                        navigator.geolocation.watchPosition(
                            (pos) => {
                                const newLat = pos.coords.latitude;
                                const newLng = pos.coords.longitude;
                                state.currentLocation = { lat: newLat, lng: newLng };

                                if (state.currentLocationMarker) {
                                    state.currentLocationMarker.setLatLng([newLat, newLng]);
                                }
                            },
                            (error) => console.error('Error watching position:', error),
                            { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);

                        let errorMessage = 'N√£o foi poss√≠vel obter sua localiza√ß√£o.';
                        if (error.code === 1) {
                            errorMessage = 'Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o nas configura√ß√µes do navegador.';
                        }

                        // Default to S√£o Paulo, Brazil
                        const defaultLat = -23.5505;
                        const defaultLng = -46.6333;
                        state.currentLocation = { lat: defaultLat, lng: defaultLng };
                        initMap(defaultLat, defaultLng);
                        showToast(errorMessage, 'warning');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
                );
            } else {
                showToast('Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.', 'error');
                const defaultLat = -23.5505;
                const defaultLng = -46.6333;
                state.currentLocation = { lat: defaultLat, lng: defaultLng };
                initMap(defaultLat, defaultLng);
            }
        }

        // Show/Hide Loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Load BR Database from Supabase
        async function loadBRDatabaseFromSupabase() {
            if (!state.useSupabase) return;

            try {
                const { data, error } = await supabase
                    .from('br_addresses')
                    .select('*');

                if (error) throw error;

                if (data && data.length > 0) {
                    state.brDatabase = {};
                    data.forEach(item => {
                        state.brDatabase[item.br_code] = item.address;
                    });
                    console.log(`‚úÖ ${data.length} c√≥digo(s) BR carregado(s) do Supabase`);

                    const uploadStatus = document.getElementById('uploadStatus');
                    uploadStatus.textContent = `‚úì ${data.length} c√≥digos BR carregados!`;
                    uploadStatus.className = 'upload-status success';
                }
            } catch (error) {
                console.error('Erro ao carregar banco de dados BR:', error);
                // N√£o mostra toast, pois pode ser que a tabela ainda n√£o exista
            }
        }

        // Save BR Database to Supabase
        async function saveBRDatabaseToSupabase(brDatabase) {
            if (!state.useSupabase) return;

            try {
                // Limpar dados antigos
                const { error: deleteError } = await supabase
                    .from('br_addresses')
                    .delete()
                    .neq('br_code', ''); // Deleta todos os registros

                if (deleteError) throw deleteError;

                // Inserir novos dados
                const records = Object.entries(brDatabase).map(([br_code, address]) => ({
                    br_code,
                    address
                }));

                if (records.length > 0) {
                    const { error: insertError } = await supabase
                        .from('br_addresses')
                        .insert(records);

                    if (insertError) throw insertError;

                    console.log(`‚úÖ ${records.length} c√≥digo(s) BR salvos no Supabase`);
                }
            } catch (error) {
                console.error('Erro ao salvar banco de dados BR:', error);
                showToast('Erro ao salvar c√≥digos BR no banco de dados', 'error');
            }
        }

        // Load Clients from Supabase
        async function loadClientsFromSupabase() {
            if (!state.useSupabase) return;

            try {
                const { data, error } = await supabase
                    .from('clients')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    // Clear existing clients
                    state.clients = [];
                    state.clientMarkers.forEach(m => state.map.removeLayer(m.marker));
                    state.clientMarkers = [];

                    // Add clients from database
                    data.forEach(client => {
                        const clientObj = {
                            id: client.id,
                            name: client.name,
                            address: client.address,
                            lat: client.latitude,
                            lng: client.longitude,
                            br: client.br || '',
                            date: client.created_at
                        };
                        state.clients.push(clientObj);
                        addClientMarker(clientObj);
                    });

                    updateClientsList();
                    console.log(`‚úÖ ${data.length} cliente(s) carregado(s) do Supabase`);
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                showToast('Erro ao carregar clientes do banco de dados', 'error');
            }
        }

        // Add Client
        async function addClient(name, address, lat, lng, br = '') {
            const client = {
                name,
                address,
                lat,
                lng,
                br,
                date: new Date().toISOString()
            };

            if (state.useSupabase) {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([
                            {
                                name: client.name,
                                address: client.address,
                                latitude: client.lat,
                                longitude: client.lng,
                                br: client.br
                            }
                        ])
                        .select();

                    if (error) throw error;

                    // Use the ID from database
                    client.id = data[0].id;
                    client.date = data[0].created_at;
                    client.br = data[0].br || '';

                    console.log('‚úÖ Cliente salvo no Supabase');
                } catch (error) {
                    console.error('Erro ao salvar cliente:', error);
                    showToast('Erro ao salvar cliente no banco de dados', 'error');
                    return null;
                }
            } else {
                // Fallback to local storage
                client.id = state.nextId++;
            }

            state.clients.push(client);
            addClientMarker(client);
            updateClientsList();
            return client;
        }

        // Add Client Marker
        function addClientMarker(client) {
            const marker = L.marker([client.lat, client.lng], {
                icon: clientIcon,
                title: client.name
            }).addTo(state.map);

            updateMarkerPopup(client, marker);
            state.clientMarkers.push({ id: client.id, marker });
        }

        // Calculate Distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Dist√¢ncia em km
        }

        // Update Navigation Stats
        function updateNavigationStats() {
            if (!state.navigationActive || !state.currentLocation || !state.navigationDestination) return;

            const distance = calculateDistance(
                state.currentLocation.lat,
                state.currentLocation.lng,
                state.navigationDestination.lat,
                state.navigationDestination.lng
            );

            // Atualizar painel
            document.getElementById('navDistance').textContent =
                distance < 1 ? `${Math.round(distance * 1000)} m` : `${distance.toFixed(2)} km`;

            // Estimativa de tempo (assumindo 40 km/h de m√©dia)
            const estimatedTime = Math.round((distance / 40) * 60);
            document.getElementById('navTime').textContent =
                estimatedTime < 1 ? '< 1 min' : `${estimatedTime} min`;

            // Verificar se chegou ao destino (menos de 50 metros)
            if (distance < 0.05) {
                showToast('üéâ Voc√™ chegou ao destino!', 'success');
                stopRealtimeNavigation();
            }
        }

        // Start GPS Tracking for real-time navigation
        function startGPSTracking() {
            if (!('geolocation' in navigator)) {
                showToast('Geolocaliza√ß√£o n√£o suportada', 'error');
                return;
            }

            let lastLat = null;
            let lastLng = null;

            // Rastrear posi√ß√£o continuamente
            state.navigationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const newLat = position.coords.latitude;
                    const newLng = position.coords.longitude;
                    const heading = position.coords.heading; // Dire√ß√£o do movimento (0-360 graus)
                    const speed = position.coords.speed; // Velocidade em m/s

                    console.log('üìç Posi√ß√£o atualizada:', {
                        lat: newLat,
                        lng: newLng,
                        heading: heading,
                        speed: speed
                    });

                    // Atualizar posi√ß√£o atual
                    state.currentLocation = { lat: newLat, lng: newLng };

                    // Atualizar marcador de posi√ß√£o no mapa
                    if (state.currentLocationMarker) {
                        state.currentLocationMarker.setLatLng([newLat, newLng]);
                    }

                    // Calcular dire√ß√£o baseado na posi√ß√£o anterior se heading n√£o estiver dispon√≠vel
                    let bearing = heading;
                    if (bearing === null && lastLat !== null && lastLng !== null) {
                        // Calcular bearing entre dois pontos
                        const dLon = (newLng - lastLng) * Math.PI / 180;
                        const lat1 = lastLat * Math.PI / 180;
                        const lat2 = newLat * Math.PI / 180;
                        const y = Math.sin(dLon) * Math.cos(lat2);
                        const x = Math.cos(lat1) * Math.sin(lat2) -
                                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
                        bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
                    }

                    // ROTA√á√ÉO DO MAPA baseado na dire√ß√£o do movimento
                    if (bearing !== null && !isNaN(bearing)) {
                        state.map.setBearing(bearing);
                        console.log('üß≠ Dire√ß√£o do mapa ajustada:', bearing.toFixed(1) + '¬∞');
                    }

                    // Calcular dist√¢ncia at√© o destino
                    const distanceToDestination = calculateDistance(
                        newLat, newLng,
                        state.navigationDestination.lat, state.navigationDestination.lng
                    );

                    // ZOOM DIN√ÇMICO baseado na dist√¢ncia
                    let targetZoom = 16; // Zoom padr√£o
                    if (distanceToDestination < 0.1) { // Menos de 100m
                        targetZoom = 19; // Zoom alto (pr√≥ximo)
                    } else if (distanceToDestination < 0.5) { // Menos de 500m
                        targetZoom = 18;
                    } else if (distanceToDestination < 1) { // Menos de 1km
                        targetZoom = 17;
                    } else if (distanceToDestination < 5) { // Menos de 5km
                        targetZoom = 16;
                    } else {
                        targetZoom = 14; // Zoom m√©dio (longe)
                    }

                    // Aplicar zoom suave
                    if (Math.abs(state.map.getZoom() - targetZoom) > 0.5) {
                        state.map.setZoom(targetZoom, {
                            animate: true
                        });
                        console.log(`üîç Zoom ajustado para ${targetZoom} (dist√¢ncia: ${distanceToDestination.toFixed(2)} km)`);
                    }

                    // Centralizar mapa na posi√ß√£o atual (smooth pan com bearing)
                    state.map.panTo([newLat, newLng], {
                        animate: true,
                        duration: 1
                    });

                    // Atualizar estat√≠sticas de navega√ß√£o
                    updateNavigationStats();

                    // Recalcular rota se necess√°rio
                    if (state.routingControl && state.navigationDestination) {
                        const waypoints = state.routingControl.getWaypoints();
                        waypoints[0].latLng = L.latLng(newLat, newLng);
                        state.routingControl.setWaypoints(waypoints);
                    }

                    // Armazenar posi√ß√£o atual para pr√≥xima itera√ß√£o
                    lastLat = newLat;
                    lastLng = newLng;
                },
                (error) => {
                    console.error('Erro no rastreamento GPS:', error);
                    showToast('Erro ao rastrear localiza√ß√£o', 'warning');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000, // Atualiza√ß√£o mais frequente para rota√ß√£o suave
                    timeout: 10000
                }
            );

            console.log('‚úÖ Rastreamento GPS iniciado com rota√ß√£o e zoom autom√°tico');
        }

        // Stop Realtime Navigation
        window.stopRealtimeNavigation = function() {
            state.navigationActive = false;

            // Parar rastreamento GPS
            if (state.navigationWatchId) {
                navigator.geolocation.clearWatch(state.navigationWatchId);
                state.navigationWatchId = null;
            }

            // Remover rota
            if (state.routingControl) {
                state.map.removeControl(state.routingControl);
                state.routingControl = null;
            }

            // Resetar zoom para padr√£o
            state.map.setZoom(16);

            // Ocultar painel
            const navPanel = document.getElementById('navigationPanel');
            if (navPanel) {
                navPanel.classList.remove('active');
            }

            state.navigationDestination = null;
            state.currentRoute = null;
        };

        // Start Navigation with Real-time GPS
        window.startNavigation = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client || !state.currentLocation) return;

            // Parar navega√ß√£o anterior se houver
            if (state.navigationActive) {
                stopRealtimeNavigation();
            }

            // Configurar nova navega√ß√£o
            state.navigationActive = true;
            state.navigationDestination = {
                lat: client.lat,
                lng: client.lng,
                name: client.name
            };

            // Mostrar painel de navega√ß√£o
            document.getElementById('navigationPanel').classList.add('active');
            document.getElementById('navDestination').textContent = client.name;
            document.getElementById('navStatus').textContent = 'üì° Calculando rota...';
            document.getElementById('navStatus').className = 'nav-status calculating';

            console.log('üß≠ Iniciando navega√ß√£o em tempo real:', {
                origem: `${state.currentLocation.lat}, ${state.currentLocation.lng}`,
                destino: `${client.lat}, ${client.lng}`,
                cliente: client.name
            });

            try {
                // Criar controle de roteamento
                state.routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(state.currentLocation.lat, state.currentLocation.lng),
                        L.latLng(client.lat, client.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    addWaypoints: false,
                    fitSelectedRoutes: true,
                    lineOptions: {
                        styles: [
                            {color: '#2563eb', opacity: 0.8, weight: 6}
                        ],
                        extendToWaypoints: true,
                        missingRouteTolerance: 0
                    },
                    createMarker: function() { return null; }, // N√£o criar marcadores extras
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving', // ou 'car', 'bike', 'foot'
                        timeout: 30000 // 30 segundos timeout
                    }),
                    formatter: new L.Routing.Formatter({
                        language: 'pt',
                        units: 'metric',
                        unitNames: {
                            meters: 'm',
                            kilometers: 'km',
                            yards: 'yd',
                            miles: 'mi',
                            hours: 'h',
                            minutes: 'min',
                            seconds: 's'
                        }
                    })
                }).addTo(state.map);

                // Evento quando a rota √© calculada
                state.routingControl.on('routesfound', function(e) {
                    console.log('‚úÖ Rota encontrada:', e.routes);
                    const routes = e.routes;
                    state.currentRoute = routes[0];
                    const summary = routes[0].summary;
                    const distance = (summary.totalDistance / 1000).toFixed(2);
                    const time = Math.round(summary.totalTime / 60);

                    // Atualizar painel com dados da rota
                    document.getElementById('navDistance').textContent = `${distance} km`;
                    document.getElementById('navTime').textContent = `${time} min`;
                    document.getElementById('navStatus').textContent = 'üöó Navegando...';
                    document.getElementById('navStatus').className = 'nav-status';

                    // ZOOM INICIAL mais pr√≥ximo baseado na dist√¢ncia
                    let initialZoom = 19; // Zoom muito alto por padr√£o
                    const distKm = parseFloat(distance);
                    if (distKm < 0.5) { // Menos de 500m
                        initialZoom = 19;
                    } else if (distKm < 2) { // Menos de 2km
                        initialZoom = 18;
                    } else if (distKm < 5) { // Menos de 5km
                        initialZoom = 17;
                    } else if (distKm < 10) { // Menos de 10km
                        initialZoom = 16;
                    } else {
                        initialZoom = 15;
                    }

                    // Aplicar zoom inicial
                    state.map.setZoom(initialZoom);
                    console.log(`üîç Zoom inicial definido para ${initialZoom} (dist√¢ncia: ${distance} km)`);

                    // Centralizar no ponto inicial (sua localiza√ß√£o)
                    state.map.setView([state.currentLocation.lat, state.currentLocation.lng], initialZoom, {
                        animate: true,
                        duration: 0.5
                    });

                    // Iniciar rastreamento GPS em tempo real
                    startGPSTracking();

                    // Fechar sidebar em mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                });

                state.routingControl.on('routingerror', function(e) {
                    console.error('‚ùå Erro detalhado ao calcular rota:', e);

                    let errorMsg = 'N√£o foi poss√≠vel calcular a rota.';

                    if (e.error && e.error.status) {
                        if (e.error.status === 429) {
                            errorMsg = 'Muitas requisi√ß√µes. Aguarde alguns segundos e tente novamente.';
                        } else if (e.error.status === 0) {
                            errorMsg = 'Sem conex√£o com o servidor de rotas. Verifique sua internet.';
                        } else {
                            errorMsg = `Erro ${e.error.status}: ${e.error.message || 'Erro desconhecido'}`;
                        }
                    }

                    showToast(errorMsg, 'error');

                    // Remover controle com erro
                    if (state.routingControl) {
                        state.map.removeControl(state.routingControl);
                        state.routingControl = null;
                    }
                });

                showToast(`Calculando rota para ${client.name}...`, 'info');

            } catch (error) {
                console.error('‚ùå Erro ao criar roteamento:', error);
                showToast('Erro ao iniciar navega√ß√£o: ' + error.message, 'error');
            }
        };

        // Update Marker Popup
        function updateMarkerPopup(client, marker) {
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.lat},${client.lng}`;

            const popupContent = `
                <div class="popup-content">
                    <h3>${client.name}</h3>
                    <p><strong>Endere√ßo:</strong><br>${client.address}</p>
                    <p><strong>Coordenadas:</strong><br>
                    Lat: ${client.lat.toFixed(6)}, Lng: ${client.lng.toFixed(6)}</p>
                    <div class="popup-buttons">
                        <button class="popup-navigate-btn" onclick="startNavigation(${client.id})">
                            üß≠ Navegar pelo Mapa
                        </button>
                        <a href="${googleMapsUrl}" target="_blank" class="popup-route-btn">
                            üó∫Ô∏è Abrir no Google Maps
                        </a>
                        <div class="popup-actions">
                            <button class="popup-edit-btn" onclick="openEditModal(${client.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="popup-delete-btn" onclick="deleteClient(${client.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
        }

        // Edit Client
        window.openEditModal = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            state.editingClientId = clientId;

            // Populate form
            document.getElementById('editClientName').value = client.name;
            document.getElementById('editClientAddress').value = client.address;
            document.getElementById('editClientBR').value = client.br || '';

            // Show modal
            document.getElementById('editClientModal').classList.add('active');
            document.getElementById('editClientName').focus();
        };

        // Update Client
        async function updateClient(clientId, newName, newAddress, newBR) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .update({
                            name: newName,
                            address: newAddress,
                            br: newBR
                        })
                        .eq('id', clientId);

                    if (error) throw error;

                    console.log('‚úÖ Cliente atualizado no Supabase');
                } catch (error) {
                    console.error('Erro ao atualizar cliente:', error);
                    showToast('Erro ao atualizar cliente no banco de dados', 'error');
                    return;
                }
            }

            // Update client data
            client.name = newName;
            client.address = newAddress;
            client.br = newBR;

            // Update marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                markerObj.marker.options.title = newName;
                updateMarkerPopup(client, markerObj.marker);
            }

            // Update list
            updateClientsList();
        }

        // Delete Client
        window.deleteClient = async function(clientId) {
            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .delete()
                        .eq('id', clientId);

                    if (error) throw error;

                    console.log('‚úÖ Cliente exclu√≠do do Supabase');
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showToast('Erro ao excluir cliente do banco de dados', 'error');
                    return;
                }
            }

            // Remove from array
            state.clients = state.clients.filter(c => c.id !== clientId);

            // Remove marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                state.map.removeLayer(markerObj.marker);
                state.clientMarkers = state.clientMarkers.filter(m => m.id !== clientId);
            }

            updateClientsList();
            showToast('Cliente exclu√≠do com sucesso!', 'success');
        };

        // Highlight search term in text
        function highlightText(text, query) {
            if (!query) return text;

            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight-text">$1</span>');
        }

        // Update Clients List
        function updateClientsList() {
            const listContainer = document.getElementById('clientsList');
            const countElement = document.getElementById('clientCount');
            const searchResultsInfo = document.getElementById('searchResultsInfo');

            countElement.textContent = `${state.clients.length} cliente${state.clients.length !== 1 ? 's' : ''} cadastrado${state.clients.length !== 1 ? 's' : ''}`;

            if (state.clients.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente cadastrado ainda</p>
                        <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                    </div>
                `;
                searchResultsInfo.textContent = '';
                return;
            }

            // Filter clients based on search query
            const query = state.searchQuery.toLowerCase().trim();
            const filteredClients = state.clients.filter(client => {
                if (!query) return true;

                const nameMatch = client.name.toLowerCase().includes(query);
                const addressMatch = client.address.toLowerCase().includes(query);

                return nameMatch || addressMatch;
            });

            // Update search results info
            if (query) {
                if (filteredClients.length === 0) {
                    searchResultsInfo.textContent = 'Nenhum resultado encontrado';
                } else if (filteredClients.length === 1) {
                    searchResultsInfo.textContent = '1 cliente encontrado';
                } else {
                    searchResultsInfo.textContent = `${filteredClients.length} clientes encontrados`;
                }
            } else {
                searchResultsInfo.textContent = '';
            }

            if (filteredClients.length === 0 && query) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente encontrado</p>
                        <p style="font-size: 12px; margin-top: 8px;">Tente outro termo de busca</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredClients.map(client => {
                const highlightedName = highlightText(client.name, query);
                const highlightedAddress = highlightText(client.address, query);
                const isHighlight = query ? 'highlight' : '';

                return `
                    <div class="client-item ${isHighlight}" onclick="focusClient(${client.id})">
                        <div class="client-name">üìç ${highlightedName}</div>
                        <div class="client-address">${highlightedAddress}</div>
                        <div class="client-coords">
                            ${client.lat.toFixed(6)}, ${client.lng.toFixed(6)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Focus on Client
        window.focusClient = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (client) {
                state.map.setView([client.lat, client.lng], 18);

                const markerObj = state.clientMarkers.find(m => m.id === clientId);
                if (markerObj) {
                    markerObj.marker.openPopup();
                }

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }
        };

        // QR Code Scanner Controls - OTIMIZADO
        const scanBtn = document.getElementById('scanBtn');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const processingOverlay = document.getElementById('processingOverlay');
        let cameraStream = null;
        let qrScanActive = false;
        let canvasContext = null;

        // Open/Close QR Scanner
        scanBtn.addEventListener('click', async () => {
            if (cameraStream) {
                // Close camera
                qrScanActive = false;
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraPreview.classList.remove('active');
                scanBtn.textContent = 'üì∑ Escanear QR Code';
                scanBtn.style.background = '';
            } else {
                // Open camera with optimized settings
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    cameraVideo.srcObject = cameraStream;
                    cameraPreview.classList.add('active');
                    scanBtn.textContent = '‚úñ Fechar C√¢mera';
                    scanBtn.style.background = '#ef4444';

                    // Initialize canvas context once
                    if (!canvasContext) {
                        canvasContext = cameraCanvas.getContext('2d', { willReadFrequently: true });
                    }

                    // Start optimized QR scanning
                    qrScanActive = true;
                    requestAnimationFrame(scanQRCode);
                } catch (error) {
                    console.error('Erro ao acessar c√¢mera:', error);
                    showToast('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.', 'error');
                }
            }
        });

        // ULTRA-FAST QR Code scanning with multi-scale detection
        function scanQRCode() {
            if (!qrScanActive || cameraVideo.readyState !== cameraVideo.HAVE_ENOUGH_DATA) {
                if (qrScanActive) requestAnimationFrame(scanQRCode);
                return;
            }

            const videoWidth = cameraVideo.videoWidth;
            const videoHeight = cameraVideo.videoHeight;

            // Try multiple scales for better detection (especially with low-quality QR codes)
            const scales = [0.6, 0.4]; // Try 60% then 40% if not found

            for (const scale of scales) {
                const width = Math.floor(videoWidth * scale);
                const height = Math.floor(videoHeight * scale);

                // Resize canvas only if needed
                if (cameraCanvas.width !== width || cameraCanvas.height !== height) {
                    cameraCanvas.width = width;
                    cameraCanvas.height = height;
                }

                // Apply image enhancements for better detection
                canvasContext.save();
                canvasContext.filter = 'contrast(1.2) brightness(1.1)';
                canvasContext.drawImage(cameraVideo, 0, 0, width, height);
                canvasContext.restore();

                // Get image data
                const imageData = canvasContext.getImageData(0, 0, width, height);

                // Scan with aggressive inversion attempts for damaged QR codes
                const code = jsQR(imageData.data, width, height, {
                    inversionAttempts: "attemptBoth" // Try both normal and inverted for damaged codes
                });

                if (code) {
                    console.log('‚úÖ QR Code detectado:', code.data);

                    // Strong visual feedback
                    cameraVideo.style.filter = 'brightness(1.5)';
                    setTimeout(() => { cameraVideo.style.filter = ''; }, 150);

                    // Vibrate
                    if ('vibrate' in navigator) {
                        navigator.vibrate([50, 30, 50]); // Double vibration pattern
                    }

                    // Fill BR field
                    document.getElementById('clientBR').value = code.data;

                    // Buscar endere√ßo na planilha automaticamente
                    const brCode = code.data.trim();
                    if (state.brDatabase[brCode]) {
                        document.getElementById('clientAddress').value = state.brDatabase[brCode];
                        showToast('‚úì QR Code lido! Endere√ßo preenchido automaticamente.', 'success');
                    } else {
                        showToast('‚úì QR Code lido! Endere√ßo n√£o encontrado na planilha.', 'warning');
                    }

                    // Close camera
                    qrScanActive = false;
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                    }
                    cameraPreview.classList.remove('active');
                    scanBtn.textContent = 'üì∑ Escanear QR Code';
                    scanBtn.style.background = '';
                    return;
                }
            }

            // Continue scanning immediately for maximum speed
            requestAnimationFrame(scanQRCode);
        }

        // Add Client Modal Controls
        const addModal = document.getElementById('addClientModal');
        const addClientBtn = document.getElementById('addClientBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const clientForm = document.getElementById('clientForm');

        addClientBtn.addEventListener('click', () => {
            if (!state.currentLocation) {
                showToast('Aguardando localiza√ß√£o...', 'warning');
                return;
            }

            addModal.classList.add('active');
            document.getElementById('clientName').focus();
        });

        cancelBtn.addEventListener('click', () => {
            // Fechar c√¢mera se estiver aberta
            qrScanActive = false;
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraPreview.classList.remove('active');
            scanBtn.textContent = 'üì∑ Escanear QR Code';
            scanBtn.style.background = '';

            addModal.classList.remove('active');
            clientForm.reset();
        });

        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                // Fechar c√¢mera se estiver aberta
                qrScanActive = false;
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                cameraPreview.classList.remove('active');
                scanBtn.textContent = 'üì∑ Escanear QR Code';
                scanBtn.style.background = '';

                addModal.classList.remove('active');
                clientForm.reset();
            }
        });

        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddress').value.trim();
            const br = document.getElementById('clientBR').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            const client = await addClient(name, address, state.currentLocation.lat, state.currentLocation.lng, br);

            if (!client) return; // Error already shown

            addModal.classList.remove('active');
            clientForm.reset();

            // Show success feedback
            showToast(`Cliente "${name}" adicionado com sucesso!`, 'success');
            const originalText = addClientBtn.textContent;
            addClientBtn.textContent = '‚úì';
            addClientBtn.style.background = '#10b981';
            setTimeout(() => {
                addClientBtn.textContent = originalText;
                addClientBtn.style.background = '';
            }, 1500);
        });

        // Edit Client Modal Controls
        const editModal = document.getElementById('editClientModal');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const editClientForm = document.getElementById('editClientForm');

        editCancelBtn.addEventListener('click', () => {
            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.remove('active');
                editClientForm.reset();
                state.editingClientId = null;
            }
        });

        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('editClientName').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();
            const br = document.getElementById('editClientBR').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            if (state.editingClientId) {
                await updateClient(state.editingClientId, name, address, br);
                showToast(`Cliente "${name}" atualizado com sucesso!`, 'success');
            }

            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            updateClientsList();

            // Show/hide clear button
            if (state.searchQuery) {
                clearSearchBtn.classList.add('visible');
            } else {
                clearSearchBtn.classList.remove('visible');
            }
        });

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            state.searchQuery = '';
            clearSearchBtn.classList.remove('visible');
            updateClientsList();
            searchInput.focus();
        });

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking on map (mobile)
        document.getElementById('map').addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        });

        // Upload Excel Spreadsheet
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadInput = document.getElementById('uploadInput');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadBtn.addEventListener('click', () => {
            uploadInput.click();
        });

        uploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadStatus.textContent = 'Processando planilha...';
            uploadStatus.className = 'upload-status';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                // Limpar base de dados anterior
                state.brDatabase = {};

                let count = 0;

                // Processar cada linha da planilha
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];

                    // Procurar pelas colunas BR e Endere√ßo (aceita v√°rios formatos)
                    let brCode = null;
                    let address = null;

                    // Buscar coluna de c√≥digo BR
                    if (row['SPX TN']) {
                        brCode = String(row['SPX TN']).trim();
                    } else if (row['BR']) {
                        brCode = String(row['BR']).trim();
                    } else if (row['C√≥digo BR']) {
                        brCode = String(row['C√≥digo BR']).trim();
                    } else if (row['Codigo BR']) {
                        brCode = String(row['Codigo BR']).trim();
                    } else if (row['Code']) {
                        brCode = String(row['Code']).trim();
                    }

                    // Buscar coluna de endere√ßo
                    if (row['Destination Address']) {
                        address = String(row['Destination Address']).trim();
                    } else if (row['Endere√ßo']) {
                        address = String(row['Endere√ßo']).trim();
                    } else if (row['Endereco']) {
                        address = String(row['Endereco']).trim();
                    } else if (row['Address']) {
                        address = String(row['Address']).trim();
                    }

                    // Se encontrou ambos, adicionar ao banco de dados
                    if (brCode && address && brCode !== 'undefined' && address !== 'undefined') {
                        state.brDatabase[brCode] = address;
                        count++;
                    }
                }

                if (count > 0) {
                    // Salvar no Supabase
                    uploadStatus.textContent = 'Salvando no banco de dados...';
                    await saveBRDatabaseToSupabase(state.brDatabase);

                    uploadStatus.textContent = `‚úì ${count} c√≥digos BR carregados!`;
                    uploadStatus.className = 'upload-status success';
                    showToast(`${count} c√≥digos BR carregados e salvos no banco de dados!`, 'success');
                } else {
                    uploadStatus.textContent = '‚ö† Nenhum c√≥digo encontrado';
                    uploadStatus.className = 'upload-status';
                    showToast('Nenhum c√≥digo BR encontrado. Verifique se a planilha tem as colunas "SPX TN" e "Destination Address".', 'warning');
                }

                console.log('üìä Base de dados BR carregada:', state.brDatabase);
                console.log(`üìä Total de c√≥digos: ${count}`);

            } catch (error) {
                console.error('Erro ao processar planilha:', error);
                uploadStatus.textContent = '‚ùå Erro ao processar planilha';
                uploadStatus.className = 'upload-status';
                showToast('Erro ao processar planilha. Verifique o formato.', 'error');
            }

            // Limpar input
            uploadInput.value = '';
        });

        // Initialize App
        getCurrentLocation();
    </script>
</body>
</html>
