<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Clientes - Geolocaliza√ß√£o</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" >

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        .dark {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Search Box */
        .search-container {
            padding: 15px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
            font-size: 16px;
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 38px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .clear-search {
            position: absolute;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            display: none;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }

        .clear-search:hover {
            color: var(--text-primary);
        }

        .clear-search.visible {
            display: block;
        }

        .search-results-info {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .clients-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .client-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-item:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .client-item.hidden {
            display: none;
        }

        .client-item.highlight {
            border-color: var(--primary);
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(37, 99, 235, 0.05) 100%);
        }

        .highlight-text {
            background: rgba(37, 99, 235, 0.2);
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 600;
        }

        .client-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .client-address {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .client-coords {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Map Container */
        #map {
            flex: 1;
            height: 100vh;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            border: none;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 8px var(--shadow);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .menu-toggle svg {
            width: 24px;
            height: 24px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .coords-display {
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Leaflet Custom Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        .popup-content {
            min-width: 200px;
        }

        .popup-content h3 {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .popup-content p {
            margin-bottom: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .popup-buttons {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .popup-route-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .popup-route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .popup-actions {
            display: flex;
            gap: 8px;
        }

        .popup-edit-btn,
        .popup-delete-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .popup-edit-btn {
            background: var(--primary);
            color: white;
        }

        .popup-edit-btn:hover {
            background: var(--primary-hover);
        }

        .popup-delete-btn {
            background: var(--danger);
            color: white;
        }

        .popup-delete-btn:hover {
            background: var(--danger-hover);
        }

        /* Loading Indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 3000;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: flex;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }

            .toast {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Obtendo sua localiza√ß√£o...</p>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üìç Meus Clientes</h1>
                <p id="clientCount">0 clientes cadastrados</p>
            </div>

            <!-- Search Box -->
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Buscar por nome ou endere√ßo..."
                        autocomplete="off"
                    >
                    <button class="clear-search" id="clearSearch" title="Limpar busca">√ó</button>
                </div>
                <div class="search-results-info" id="searchResultsInfo"></div>
            </div>

            <div class="clients-list" id="clientsList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                    </svg>
                    <p>Nenhum cliente cadastrado ainda</p>
                    <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" id="menuToggle">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Floating Action Button -->
        <button class="fab" id="addClientBtn" title="Adicionar cliente aqui">+</button>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="addClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Adicionar Novo Cliente</h2>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="form-group">
                        <label for="clientName">Nome do Cliente *</label>
                        <input type="text" id="clientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="clientAddress">Endere√ßo *</label>
                        <textarea id="clientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Coordenadas (Autom√°tico)</label>
                        <div class="coords-display" id="coordsDisplay">
                            Lat: 0.000000, Lng: 0.000000
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="submit" form="clientForm" class="btn btn-primary">Salvar Cliente</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="editClientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Editar Cliente</h2>
            </div>
            <div class="modal-body">
                <form id="editClientForm">
                    <div class="form-group">
                        <label for="editClientName">Nome do Cliente *</label>
                        <input type="text" id="editClientName" required placeholder="Digite o nome do cliente">
                    </div>
                    <div class="form-group">
                        <label for="editClientAddress">Endere√ßo *</label>
                        <textarea id="editClientAddress" required placeholder="Digite o endere√ßo completo"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Coordenadas (Fixas)</label>
                        <div class="coords-display" id="editCoordsDisplay">
                            Lat: 0.000000, Lng: 0.000000
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="editCancelBtn">Cancelar</button>
                <button type="submit" form="editClientForm" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Toast Notification System
        function showToast(message, type = 'info', title = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                success: '‚úì'
            };

            const titles = {
                error: title || 'Erro',
                warning: title || 'Aviso',
                info: title || 'Informa√ß√£o',
                success: title || 'Sucesso'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 4000);
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Supabase Configuration
        // IMPORTANTE: Substitua estas vari√°veis pelas suas credenciais do Supabase
        const SUPABASE_URL = 'https://seu-projeto.supabase.co';
        const SUPABASE_ANON_KEY = 'sua-chave-anonima-aqui';

        // Inicializar Supabase (ser√° null se n√£o configurado)
        let supabase = null;
        try {
            if (SUPABASE_URL.includes('seu-projeto') || SUPABASE_ANON_KEY.includes('sua-chave')) {
                console.warn('‚ö†Ô∏è Supabase n√£o configurado. Usando armazenamento local.');
            } else {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase conectado com sucesso!');
            }
        } catch (error) {
            console.error('Erro ao conectar com Supabase:', error);
        }

        // Application State
        const state = {
            map: null,
            currentLocation: null,
            currentLocationMarker: null,
            clients: [],
            clientMarkers: [],
            nextId: 1,
            searchQuery: '',
            editingClientId: null,
            useSupabase: supabase !== null
        };

        // Icons
        const currentLocationIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2563eb">
                    <circle cx="12" cy="12" r="8" fill="#3b82f6" stroke="white" stroke-width="2"/>
                    <circle cx="12" cy="12" r="4" fill="white"/>
                </svg>
            `),
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        const clientIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
            `),
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Initialize Map
        async function initMap(lat, lng) {
            state.map = L.map('map').setView([lat, lng], 16);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(state.map);

            // Add current location marker
            state.currentLocationMarker = L.marker([lat, lng], {
                icon: currentLocationIcon,
                title: 'Sua localiza√ß√£o atual'
            }).addTo(state.map);

            state.currentLocationMarker.bindPopup('<b>Voc√™ est√° aqui</b>').openPopup();

            // Load clients from Supabase
            await loadClientsFromSupabase();

            hideLoading();
        }

        // Get Current Location
        function getCurrentLocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        state.currentLocation = { lat, lng };
                        initMap(lat, lng);

                        // Watch position for updates
                        navigator.geolocation.watchPosition(
                            (pos) => {
                                const newLat = pos.coords.latitude;
                                const newLng = pos.coords.longitude;
                                state.currentLocation = { lat: newLat, lng: newLng };

                                if (state.currentLocationMarker) {
                                    state.currentLocationMarker.setLatLng([newLat, newLng]);
                                }
                            },
                            (error) => console.error('Error watching position:', error),
                            { enableHighAccuracy: true, maximumAge: 10000 }
                        );
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        // Default to S√£o Paulo, Brazil
                        const defaultLat = -23.5505;
                        const defaultLng = -46.6333;
                        state.currentLocation = { lat: defaultLat, lng: defaultLng };
                        initMap(defaultLat, defaultLng);
                        showToast('N√£o foi poss√≠vel obter sua localiza√ß√£o. Usando localiza√ß√£o padr√£o.', 'warning');
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                showToast('Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.', 'error');
                const defaultLat = -23.5505;
                const defaultLng = -46.6333;
                state.currentLocation = { lat: defaultLat, lng: defaultLng };
                initMap(defaultLat, defaultLng);
            }
        }

        // Show/Hide Loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Load Clients from Supabase
        async function loadClientsFromSupabase() {
            if (!state.useSupabase) return;

            try {
                const { data, error } = await supabase
                    .from('clients')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    // Clear existing clients
                    state.clients = [];
                    state.clientMarkers.forEach(m => state.map.removeLayer(m.marker));
                    state.clientMarkers = [];

                    // Add clients from database
                    data.forEach(client => {
                        const clientObj = {
                            id: client.id,
                            name: client.name,
                            address: client.address,
                            lat: client.latitude,
                            lng: client.longitude,
                            date: client.created_at
                        };
                        state.clients.push(clientObj);
                        addClientMarker(clientObj);
                    });

                    updateClientsList();
                    console.log(`‚úÖ ${data.length} cliente(s) carregado(s) do Supabase`);
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                showToast('Erro ao carregar clientes do banco de dados', 'error');
            }
        }

        // Add Client
        async function addClient(name, address, lat, lng) {
            const client = {
                name,
                address,
                lat,
                lng,
                date: new Date().toISOString()
            };

            if (state.useSupabase) {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([
                            {
                                name: client.name,
                                address: client.address,
                                latitude: client.lat,
                                longitude: client.lng
                            }
                        ])
                        .select();

                    if (error) throw error;

                    // Use the ID from database
                    client.id = data[0].id;
                    client.date = data[0].created_at;

                    console.log('‚úÖ Cliente salvo no Supabase');
                } catch (error) {
                    console.error('Erro ao salvar cliente:', error);
                    showToast('Erro ao salvar cliente no banco de dados', 'error');
                    return null;
                }
            } else {
                // Fallback to local storage
                client.id = state.nextId++;
            }

            state.clients.push(client);
            addClientMarker(client);
            updateClientsList();
            return client;
        }

        // Add Client Marker
        function addClientMarker(client) {
            const marker = L.marker([client.lat, client.lng], {
                icon: clientIcon,
                title: client.name
            }).addTo(state.map);

            updateMarkerPopup(client, marker);
            state.clientMarkers.push({ id: client.id, marker });
        }

        // Update Marker Popup
        function updateMarkerPopup(client, marker) {
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${client.lat},${client.lng}`;

            const popupContent = `
                <div class="popup-content">
                    <h3>${client.name}</h3>
                    <p><strong>Endere√ßo:</strong><br>${client.address}</p>
                    <p><strong>Coordenadas:</strong><br>
                    Lat: ${client.lat.toFixed(6)}, Lng: ${client.lng.toFixed(6)}</p>
                    <div class="popup-buttons">
                        <a href="${googleMapsUrl}" target="_blank" class="popup-route-btn">
                            üó∫Ô∏è Iniciar Rota no Google Maps
                        </a>
                        <div class="popup-actions">
                            <button class="popup-edit-btn" onclick="openEditModal(${client.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="popup-delete-btn" onclick="deleteClient(${client.id})">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
        }

        // Edit Client
        window.openEditModal = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            state.editingClientId = clientId;

            // Populate form
            document.getElementById('editClientName').value = client.name;
            document.getElementById('editClientAddress').value = client.address;
            document.getElementById('editCoordsDisplay').textContent =
                `Lat: ${client.lat.toFixed(6)}, Lng: ${client.lng.toFixed(6)}`;

            // Show modal
            document.getElementById('editClientModal').classList.add('active');
            document.getElementById('editClientName').focus();
        };

        // Update Client
        async function updateClient(clientId, newName, newAddress) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;

            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .update({
                            name: newName,
                            address: newAddress
                        })
                        .eq('id', clientId);

                    if (error) throw error;

                    console.log('‚úÖ Cliente atualizado no Supabase');
                } catch (error) {
                    console.error('Erro ao atualizar cliente:', error);
                    showToast('Erro ao atualizar cliente no banco de dados', 'error');
                    return;
                }
            }

            // Update client data
            client.name = newName;
            client.address = newAddress;

            // Update marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                markerObj.marker.options.title = newName;
                updateMarkerPopup(client, markerObj.marker);
            }

            // Update list
            updateClientsList();
        }

        // Delete Client
        window.deleteClient = async function(clientId) {
            if (state.useSupabase) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .delete()
                        .eq('id', clientId);

                    if (error) throw error;

                    console.log('‚úÖ Cliente exclu√≠do do Supabase');
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    showToast('Erro ao excluir cliente do banco de dados', 'error');
                    return;
                }
            }

            // Remove from array
            state.clients = state.clients.filter(c => c.id !== clientId);

            // Remove marker
            const markerObj = state.clientMarkers.find(m => m.id === clientId);
            if (markerObj) {
                state.map.removeLayer(markerObj.marker);
                state.clientMarkers = state.clientMarkers.filter(m => m.id !== clientId);
            }

            updateClientsList();
            showToast('Cliente exclu√≠do com sucesso!', 'success');
        };

        // Highlight search term in text
        function highlightText(text, query) {
            if (!query) return text;

            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight-text">$1</span>');
        }

        // Update Clients List
        function updateClientsList() {
            const listContainer = document.getElementById('clientsList');
            const countElement = document.getElementById('clientCount');
            const searchResultsInfo = document.getElementById('searchResultsInfo');

            countElement.textContent = `${state.clients.length} cliente${state.clients.length !== 1 ? 's' : ''} cadastrado${state.clients.length !== 1 ? 's' : ''}`;

            if (state.clients.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente cadastrado ainda</p>
                        <p style="font-size: 12px; margin-top: 8px;">Use o bot√£o + para adicionar</p>
                    </div>
                `;
                searchResultsInfo.textContent = '';
                return;
            }

            // Filter clients based on search query
            const query = state.searchQuery.toLowerCase().trim();
            const filteredClients = state.clients.filter(client => {
                if (!query) return true;

                const nameMatch = client.name.toLowerCase().includes(query);
                const addressMatch = client.address.toLowerCase().includes(query);

                return nameMatch || addressMatch;
            });

            // Update search results info
            if (query) {
                if (filteredClients.length === 0) {
                    searchResultsInfo.textContent = 'Nenhum resultado encontrado';
                } else if (filteredClients.length === 1) {
                    searchResultsInfo.textContent = '1 cliente encontrado';
                } else {
                    searchResultsInfo.textContent = `${filteredClients.length} clientes encontrados`;
                }
            } else {
                searchResultsInfo.textContent = '';
            }

            if (filteredClients.length === 0 && query) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <p>Nenhum cliente encontrado</p>
                        <p style="font-size: 12px; margin-top: 8px;">Tente outro termo de busca</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredClients.map(client => {
                const highlightedName = highlightText(client.name, query);
                const highlightedAddress = highlightText(client.address, query);
                const isHighlight = query ? 'highlight' : '';

                return `
                    <div class="client-item ${isHighlight}" onclick="focusClient(${client.id})">
                        <div class="client-name">üìç ${highlightedName}</div>
                        <div class="client-address">${highlightedAddress}</div>
                        <div class="client-coords">
                            ${client.lat.toFixed(6)}, ${client.lng.toFixed(6)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Focus on Client
        window.focusClient = function(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (client) {
                state.map.setView([client.lat, client.lng], 18);

                const markerObj = state.clientMarkers.find(m => m.id === clientId);
                if (markerObj) {
                    markerObj.marker.openPopup();
                }

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }
        };

        // Add Client Modal Controls
        const addModal = document.getElementById('addClientModal');
        const addClientBtn = document.getElementById('addClientBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const clientForm = document.getElementById('clientForm');

        addClientBtn.addEventListener('click', () => {
            if (!state.currentLocation) {
                showToast('Aguardando localiza√ß√£o...', 'warning');
                return;
            }

            const coordsDisplay = document.getElementById('coordsDisplay');
            coordsDisplay.textContent = `Lat: ${state.currentLocation.lat.toFixed(6)}, Lng: ${state.currentLocation.lng.toFixed(6)}`;

            addModal.classList.add('active');
            document.getElementById('clientName').focus();
        });

        cancelBtn.addEventListener('click', () => {
            addModal.classList.remove('active');
            clientForm.reset();
        });

        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                addModal.classList.remove('active');
                clientForm.reset();
            }
        });

        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddress').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            const client = await addClient(name, address, state.currentLocation.lat, state.currentLocation.lng);

            if (!client) return; // Error already shown

            addModal.classList.remove('active');
            clientForm.reset();

            // Show success feedback
            showToast(`Cliente "${name}" adicionado com sucesso!`, 'success');
            const originalText = addClientBtn.textContent;
            addClientBtn.textContent = '‚úì';
            addClientBtn.style.background = '#10b981';
            setTimeout(() => {
                addClientBtn.textContent = originalText;
                addClientBtn.style.background = '';
            }, 1500);
        });

        // Edit Client Modal Controls
        const editModal = document.getElementById('editClientModal');
        const editCancelBtn = document.getElementById('editCancelBtn');
        const editClientForm = document.getElementById('editClientForm');

        editCancelBtn.addEventListener('click', () => {
            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.remove('active');
                editClientForm.reset();
                state.editingClientId = null;
            }
        });

        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('editClientName').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();

            if (!name || !address) {
                showToast('Por favor, preencha todos os campos.', 'warning');
                return;
            }

            if (state.editingClientId) {
                await updateClient(state.editingClientId, name, address);
                showToast(`Cliente "${name}" atualizado com sucesso!`, 'success');
            }

            editModal.classList.remove('active');
            editClientForm.reset();
            state.editingClientId = null;
        });

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            updateClientsList();

            // Show/hide clear button
            if (state.searchQuery) {
                clearSearchBtn.classList.add('visible');
            } else {
                clearSearchBtn.classList.remove('visible');
            }
        });

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            state.searchQuery = '';
            clearSearchBtn.classList.remove('visible');
            updateClientsList();
            searchInput.focus();
        });

        // Mobile Menu Toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking on map (mobile)
        document.getElementById('map').addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
        });

        // Initialize App
        getCurrentLocation();
    </script>
</body>
</html>
